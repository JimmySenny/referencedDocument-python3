
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_CN">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>1. ä½¿ç”¨ C æˆ– C++ æ‰©å±• Python &#8212; Python 3.7.3 æ–‡æ¡£</title>
    <link rel="stylesheet" href="pydoctheme.css" tppabs="https://docs.python.org/zh-cn/3/_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="pygments.css" tppabs="https://docs.python.org/zh-cn/3/_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="documentation_options.js" tppabs="https://docs.python.org/zh-cn/3/_static/documentation_options.js"></script>
    <script type="text/javascript" src="jquery.js" tppabs="https://docs.python.org/zh-cn/3/_static/jquery.js"></script>
    <script type="text/javascript" src="underscore.js" tppabs="https://docs.python.org/zh-cn/3/_static/underscore.js"></script>
    <script type="text/javascript" src="doctools.js" tppabs="https://docs.python.org/zh-cn/3/_static/doctools.js"></script>
    <script type="text/javascript" src="language_data.js" tppabs="https://docs.python.org/zh-cn/3/_static/language_data.js"></script>
    <script type="text/javascript" src="translations.js" tppabs="https://docs.python.org/zh-cn/3/_static/translations.js"></script>
    
    <script type="text/javascript" src="sidebar.js" tppabs="https://docs.python.org/zh-cn/3/_static/sidebar.js"></script>
    
    <link rel="search" type="application/opensearchdescription+xml"
          title="åœ¨ Python 3.7.3 æ–‡æ¡£ ä¸­æœç´¢"
          href="../_static/opensearch.xml"/>
    <link rel="author" title="å…³äºè¿™äº›æ–‡æ¡£" href="../about.html" />
    <link rel="index" title="ç´¢å¼•" href="../genindex.html" />
    <link rel="search" title="æœç´¢" href="../search.html" />
    <link rel="copyright" title="ç‰ˆæƒæ‰€æœ‰" href="../copyright.html" />
    <link rel="next" title="2. è‡ªå®šä¹‰æ‰©å±•ç±»å‹ï¼šæ•™ç¨‹" href="newtypes_tutorial.html" />
    <link rel="prev" title="æ‰©å±•å’ŒåµŒå…¥ Python è§£é‡Šå™¨" href="index.html" />
    <link rel="shortcut icon" type="image/png" href="../_static/py.png" />
    <link rel="canonical" href="https://docs.python.org/3/extending/extending.html" />
    
    <script type="text/javascript" src="copybutton.js" tppabs="https://docs.python.org/zh-cn/3/_static/copybutton.js"></script>
    <script type="text/javascript" src="switchers.js" tppabs="https://docs.python.org/zh-cn/3/_static/switchers.js"></script>
    
    
    
    <style>
      @media only screen {
        table.full-width-table {
            width: 100%;
        }
      }
    </style>
 

  </head><body>  
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>å¯¼èˆª</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" tppabs="https://docs.python.org/zh-cn/3/genindex.html" title="æ€»ç›®å½•"
             accesskey="I">ç´¢å¼•</a></li>
        <li class="right" >
          <a href="py-modindex.html" tppabs="https://docs.python.org/zh-cn/3/py-modindex.html" title="Python æ¨¡å—ç´¢å¼•"
             >æ¨¡å—</a> |</li>
        <li class="right" >
          <a href="newtypes_tutorial.html" tppabs="https://docs.python.org/zh-cn/3/extending/newtypes_tutorial.html" title="2. è‡ªå®šä¹‰æ‰©å±•ç±»å‹ï¼šæ•™ç¨‹"
             accesskey="N">ä¸‹ä¸€é¡µ</a> |</li>
        <li class="right" >
          <a href="index-8.html" tppabs="https://docs.python.org/zh-cn/3/extending/index.html" title="æ‰©å±•å’ŒåµŒå…¥ Python è§£é‡Šå™¨"
             accesskey="P">ä¸Šä¸€é¡µ</a> |</li>
        <li><img src="py.png" tppabs="https://docs.python.org/zh-cn/3/_static/py.png" alt=""
                 style="vertical-align: middle; margin-top: -1px"/></li>
        <li><a href="javascript:if(confirm('https://www.python.org/  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://www.python.org/'" tppabs="https://www.python.org/">Python</a> &#187;</li>
        <li>
          <span class="language_switcher_placeholder">zh_CN</span>
          <span class="version_switcher_placeholder">3.7.3</span>
          <a href="index-11.html" tppabs="https://docs.python.org/zh-cn/3/index.html">æ–‡æ¡£</a> &#187;
        </li>

          <li class="nav-item nav-item-1"><a href="index-8.html" tppabs="https://docs.python.org/zh-cn/3/extending/index.html" accesskey="U">æ‰©å±•å’ŒåµŒå…¥ Python è§£é‡Šå™¨</a> &#187;</li>
    <li class="right">
        

    <div class="inline-search" style="display: none" role="search">
        <form class="inline-search" action="https://docs.python.org/zh-cn/3/search.html" method="get">
          <input placeholder="å¿«é€Ÿæœç´¢" type="text" name="q" />
          <input type="submit" value="è½¬å‘" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </form>
    </div>
    <script type="text/javascript">$('.inline-search').show(0);</script>
         |
    </li>

      </ul>
    </div>    

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="extending-python-with-c-or-c">
<span id="extending-intro"></span><h1>1. ä½¿ç”¨ C æˆ– C++ æ‰©å±• Python<a class="headerlink" href="#extending-python-with-c-or-c" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h1>
<p>å¦‚æœä½ ä¼šç”¨ Cï¼Œæ·»åŠ æ–°çš„ Python å†…ç½®æ¨¡å—ä¼šå¾ˆç®€å•ã€‚ä»¥ä¸‹ä¸¤ä»¶ä¸èƒ½ç”¨ Python ç›´æ¥åšçš„äº‹ï¼Œå¯ä»¥é€šè¿‡ <em class="dfn">extension modules</em> æ¥å®ç°ï¼šå®ç°æ–°çš„å†…ç½®å¯¹è±¡ç±»å‹ï¼›è°ƒç”¨ C çš„åº“å‡½æ•°å’Œç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p>ä¸ºäº†æ”¯æŒæ‰©å±•ï¼ŒPython APIï¼ˆåº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼‰å®šä¹‰äº†ä¸€ç³»åˆ—å‡½æ•°ã€å®å’Œå˜é‡ï¼Œå¯ä»¥è®¿é—® Python è¿è¡Œæ—¶ç³»ç»Ÿçš„å¤§éƒ¨åˆ†å†…å®¹ã€‚Python çš„ API å¯ä»¥é€šè¿‡åœ¨ä¸€ä¸ª C æºæ–‡ä»¶ä¸­å¼•ç”¨ <code class="docutils literal notranslate"><span class="pre">&quot;Python.h&quot;</span></code> å¤´æ–‡ä»¶æ¥ä½¿ç”¨ã€‚</p>
<p>æ‰©å±•æ¨¡å—çš„ç¼–å†™æ–¹å¼å–å†³ä¸ä½ çš„ç›®çš„ä»¥åŠç³»ç»Ÿè®¾ç½®ï¼›ä¸‹é¢ç« èŠ‚ä¼šè¯¦ç»†ä»‹ç»ã€‚</p>
<div class="admonition note">
<p class="first admonition-title">æ³¨è§£</p>
<p class="last">The C extension interface is specific to CPython, and extension modules do
not work on other Python implementations.  In many cases, it is possible to
avoid writing C extensions and preserve portability to other implementations.
For example, if your use case is calling C library functions or system calls,
you should consider using the <a class="reference internal" href="ctypes.html#module-ctypes" tppabs="https://docs.python.org/zh-cn/3/library/ctypes.html#module-ctypes" title="ctypes: A foreign function library for Python."><code class="xref py py-mod docutils literal notranslate"><span class="pre">ctypes</span></code></a> module or the <a class="reference external" href="javascript:if(confirm('https://cffi.readthedocs.io/  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://cffi.readthedocs.io/'" tppabs="https://cffi.readthedocs.io/">cffi</a> library rather than writing
custom C code.
These modules let you write Python code to interface with C code and are more
portable between implementations of Python than writing and compiling a C
extension module.</p>
</div>
<div class="section" id="a-simple-example">
<span id="extending-simpleexample"></span><h2>1.1. ä¸€ä¸ªç®€å•çš„ä¾‹å­<a class="headerlink" href="#a-simple-example" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ‰©å±•æ¨¡å— <code class="docutils literal notranslate"><span class="pre">spam</span></code> (Monty Python ç²‰ä¸æœ€å–œæ¬¢çš„é£Ÿç‰©...) å¹¶ä¸”æƒ³è¦åˆ›å»ºå¯¹åº” C åº“å‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">system()</span></code> <a class="footnote-reference" href="#id5" id="id1">[1]</a> çš„ Python æ¥å£ã€‚ è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªä»¥ null ç»“å°¾çš„å­—ç¬¦ä¸²å‚æ•°å¹¶è¿”å›ä¸€ä¸ªæ•´æ•°ã€‚ æˆ‘ä»¬å¸Œæœ›å¯ä»¥åœ¨ Python ä¸­ä»¥å¦‚ä¸‹æ–¹å¼è°ƒç”¨æ­¤å‡½æ•°:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">spam</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">status</span> <span class="o">=</span> <span class="n">spam</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ls -l&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª <code class="file docutils literal notranslate"><span class="pre">spammodule.c</span></code> æ–‡ä»¶ã€‚ï¼ˆä¼ ç»Ÿä¸Šï¼Œå¦‚æœä¸€ä¸ªæ¨¡å—å« <code class="docutils literal notranslate"><span class="pre">spam</span></code>ï¼Œåˆ™å¯¹åº”å®ç°å®ƒçš„ C æ–‡ä»¶å« <code class="file docutils literal notranslate"><span class="pre">spammodule.c</span></code>ï¼›å¦‚æœè¿™ä¸ªæ¨¡å—åå­—éå¸¸é•¿ï¼Œæ¯”å¦‚ <code class="docutils literal notranslate"><span class="pre">spammify</span></code>ï¼Œåˆ™è¿™ä¸ªæ¨¡å—çš„æ–‡ä»¶å¯ä»¥ç›´æ¥å« <code class="file docutils literal notranslate"><span class="pre">spammify.c</span></code>ã€‚ï¼‰</p>
<p>The first two lines of our file can be:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<p>è¿™ä¼šå¯¼å…¥ Python APIï¼ˆå¦‚æœä½ å–œæ¬¢ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æè¿°æ¨¡å—ç›®æ ‡å’Œç‰ˆæƒä¿¡æ¯çš„æ³¨é‡Š)ã€‚</p>
<div class="admonition note">
<p class="first admonition-title">æ³¨è§£</p>
<p>ç”±äºPythonå¯èƒ½ä¼šå®šä¹‰ä¸€äº›å½±å“æŸäº›ç³»ç»Ÿä¸Šæ ‡å‡†å¤´æ–‡ä»¶çš„é¢„å¤„ç†å™¨å®šä¹‰ï¼Œå› æ­¤åœ¨åŒ…å«ä»»ä½•æ ‡å‡†å¤´æ–‡ä»¶ä¹‹å‰ï¼Œæ‚¨*å¿…é¡»* include è¿™ä¸ªæ–‡ä»¶ï¼š<cite>Python.h</cite>ã€‚</p>
<p class="last">It is recommended to always define <code class="docutils literal notranslate"><span class="pre">PY_SSIZE_T_CLEAN</span></code> before including
<code class="docutils literal notranslate"><span class="pre">Python.h</span></code>.  See <a class="reference internal" href="#parsetuple"><span class="std std-ref">æå–æ‰©å±•å‡½æ•°çš„å‚æ•°</span></a> for a description of this macro.</p>
</div>
<p>æ‰€æœ‰ç”¨æˆ·å¯è§çš„ç¬¦å·éƒ½å®šä¹‰è‡ª <code class="file docutils literal notranslate"><span class="pre">Python.h</span></code> ä¸­ï¼Œå¹¶æ‹¥æœ‰å‰ç¼€ <code class="docutils literal notranslate"><span class="pre">Py</span></code> æˆ– <code class="docutils literal notranslate"><span class="pre">PY</span></code> ï¼Œé™¤äº†é‚£äº›å·²ç»å®šä¹‰åœ¨æ ‡å‡†å¤´æ–‡ä»¶çš„ã€‚ ä¸ºäº†æ–¹ä¾¿ï¼Œä»¥åŠç”±äºå…¶åœ¨ Python è§£é‡Šå™¨ä¸­å¹¿æ³›åº”ç”¨ï¼Œ<code class="docutils literal notranslate"><span class="pre">&quot;Python.h&quot;</span></code> ä¹ŸåŒ…å«äº†å°‘é‡æ ‡å‡†å¤´æ–‡ä»¶: <code class="docutils literal notranslate"><span class="pre">&lt;stdio.h&gt;</span></code>ï¼Œ<code class="docutils literal notranslate"><span class="pre">&lt;string.h&gt;</span></code>ï¼Œ<code class="docutils literal notranslate"><span class="pre">&lt;errno.h&gt;</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">&lt;stdlib.h&gt;</span></code>ã€‚ å¦‚æœåé¢çš„å¤´æ–‡ä»¶åœ¨ä½ çš„ç³»ç»Ÿä¸Šä¸å­˜åœ¨ï¼Œè¿˜ä¼šç›´æ¥å£°æ˜å‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code>ï¼Œ<code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> å’Œ <code class="xref c c-func docutils literal notranslate"><span class="pre">realloc()</span></code> ã€‚</p>
<p>ä¸‹é¢è¦åšçš„äº‹æ˜¯å°† C å‡½æ•°æ·»åŠ åˆ°æˆ‘ä»¬çš„æ‰©å±•æ¨¡å—ï¼Œå½“ Python è¡¨è¾¾å¼ <code class="docutils literal notranslate"><span class="pre">spam.system(string)</span></code> è¢«æ±‚å€¼æ—¶å‡½æ•°å°†è¢«è°ƒç”¨ï¼ˆæˆ‘ä»¬å¾ˆå¿«å°±ä¼šçœ‹åˆ°å®ƒæœ€ç»ˆæ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼‰:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">spam_system</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sts</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">sts</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="n">sts</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>æœ‰ä¸ªç›´æ¥ç¿»è¯‘å‚æ•°åˆ—è¡¨çš„æ–¹æ³•(ä¾‹å¦‚å•ç‹¬çš„ <code class="docutils literal notranslate"><span class="pre">â€œls-l&quot;</span></code>)åˆ°è¦ä¼ é€’ç»™Cå‡½æ•°çš„å‚æ•°ã€‚Cå‡½æ•°æ€»æ˜¯æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œé€šå¸¸åå­—æ˜¯ <em>self</em> å’Œ <em>args</em> ã€‚</p>
<p>The <em>self</em> argument points to the module object for module-level functions;
for a method it would point to the object instance.</p>
<p><em>args</em> å‚æ•°æ˜¯æŒ‡å‘ä¸€ä¸ª Python çš„ tuple å¯¹è±¡çš„æŒ‡é’ˆï¼Œå…¶ä¸­åŒ…å«å‚æ•°ã€‚ æ¯ä¸ª tuple é¡¹å¯¹åº”ä¸€ä¸ªè°ƒç”¨å‚æ•°ã€‚ è¿™äº›å‚æ•°ä¹Ÿå…¨éƒ½æ˜¯ Python å¯¹è±¡ --- è¦åœ¨æˆ‘ä»¬çš„ C å‡½æ•°ä¸­ä½¿ç”¨å®ƒä»¬å°±éœ€è¦å…ˆå°†å…¶è½¬æ¢ä¸º C å€¼ã€‚ Python API ä¸­çš„å‡½æ•° <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> ä¼šæ£€æŸ¥å‚æ•°ç±»å‹å¹¶å°†å…¶è½¬æ¢ä¸º C å€¼ã€‚ å®ƒä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²ç¡®å®šéœ€è¦çš„å‚æ•°ç±»å‹ä»¥åŠå­˜å‚¨è¢«è½¬æ¢çš„å€¼çš„ C å˜é‡ç±»å‹ã€‚ ç»†èŠ‚å°†ç¨åè¯´æ˜ã€‚</p>
<p><a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> æ­£å¸¸è¿”å›éé›¶ï¼Œå¹¶å·²ç»æŒ‰ç…§æä¾›çš„åœ°å€å­˜å…¥äº†å„ä¸ªå˜é‡å€¼ã€‚å¦‚æœå‡ºé”™(é›¶)åˆ™åº”è¯¥è®©å‡½æ•°è¿”å›NULLä»¥é€šçŸ¥è§£é‡Šå™¨å‡ºé”™(æœ‰å¦‚ä¾‹å­ä¸­çœ‹åˆ°çš„)ã€‚</p>
</div>
<div class="section" id="intermezzo-errors-and-exceptions">
<span id="extending-errors"></span><h2>1.2. å…³äºé”™è¯¯å’Œå¼‚å¸¸<a class="headerlink" href="#intermezzo-errors-and-exceptions" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>An important convention throughout the Python interpreter is the following: when
a function fails, it should set an exception condition and return an error value
(usually a <em>NULL</em> pointer).  Exceptions are stored in a static global variable
inside the interpreter; if this variable is <em>NULL</em> no exception has occurred.  A
second global variable stores the &quot;associated value&quot; of the exception (the
second argument to <a class="reference internal" href="simple_stmts.html#raise" tppabs="https://docs.python.org/zh-cn/3/reference/simple_stmts.html#raise"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">raise</span></code></a>).  A third variable contains the stack
traceback in case the error originated in Python code.  These three variables
are the C equivalents of the result in Python of <a class="reference internal" href="sys.html#sys.exc_info" tppabs="https://docs.python.org/zh-cn/3/library/sys.html#sys.exc_info" title="sys.exc_info"><code class="xref py py-meth docutils literal notranslate"><span class="pre">sys.exc_info()</span></code></a> (see the
section on module <a class="reference internal" href="sys.html#module-sys" tppabs="https://docs.python.org/zh-cn/3/library/sys.html#module-sys" title="sys: Access system-specific parameters and functions."><code class="xref py py-mod docutils literal notranslate"><span class="pre">sys</span></code></a> in the Python Library Reference).  It is important
to know about them to understand how errors are passed around.</p>
<p>Python APIä¸­å®šä¹‰äº†ä¸€äº›å‡½æ•°æ¥è®¾ç½®è¿™äº›å˜é‡ã€‚</p>
<p>æœ€å¸¸ç”¨çš„å°±æ˜¯ <a class="reference internal" href="exceptions-1.html#c.PyErr_SetString" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_SetString" title="PyErr_SetString"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_SetString()</span></code></a>ã€‚ å…¶å‚æ•°æ˜¯å¼‚å¸¸å¯¹è±¡å’Œ C å­—ç¬¦ä¸²ã€‚ å¼‚å¸¸å¯¹è±¡ä¸€èˆ¬æ˜¯åƒ <code class="xref c c-data docutils literal notranslate"><span class="pre">PyExc_ZeroDivisionError</span></code> è¿™æ ·çš„é¢„å®šä¹‰å¯¹è±¡ã€‚ C å­—ç¬¦ä¸²æŒ‡æ˜å¼‚å¸¸åŸå› ï¼Œå¹¶è¢«è½¬æ¢ä¸ºä¸€ä¸ª Python å­—ç¬¦ä¸²å¯¹è±¡å­˜å‚¨ä¸ºå¼‚å¸¸çš„â€œå…³è”å€¼â€ã€‚</p>
<p>å¦ä¸€ä¸ªæœ‰ç”¨çš„å‡½æ•°æ˜¯ <a class="reference internal" href="exceptions-1.html#c.PyErr_SetFromErrno" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_SetFromErrno" title="PyErr_SetFromErrno"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_SetFromErrno()</span></code></a> ï¼Œä»…æ¥å—ä¸€ä¸ªå¼‚å¸¸å¯¹è±¡ï¼Œå¼‚å¸¸æè¿°åŒ…å«åœ¨å…¨å±€å˜é‡ <code class="xref c c-data docutils literal notranslate"><span class="pre">errno</span></code> ä¸­ã€‚æœ€é€šç”¨çš„å‡½æ•°è¿˜æ˜¯ <a class="reference internal" href="exceptions-1.html#c.PyErr_SetObject" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_SetObject" title="PyErr_SetObject"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_SetObject()</span></code></a> ï¼ŒåŒ…å«ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸ºå¼‚å¸¸å¯¹è±¡å’Œå¼‚å¸¸æè¿°ã€‚ä½ ä¸éœ€è¦ä½¿ç”¨ <a class="reference internal" href="refcounting.html#c.Py_INCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_INCREF" title="Py_INCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_INCREF()</span></code></a> æ¥å¢åŠ ä¼ é€’åˆ°å…¶ä»–å‡½æ•°çš„å‚æ•°å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚</p>
<p>ä½ å¯ä»¥é€šè¿‡ <a class="reference internal" href="exceptions-1.html#c.PyErr_Occurred" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_Occurred" title="PyErr_Occurred"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_Occurred()</span></code></a> è·çŸ¥å½“å‰å¼‚å¸¸ï¼Œè¿”å›å½“å‰å¼‚å¸¸å¯¹è±¡ï¼Œå¦‚æœç¡®å®æ²¡æœ‰åˆ™ä¸º <em>NULL</em> ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä½ åœ¨è°ƒç”¨å‡½æ•°æ—¶ä¸éœ€è¦è°ƒç”¨ <a class="reference internal" href="exceptions-1.html#c.PyErr_Occurred" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_Occurred" title="PyErr_Occurred"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_Occurred()</span></code></a> æ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†å¼‚å¸¸ï¼Œä½ å¯ä»¥ç›´æ¥æ£€æŸ¥è¿”å›å€¼ã€‚</p>
<p>å½“å‡½æ•° <em>f</em> è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•° <em>g</em> æ—¶æ£€æµ‹åˆ°åè€…å‡ºé”™äº†ï¼Œ<em>f</em> è‡ªèº«å°†è¿”å›ä¸€ä¸ªé”™è¯¯å€¼ (é€šå¸¸ä¸º <em>NULL</em> æˆ– <code class="docutils literal notranslate"><span class="pre">-1</span></code>)ã€‚ å®ƒ <em>ä¸åº”</em> è°ƒç”¨æŸä¸ª <code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_*()</span></code> å‡½æ•° --- è¿™ç§å‡½æ•°å·²ç»ç”± <em>g</em> è°ƒç”¨è¿‡äº†ã€‚ ç„¶å <em>f</em> çš„è°ƒç”¨è€…ä¹Ÿåº”è¯¥è¿”å›ä¸€ä¸ªé”™è¯¯æç¤º <em>å®ƒçš„</em> è°ƒç”¨è€…ï¼ŒåŒæ · <em>ä¸åº”</em> è°ƒç”¨ <code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_*()</span></code>ï¼Œä¾æ­¤ç±»æ¨ --- é”™è¯¯çš„æœ€è¯¦ç»†åŸå› å·²ç»ç”±é¦–å…ˆæ£€æµ‹åˆ°å®ƒçš„å‡½æ•°æŠ¥å‘Šäº†ã€‚ ä¸€æ—¦è¿™ä¸ªé”™è¯¯åˆ°è¾¾äº† Python è§£é‡Šå™¨çš„ä¸»å¾ªç¯ï¼Œå®ƒå°†ä¸­æ–­å½“å‰æ‰§è¡Œçš„ Python ä»£ç å¹¶å°è¯•æ‰¾åˆ°ç”± Python ç¨‹åºç¼–å†™è€…æ‰€æŒ‡å®šçš„å¼‚å¸¸å¥æŸ„ã€‚</p>
<p>ï¼ˆåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå½“æ¨¡å—ç¡®å®èƒ½å¤Ÿé€šè¿‡è°ƒç”¨å…¶å®ƒ <code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_*()</span></code> å‡½æ•°ç»™å‡ºæ›´åŠ è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯ï¼Œå¹¶ä¸”åœ¨è¿™äº›æƒ…å†µæ˜¯å¯ä»¥è¿™æ ·åšçš„ã€‚ ä½†æ˜¯æŒ‰ç…§ä¸€èˆ¬è§„åˆ™ï¼Œè¿™æ˜¯ä¸å¿…è¦çš„ï¼Œå¹¶å¯èƒ½å¯¼è‡´æœ‰å…³é”™è¯¯åŸå› çš„ä¿¡æ¯ä¸¢å¤±ï¼šå¤§å¤šæ•°æ“ä½œä¼šç”±äºç§ç§åŸå› è€Œå¤±è´¥ã€‚ï¼‰</p>
<p>æƒ³è¦å¿½ç•¥ç”±ä¸€ä¸ªå¤±è´¥çš„å‡½æ•°è°ƒç”¨æ‰€è®¾ç½®çš„å¼‚å¸¸ï¼Œå¼‚å¸¸æ¡ä»¶å¿…é¡»é€šè¿‡è°ƒç”¨ <a class="reference internal" href="exceptions-1.html#c.PyErr_Clear" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_Clear" title="PyErr_Clear"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_Clear()</span></code></a> æ˜¾å¼åœ°è¢«æ¸…é™¤ã€‚ C ä»£ç åº”å½“è°ƒç”¨ <a class="reference internal" href="exceptions-1.html#c.PyErr_Clear" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_Clear" title="PyErr_Clear"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_Clear()</span></code></a> çš„å”¯ä¸€æƒ…å†µæ˜¯å¦‚æœå®ƒä¸æƒ³å°†é”™è¯¯ä¼ ç»™è§£é‡Šå™¨è€Œæ˜¯æƒ³å®Œå…¨ç”±è‡ªå·±æ¥å¤„ç†å®ƒï¼ˆå¯èƒ½æ˜¯å°è¯•å…¶ä»–æ–¹æ³•ï¼Œæˆ–æ˜¯å‡è£…æ²¡æœ‰å‡ºé”™ï¼‰ã€‚</p>
<p>Every failing <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> call must be turned into an exception --- the
direct caller of <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> (or <code class="xref c c-func docutils literal notranslate"><span class="pre">realloc()</span></code>) must call
<a class="reference internal" href="exceptions-1.html#c.PyErr_NoMemory" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_NoMemory" title="PyErr_NoMemory"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_NoMemory()</span></code></a> and return a failure indicator itself.  All the
object-creating functions (for example, <a class="reference internal" href="long.html#c.PyLong_FromLong" tppabs="https://docs.python.org/zh-cn/3/c-api/long.html#c.PyLong_FromLong" title="PyLong_FromLong"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyLong_FromLong()</span></code></a>) already do
this, so this note is only relevant to those who call <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> directly.</p>
<p>è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œé™¤äº† <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> ç­‰é‡è¦çš„ä¾‹å¤–ï¼Œè¿”å›æ•´æ•°çŠ¶æ€ç çš„å‡½æ•°é€šå¸¸éƒ½æ˜¯è¿”å›æ­£å€¼æˆ–é›¶æ¥è¡¨ç¤ºæˆåŠŸï¼Œè€Œä»¥ <code class="docutils literal notranslate"><span class="pre">-1</span></code> è¡¨ç¤ºå¤±è´¥ï¼Œå¦‚åŒ Unix ç³»ç»Ÿè°ƒç”¨ä¸€æ ·ã€‚</p>
<p>æœ€åï¼Œå½“ä½ è¿”å›ä¸€ä¸ªé”™è¯¯æŒ‡ç¤ºå™¨æ—¶è¦æ³¨æ„æ¸…ç†åƒåœ¾ï¼ˆé€šè¿‡ä¸ºä½ å·²ç»åˆ›å»ºçš„å¯¹è±¡æ‰§è¡Œ <a class="reference internal" href="refcounting.html#c.Py_XDECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_XDECREF" title="Py_XDECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_XDECREF()</span></code></a> æˆ– <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a> è°ƒç”¨ï¼‰ï¼</p>
<p>é€‰æ‹©å¼•å‘å“ªä¸ªå¼‚å¸¸å®Œå…¨å–å†³äºä½ çš„å–œå¥½ã€‚ æ‰€æœ‰å†…ç½®çš„ Python å¼‚å¸¸éƒ½æœ‰å¯¹åº”çš„é¢„å£°æ˜ C å¯¹è±¡ï¼Œä¾‹å¦‚ <code class="xref c c-data docutils literal notranslate"><span class="pre">PyExc_ZeroDivisionError</span></code>ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒä»¬ã€‚ å½“ç„¶ï¼Œä½ åº”å½“æ˜æ™ºåœ°é€‰æ‹©å¼‚å¸¸ --- ä¸è¦ä½¿ç”¨ <code class="xref c c-data docutils literal notranslate"><span class="pre">PyExc_TypeError</span></code> æ¥è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶æ— æ³•è¢«æ‰“å¼€ (é‚£å¤§æ¦‚åº”è¯¥ç”¨ <code class="xref c c-data docutils literal notranslate"><span class="pre">PyExc_IOError</span></code>)ã€‚ å¦‚æœå‚æ•°åˆ—è¡¨æœ‰é—®é¢˜ï¼Œ<a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> å‡½æ•°é€šå¸¸ä¼šå¼•å‘ <code class="xref c c-data docutils literal notranslate"><span class="pre">PyExc_TypeError</span></code>ã€‚ å¦‚æœä½ æƒ³è¦ä¸€ä¸ªå‚æ•°çš„å€¼å¿…é¡»å¤„äºç‰¹å®šèŒƒå›´ä¹‹å†…æˆ–å¿…é¡»æ»¡è¶³å…¶ä»–æ¡ä»¶ï¼Œåˆ™é€‚å®œä½¿ç”¨ <code class="xref c c-data docutils literal notranslate"><span class="pre">PyExc_ValueError</span></code>ã€‚</p>
<p>ä½ ä¹Ÿå¯ä»¥ä¸ºä½ çš„æ¨¡å—å®šä¹‰ä¸€ä¸ªå”¯ä¸€çš„æ–°å¼‚å¸¸ã€‚éœ€è¦åœ¨æ–‡ä»¶å‰éƒ¨å£°æ˜ä¸€ä¸ªé™æ€å¯¹è±¡å˜é‡ï¼Œå¦‚:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">SpamError</span><span class="p">;</span>
</pre></div>
</div>
<p>and initialize it in your module's initialization function (<code class="xref c c-func docutils literal notranslate"><span class="pre">PyInit_spam()</span></code>)
with an exception object (leaving out the error checking for now):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_spam</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spammodule</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">SpamError</span> <span class="o">=</span> <span class="n">PyErr_NewException</span><span class="p">(</span><span class="s">&quot;spam.error&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">SpamError</span><span class="p">);</span>
    <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">SpamError</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>æ³¨æ„å®é™…çš„Pythonå¼‚å¸¸åå­—æ˜¯ <code class="xref py py-exc docutils literal notranslate"><span class="pre">spam.error</span></code> ã€‚ <a class="reference internal" href="exceptions-1.html#c.PyErr_NewException" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_NewException" title="PyErr_NewException"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_NewException()</span></code></a> å‡½æ•°ä½¿ç”¨ <a class="reference internal" href="exceptions.html#Exception" tppabs="https://docs.python.org/zh-cn/3/library/exceptions.html#Exception" title="Exception"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Exception</span></code></a> ä¸ºåŸºç±»åˆ›å»ºä¸€ä¸ªç±»(é™¤éæ˜¯ä½¿ç”¨å¦å¤–ä¸€ä¸ªç±»æ›¿ä»£ <em>NULL</em> )ã€‚æè¿°å‚è€ƒ <a class="reference internal" href="exceptions.html#bltin-exceptions" tppabs="https://docs.python.org/zh-cn/3/library/exceptions.html#bltin-exceptions"><span class="std std-ref">å†…ç½®å¼‚å¸¸</span></a> ã€‚</p>
<p>åŒæ ·æ³¨æ„çš„æ˜¯åˆ›å»ºç±»ä¿å­˜äº† <code class="xref c c-data docutils literal notranslate"><span class="pre">SpamError</span></code> çš„ä¸€ä¸ªå¼•ç”¨ï¼Œè¿™æ˜¯æœ‰æ„çš„ã€‚ä¸ºäº†é˜²æ­¢è¢«åƒåœ¾å›æ”¶æ‰ï¼Œå¦åˆ™ <code class="xref c c-data docutils literal notranslate"><span class="pre">SpamError</span></code> éšæ—¶ä¼šæˆä¸ºé‡æŒ‡é’ˆã€‚</p>
<p>ä¸€ä¼šè®¨è®º <code class="docutils literal notranslate"><span class="pre">PyMODINIT_FUNC</span></code> ä½œä¸ºå‡½æ•°è¿”å›ç±»å‹çš„ç”¨æ³•ã€‚</p>
<p><code class="xref py py-exc docutils literal notranslate"><span class="pre">spam.error</span></code> å¼‚å¸¸å¯ä»¥åœ¨æ‰©å±•æ¨¡å—ä¸­æŠ›å‡ºï¼Œé€šè¿‡ <a class="reference internal" href="exceptions-1.html#c.PyErr_SetString" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_SetString" title="PyErr_SetString"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_SetString()</span></code></a> å‡½æ•°è°ƒç”¨ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">spam_system</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sts</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">sts</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">SpamError</span><span class="p">,</span> <span class="s">&quot;System command failed&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="n">sts</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="back-to-the-example">
<span id="backtoexample"></span><h2>1.3. å›åˆ°ä¾‹å­<a class="headerlink" href="#back-to-the-example" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>å›åˆ°å‰é¢çš„ä¾‹å­ï¼Œä½ åº”è¯¥æ˜ç™½ä¸‹é¢çš„ä»£ç :</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</pre></div>
</div>
<p>å¦‚æœåœ¨å‚æ•°åˆ—è¡¨ä¸­æ£€æµ‹åˆ°é”™è¯¯ï¼Œå°†ä¼šè¿”å› <em>NULL</em> (è¿”å›å¯¹è±¡æŒ‡é’ˆçš„å‡½æ•°çš„é”™è¯¯æŒ‡ç¤ºå™¨) ï¼Œ ä¾æ® <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> æ‰€è®¾ç½®çš„å¼‚å¸¸ã€‚ åœ¨å…¶ä»–æƒ…å†µä¸‹å‚æ•°çš„å­—ç¬¦ä¸²å€¼ä¼šè¢«æ‹·è´åˆ°å±€éƒ¨å˜é‡ <code class="xref c c-data docutils literal notranslate"><span class="pre">command</span></code>ã€‚ è¿™æ˜¯ä¸€ä¸ªæŒ‡é’ˆèµ‹å€¼ï¼Œä½ ä¸åº”è¯¥ä¿®æ”¹å®ƒæ‰€æŒ‡å‘çš„å­—ç¬¦ä¸² (æ‰€ä»¥åœ¨æ ‡å‡† C ä¸­ï¼Œå˜é‡ <code class="xref c c-data docutils literal notranslate"><span class="pre">command</span></code> åº”å½“è¢«æ­£ç¡®åœ°å£°æ˜ä¸º <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*command</span></code>)ã€‚</p>
<p>ä¸‹ä¸€ä¸ªè¯­å¥ä½¿ç”¨UNIXç³»ç»Ÿå‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">system()</span></code> ï¼Œä¼ é€’ç»™ä»–çš„å‚æ•°æ˜¯åˆšæ‰ä» <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> å–å‡ºçš„:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sts</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
</pre></div>
</div>
<p>Our <code class="xref py py-func docutils literal notranslate"><span class="pre">spam.system()</span></code> function must return the value of <code class="xref c c-data docutils literal notranslate"><span class="pre">sts</span></code> as a
Python object.  This is done using the function <a class="reference internal" href="long.html#c.PyLong_FromLong" tppabs="https://docs.python.org/zh-cn/3/c-api/long.html#c.PyLong_FromLong" title="PyLong_FromLong"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyLong_FromLong()</span></code></a>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="nf">PyLong_FromLong</span><span class="p">(</span><span class="n">sts</span><span class="p">);</span>
</pre></div>
</div>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¼šè¿”å›ä¸€ä¸ªæ•´æ•°å¯¹è±¡ï¼Œ(è¿™ä¸ªå¯¹è±¡ä¼šåœ¨Pythonå †é‡Œé¢ç®¡ç†)ã€‚</p>
<p>å¦‚æœä½ çš„Cå‡½æ•°æ²¡æœ‰æœ‰ç”¨çš„è¿”å›å€¼(è¿”å› <code class="xref c c-type docutils literal notranslate"><span class="pre">void</span></code> çš„å‡½æ•°)ï¼Œåˆ™å¿…é¡»è¿”å› <code class="docutils literal notranslate"><span class="pre">None</span></code> ã€‚(ä½ å¯ä»¥ç”¨  <code class="xref c c-macro docutils literal notranslate"><span class="pre">Py_RETUN_NONE</span></code> å®æ¥å®Œæˆ):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
<span class="k">return</span> <span class="n">Py_None</span><span class="p">;</span>
</pre></div>
</div>
<p><a class="reference internal" href="none.html#c.Py_None" tppabs="https://docs.python.org/zh-cn/3/c-api/none.html#c.Py_None" title="Py_None"><code class="xref c c-data docutils literal notranslate"><span class="pre">Py_None</span></code></a> æ˜¯ä¸€ä¸ªCåå­—æŒ‡å®šPythonå¯¹è±¡ <code class="docutils literal notranslate"><span class="pre">None</span></code> ã€‚è¿™æ˜¯ä¸€ä¸ªçœŸæ­£çš„PYå¯¹è±¡ï¼Œè€Œä¸æ˜¯ <em>NULL</em> æŒ‡é’ˆã€‚</p>
</div>
<div class="section" id="the-module-s-method-table-and-initialization-function">
<span id="methodtable"></span><h2>1.4. æ¨¡å—æ–¹æ³•è¡¨å’Œåˆå§‹åŒ–å‡½æ•°<a class="headerlink" href="#the-module-s-method-table-and-initialization-function" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>ä¸ºäº†å±•ç¤º <code class="xref c c-func docutils literal notranslate"><span class="pre">spam_system()</span></code> å¦‚ä½•è¢«Pythonç¨‹åºè°ƒç”¨ã€‚æŠŠå‡½æ•°å£°æ˜ä¸ºå¯ä»¥è¢«Pythonè°ƒç”¨ï¼Œéœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªæ–¹æ³•è¡¨ &quot;method table&quot; ã€‚</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">SpamMethods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="p">{</span><span class="s">&quot;system&quot;</span><span class="p">,</span>  <span class="n">spam_system</span><span class="p">,</span> <span class="n">METH_VARARGS</span><span class="p">,</span>
     <span class="s">&quot;Execute a shell command.&quot;</span><span class="p">},</span>
    <span class="p">...</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>        <span class="cm">/* Sentinel */</span>
<span class="p">};</span>
</pre></div>
</div>
<p>æ³¨æ„ç¬¬ä¸‰ä¸ªå‚æ•° ( <code class="docutils literal notranslate"><span class="pre">METH_VARARGS</span></code> ) ï¼Œè¿™ä¸ªæ ‡å¿—æŒ‡å®šä¼šä½¿ç”¨Cçš„è°ƒç”¨æƒ¯ä¾‹ã€‚å¯é€‰å€¼æœ‰  <code class="docutils literal notranslate"><span class="pre">METH_VARARGS</span></code> ã€ <code class="docutils literal notranslate"><span class="pre">METH_VARARGS</span> <span class="pre">|</span> <span class="pre">METH_KEYWORDS</span></code> ã€‚å€¼ <code class="docutils literal notranslate"><span class="pre">0</span></code> ä»£è¡¨ä½¿ç”¨ <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> çš„é™ˆæ—§å˜é‡ã€‚</p>
<p>å¦‚æœå•ç‹¬ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">METH_VARARGS</span></code> ï¼Œå‡½æ•°ä¼šç­‰å¾…Pythonä¼ æ¥tupleæ ¼å¼çš„å‚æ•°ï¼Œå¹¶æœ€ç»ˆä½¿ç”¨  <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> è¿›è¡Œè§£æã€‚</p>
<p><a class="reference internal" href="structures.html#METH_KEYWORDS" tppabs="https://docs.python.org/zh-cn/3/c-api/structures.html#METH_KEYWORDS" title="METH_KEYWORDS"><code class="xref py py-const docutils literal notranslate"><span class="pre">METH_KEYWORDS</span></code></a> å€¼è¡¨ç¤ºæ¥å—å…³é”®å­—å‚æ•°ã€‚è¿™ç§æƒ…å†µä¸‹Cå‡½æ•°éœ€è¦æ¥å—ç¬¬ä¸‰ä¸ª <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">*</span></code>  å¯¹è±¡ï¼Œè¡¨ç¤ºå­—å…¸å‚æ•°ï¼Œä½¿ç”¨ <a class="reference internal" href="arg.html#c.PyArg_ParseTupleAndKeywords" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTupleAndKeywords" title="PyArg_ParseTupleAndKeywords"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTupleAndKeywords()</span></code></a> æ¥è§£æå‡ºå‚æ•°ã€‚</p>
<p>The method table must be referenced in the module definition structure:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">spammodule</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span>
    <span class="s">&quot;spam&quot;</span><span class="p">,</span>   <span class="cm">/* name of module */</span>
    <span class="n">spam_doc</span><span class="p">,</span> <span class="cm">/* module documentation, may be NULL */</span>
    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>       <span class="cm">/* size of per-interpreter state of the module,</span>
<span class="cm">                 or -1 if the module keeps state in global variables. */</span>
    <span class="n">SpamMethods</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This structure, in turn, must be passed to the interpreter in the module's
initialization function.  The initialization function must be named
<code class="xref c c-func docutils literal notranslate"><span class="pre">PyInit_name()</span></code>, where <em>name</em> is the name of the module, and should be the
only non-<code class="docutils literal notranslate"><span class="pre">static</span></code> item defined in the module file:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_spam</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spammodule</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that PyMODINIT_FUNC declares the function as <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">*</span></code> return type,
declares any special linkage declarations required by the platform, and for C++
declares the function as <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">&quot;C&quot;</span></code>.</p>
<p>When the Python program imports module <code class="xref py py-mod docutils literal notranslate"><span class="pre">spam</span></code> for the first time,
<code class="xref c c-func docutils literal notranslate"><span class="pre">PyInit_spam()</span></code> is called. (See below for comments about embedding Python.)
It calls <a class="reference internal" href="module.html#c.PyModule_Create" tppabs="https://docs.python.org/zh-cn/3/c-api/module.html#c.PyModule_Create" title="PyModule_Create"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyModule_Create()</span></code></a>, which returns a module object, and
inserts built-in function objects into the newly created module based upon the
table (an array of <a class="reference internal" href="structures.html#c.PyMethodDef" tppabs="https://docs.python.org/zh-cn/3/c-api/structures.html#c.PyMethodDef" title="PyMethodDef"><code class="xref c c-type docutils literal notranslate"><span class="pre">PyMethodDef</span></code></a> structures) found in the module definition.
<a class="reference internal" href="module.html#c.PyModule_Create" tppabs="https://docs.python.org/zh-cn/3/c-api/module.html#c.PyModule_Create" title="PyModule_Create"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyModule_Create()</span></code></a> returns a pointer to the module object
that it creates.  It may abort with a fatal error for
certain errors, or return <em>NULL</em> if the module could not be initialized
satisfactorily. The init function must return the module object to its caller,
so that it then gets inserted into <code class="docutils literal notranslate"><span class="pre">sys.modules</span></code>.</p>
<p>When embedding Python, the <code class="xref c c-func docutils literal notranslate"><span class="pre">PyInit_spam()</span></code> function is not called
automatically unless there's an entry in the <code class="xref c c-data docutils literal notranslate"><span class="pre">PyImport_Inittab</span></code> table.
To add the module to the initialization table, use <a class="reference internal" href="import-1.html#c.PyImport_AppendInittab" tppabs="https://docs.python.org/zh-cn/3/c-api/import.html#c.PyImport_AppendInittab" title="PyImport_AppendInittab"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyImport_AppendInittab()</span></code></a>,
optionally followed by an import of the module:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">program</span> <span class="o">=</span> <span class="n">Py_DecodeLocale</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">program</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Fatal error: cannot decode argv[0]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Add a built-in module, before Py_Initialize */</span>
    <span class="n">PyImport_AppendInittab</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="p">,</span> <span class="n">PyInit_spam</span><span class="p">);</span>

    <span class="cm">/* Pass argv[0] to the Python interpreter */</span>
    <span class="n">Py_SetProgramName</span><span class="p">(</span><span class="n">program</span><span class="p">);</span>

    <span class="cm">/* Initialize the Python interpreter.  Required. */</span>
    <span class="n">Py_Initialize</span><span class="p">();</span>

    <span class="cm">/* Optionally import the module; alternatively,</span>
<span class="cm">       import can be deferred until the embedded script</span>
<span class="cm">       imports it. */</span>
    <span class="n">PyImport_ImportModule</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="p">);</span>

    <span class="p">...</span>

    <span class="n">PyMem_RawFree</span><span class="p">(</span><span class="n">program</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">æ³¨è§£</p>
<p class="last">Removing entries from <code class="docutils literal notranslate"><span class="pre">sys.modules</span></code> or importing compiled modules into
multiple interpreters within a process (or following a <code class="xref c c-func docutils literal notranslate"><span class="pre">fork()</span></code> without an
intervening <code class="xref c c-func docutils literal notranslate"><span class="pre">exec()</span></code>) can create problems for some extension modules.
Extension module authors should exercise caution when initializing internal data
structures.</p>
</div>
<p>æ›´å¤šå…³äºæ¨¡å—çš„ç°å®çš„ä¾‹å­åŒ…å«åœ¨Pythonæºç åŒ…çš„ <code class="file docutils literal notranslate"><span class="pre">Modules/xxmodule.c</span></code> ä¸­ã€‚è¿™äº›æ–‡ä»¶å¯ä»¥ç”¨ä½œä½ çš„ä»£ç æ¨¡æ¿ï¼Œæˆ–è€…å­¦ä¹ ã€‚è„šæœ¬ modulator.py åŒ…å«åœ¨æºç å‘è¡Œç‰ˆæˆ–Windowså®‰è£…ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªç®€å•çš„GUIï¼Œç”¨æ¥å£°æ˜éœ€è¦å®ç°çš„å‡½æ•°å’Œå¯¹è±¡ï¼Œå¹¶ä¸”å¯ä»¥ç”Ÿæˆä¾›å¡«å…¥çš„æ¨¡æ¿ã€‚è„šæœ¬åœ¨ Tools/modulator/ ç›®å½•ã€‚æŸ¥çœ‹READMEä»¥äº†è§£ç”¨æ³•ã€‚</p>
<div class="admonition note">
<p class="first admonition-title">æ³¨è§£</p>
<p class="last">Unlike our <code class="docutils literal notranslate"><span class="pre">spam</span></code> example, <code class="docutils literal notranslate"><span class="pre">xxmodule</span></code> uses <em>multi-phase initialization</em>
(new in Python 3.5), where a PyModuleDef structure is returned from
<code class="docutils literal notranslate"><span class="pre">PyInit_spam</span></code>, and creation of the module is left to the import machinery.
For details on multi-phase initialization, see <span class="target" id="index-0"></span><a class="pep reference external" href="javascript:if(confirm('https://www.python.org/dev/peps/pep-0489  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://www.python.org/dev/peps/pep-0489'" tppabs="https://www.python.org/dev/peps/pep-0489"><strong>PEP 489</strong></a>.</p>
</div>
</div>
<div class="section" id="compilation-and-linkage">
<span id="compilation"></span><h2>1.5. ç¼–è¯‘å’Œé“¾æ¥<a class="headerlink" href="#compilation-and-linkage" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>åœ¨ä½ èƒ½ä½¿ç”¨ä½ çš„æ–°å†™çš„æ‰©å±•ä¹‹å‰ï¼Œä½ è¿˜éœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼šä½¿ç”¨ Python ç³»ç»Ÿæ¥ç¼–è¯‘å’Œé“¾æ¥ã€‚å¦‚æœä½ ä½¿ç”¨åŠ¨æ€åŠ è½½ï¼Œè¿™å–å†³äºä½ ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿçš„åŠ¨æ€åŠ è½½æœºåˆ¶ï¼›æ›´å¤šä¿¡æ¯è¯·å‚è€ƒç¼–è¯‘æ‰©å±•æ¨¡å—çš„ç« èŠ‚ï¼ˆ <a class="reference internal" href="building.html#building" tppabs="https://docs.python.org/zh-cn/3/extending/building.html#building"><span class="std std-ref">Building C and C++ Extensions</span></a> ç« èŠ‚ï¼‰ï¼Œä»¥åŠåœ¨ Windows ä¸Šç¼–è¯‘éœ€è¦çš„é¢å¤–ä¿¡æ¯ï¼ˆ <a class="reference internal" href="windows-2.html#building-on-windows" tppabs="https://docs.python.org/zh-cn/3/extending/windows.html#building-on-windows"><span class="std std-ref">åœ¨Windowså¹³å°ç¼–è¯‘Cå’ŒC++æ‰©å±•</span></a> ç« èŠ‚ï¼‰ã€‚</p>
<p>If you can't use dynamic loading, or if you want to make your module a permanent
part of the Python interpreter, you will have to change the configuration setup
and rebuild the interpreter.  Luckily, this is very simple on Unix: just place
your file (<code class="file docutils literal notranslate"><span class="pre">spammodule.c</span></code> for example) in the <code class="file docutils literal notranslate"><span class="pre">Modules/</span></code> directory
of an unpacked source distribution, add a line to the file
<code class="file docutils literal notranslate"><span class="pre">Modules/Setup.local</span></code> describing your file:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>spam spammodule.o
</pre></div>
</div>
<p>ç„¶ååœ¨é¡¶å±‚ç›®å½•è¿è¡Œ <strong class="program">make</strong> æ¥é‡æ–°æ„å»ºè§£é‡Šå™¨ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨ <code class="file docutils literal notranslate"><span class="pre">Modules/</span></code> å­ç›®å½•ä½¿ç”¨ <strong class="program">make</strong>ï¼Œä½†æ˜¯ä½ å¿…é¡»å…ˆé‡å»º <code class="file docutils literal notranslate"><span class="pre">Makefile</span></code> æ–‡ä»¶ï¼Œç„¶åè¿è¡Œ '<strong class="program">make</strong> Makefile' å‘½ä»¤ã€‚ï¼ˆä½ æ¯æ¬¡ä¿®æ”¹ <code class="file docutils literal notranslate"><span class="pre">Setup</span></code> æ–‡ä»¶éƒ½éœ€è¦è¿™æ ·æ“ä½œã€‚ï¼‰</p>
<p>If your module requires additional libraries to link with, these can be listed
on the line in the configuration file as well, for instance:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>spam spammodule.o -lX11
</pre></div>
</div>
</div>
<div class="section" id="calling-python-functions-from-c">
<span id="callingpython"></span><h2>1.6. åœ¨Cä¸­è°ƒç”¨Pythonå‡½æ•°<a class="headerlink" href="#calling-python-functions-from-c" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>è¿„ä»Šä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¸€ç›´æŠŠæ³¨æ„åŠ›é›†ä¸­äºè®©Pythonè°ƒç”¨Cå‡½æ•°ï¼Œå…¶å®åè¿‡æ¥ä¹Ÿå¾ˆæœ‰ç”¨ï¼Œå°±æ˜¯ç”¨Cè°ƒç”¨Pythonå‡½æ•°ã€‚è¿™åœ¨å›è°ƒå‡½æ•°ä¸­å°¤å…¶æœ‰ç”¨ã€‚å¦‚æœä¸€ä¸ªCæ¥å£ä½¿ç”¨å›è°ƒï¼Œé‚£ä¹ˆå°±è¦å®ç°è¿™ä¸ªå›è°ƒæœºåˆ¶ã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼ŒPythonè§£é‡Šå™¨æ˜¯æ¯”è¾ƒæ–¹ä¾¿å›è°ƒçš„ï¼Œå¹¶ç»™æ ‡å‡†Pythonå‡½æ•°æä¾›äº†æ ‡å‡†æ¥å£ã€‚(è¿™é‡Œå°±ä¸å†è¯¦è¿°è§£æPythonä»£ç ä½œä¸ºè¾“å…¥çš„æ–¹å¼ï¼Œå¦‚æœæœ‰å…´è¶£å¯ä»¥å‚è€ƒ <code class="file docutils literal notranslate"><span class="pre">Python/pythonmain.c</span></code> ä¸­çš„ <a class="reference internal" href="cmdline.html#cmdoption-c" tppabs="https://docs.python.org/zh-cn/3/using/cmdline.html#cmdoption-c"><code class="xref std std-option docutils literal notranslate"><span class="pre">-c</span></code></a> å‘½ä»¤ä»£ç ã€‚)</p>
<p>è°ƒç”¨Pythonå‡½æ•°ï¼Œé¦–å…ˆPythonç¨‹åºè¦ä¼ é€’Pythonå‡½æ•°å¯¹è±¡ã€‚åº”è¯¥æä¾›ä¸ªå‡½æ•°(æˆ–å…¶ä»–æ¥å£)æ¥å®ç°ã€‚å½“è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œç”¨å…¨å±€å˜é‡ä¿å­˜Pythonå‡½æ•°å¯¹è±¡çš„æŒ‡é’ˆï¼Œè¿˜è¦è°ƒç”¨ (<a class="reference internal" href="refcounting.html#c.Py_INCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_INCREF" title="Py_INCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_INCREF()</span></code></a>) æ¥å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå½“ç„¶ä¸ç”¨å…¨å±€å˜é‡ä¹Ÿæ²¡ä»€ä¹ˆå…³ç³»ã€‚ä¾‹å¦‚å¦‚ä¸‹:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">my_callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">my_set_callback</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">dummy</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;O:set_callback&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyCallable_Check</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_TypeError</span><span class="p">,</span> <span class="s">&quot;parameter must be callable&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Py_XINCREF</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>         <span class="cm">/* Add a reference to new callback */</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">my_callback</span><span class="p">);</span>  <span class="cm">/* Dispose of previous callback */</span>
        <span class="n">my_callback</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>       <span class="cm">/* Remember new callback */</span>
        <span class="cm">/* Boilerplate to return &quot;None&quot; */</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Py_None</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>è¿™ä¸ªå‡½æ•°å¿…é¡»ä½¿ç”¨ <a class="reference internal" href="structures.html#METH_VARARGS" tppabs="https://docs.python.org/zh-cn/3/c-api/structures.html#METH_VARARGS" title="METH_VARARGS"><code class="xref py py-const docutils literal notranslate"><span class="pre">METH_VARARGS</span></code></a> æ ‡å¿—æ³¨å†Œåˆ°è§£é‡Šå™¨ï¼Œè¿™åœ¨ <a class="reference internal" href="#methodtable"><span class="std std-ref">æ¨¡å—æ–¹æ³•è¡¨å’Œåˆå§‹åŒ–å‡½æ•°</span></a> ç« èŠ‚ä¼šæè¿°ã€‚ <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> å‡½æ•°åŠå…¶å‚æ•°çš„æ–‡æ¡£åœ¨ <a class="reference internal" href="#parsetuple"><span class="std std-ref">æå–æ‰©å±•å‡½æ•°çš„å‚æ•°</span></a> ã€‚</p>
<p><a class="reference internal" href="refcounting.html#c.Py_XINCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_XINCREF" title="Py_XINCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_XINCREF()</span></code></a> å’Œ <a class="reference internal" href="refcounting.html#c.Py_XDECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_XDECREF" title="Py_XDECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_XDECREF()</span></code></a> è¿™ä¸¤ä¸ªå®å¯ä»¥ç”¨æ¥å¢åŠ æˆ–å‡å°‘å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå³ä½¿å‚æ•°æ˜¯ <em>NULL</em> æŒ‡é’ˆï¼Œæ“ä½œä¹Ÿæ˜¯å®‰å…¨çš„ï¼ˆä½†åœ¨è¿™ä¸ªä¾‹å­ä¸­ <em>temp</em> æ°¸è¿œä¸ä¼šä¸º <em>NULL</em>ï¼‰ã€‚æ›´å¤šå†…å®¹è¯·å‚è€ƒ <a class="reference internal" href="#refcounts"><span class="std std-ref">å¼•ç”¨è®¡æ•°</span></a> æ®µè½ã€‚</p>
<p id="index-1"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyEval_CallObject()</span></code> è¿”å›ä¸€ä¸ªPythonå¯¹è±¡æŒ‡é’ˆè¡¨ç¤ºè¿”å›å€¼ã€‚è¯¥å‡½æ•°æœ‰2ä¸ªå‚æ•°ï¼Œéƒ½æ˜¯æŒ‡å‘Pythonå¯¹è±¡çš„æŒ‡é’ˆï¼šPythonå‡½æ•°ï¼Œå’Œå‚æ•°åˆ—è¡¨ã€‚å‚æ•°åˆ—è¡¨å¿…é¡»æ˜¯tupleå¯¹è±¡ï¼Œå…¶é•¿åº¦æ˜¯å‚æ•°æ•°é‡ã€‚è¦è°ƒç”¨æ— å‚æ•°çš„Pythonå‡½æ•°ï¼Œå¯ä»¥ä¼ é€’NULLæˆ–ç©ºå…ƒç»„ã€‚è¦ç”¨å”¯ä¸€å‚æ•°è°ƒç”¨ï¼Œä¼ é€’å•ä¸€å…ƒç»„ã€‚ <a class="reference internal" href="arg.html#c.Py_BuildValue" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.Py_BuildValue" title="Py_BuildValue"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_BuildValue()</span></code></a> è¿”å›å…ƒç»„ï¼Œå½“å…¶æ ¼å¼ä¸ºå­—ç¬¦ä¸²æˆ–å¤šä¸ªç¼–ç æ—¶ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">arg</span><span class="p">;</span>
<span class="n">PyObject</span> <span class="o">*</span><span class="n">arglist</span><span class="p">;</span>
<span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">arg</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span>
<span class="p">...</span>
<span class="cm">/* Time to call the callback */</span>
<span class="n">arglist</span> <span class="o">=</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;(i)&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">PyObject_CallObject</span><span class="p">(</span><span class="n">my_callback</span><span class="p">,</span> <span class="n">arglist</span><span class="p">);</span>
<span class="n">Py_DECREF</span><span class="p">(</span><span class="n">arglist</span><span class="p">);</span>
</pre></div>
</div>
<p><a class="reference internal" href="object.html#c.PyObject_CallObject" tppabs="https://docs.python.org/zh-cn/3/c-api/object.html#c.PyObject_CallObject" title="PyObject_CallObject"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyObject_CallObject()</span></code></a> è¿”å›Pythonå¯¹è±¡æŒ‡é’ˆï¼Œè¿™ä¹Ÿæ˜¯Pythonå‡½æ•°çš„è¿”å›å€¼ã€‚ <a class="reference internal" href="object.html#c.PyObject_CallObject" tppabs="https://docs.python.org/zh-cn/3/c-api/object.html#c.PyObject_CallObject" title="PyObject_CallObject"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyObject_CallObject()</span></code></a> æ˜¯ä¸€ä¸ªå¯¹å…¶å‚æ•° &quot;å¼•ç”¨è®¡æ•°æ— å…³&quot; çš„å‡½æ•°ã€‚ä¾‹å­ä¸­æ–°çš„å…ƒç»„åˆ›å»ºç”¨äºå‚æ•°åˆ—è¡¨ï¼Œå¹¶ä¸”åœ¨  <a class="reference internal" href="object.html#c.PyObject_CallObject" tppabs="https://docs.python.org/zh-cn/3/c-api/object.html#c.PyObject_CallObject" title="PyObject_CallObject"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyObject_CallObject()</span></code></a> ä¹‹åç«‹å³ä½¿ç”¨äº† <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a> ã€‚</p>
<p><code class="xref c c-func docutils literal notranslate"><span class="pre">PyEval_CallObject()</span></code> çš„è¿”å›å€¼æ€»æ˜¯â€œæ–°â€çš„ï¼šè¦ä¹ˆæ˜¯ä¸€ä¸ªæ–°å»ºçš„å¯¹è±¡ï¼›è¦ä¹ˆæ˜¯å·²æœ‰å¯¹è±¡ï¼Œä½†å¢åŠ äº†å¼•ç”¨è®¡æ•°ã€‚æ‰€ä»¥é™¤éä½ æƒ³æŠŠç»“æœä¿å­˜åœ¨å…¨å±€å˜é‡ä¸­ï¼Œä½ éœ€è¦å¯¹è¿™ä¸ªå€¼ä½¿ç”¨ <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a>ï¼Œå³ä½¿ä½ å¯¹é‡Œé¢çš„å†…å®¹ï¼ˆç‰¹åˆ«ï¼ï¼‰ä¸æ„Ÿå…´è¶£ã€‚</p>
<p>åœ¨ä½ è¿™ä¹ˆåšä¹‹å‰ï¼Œéœ€è¦å…ˆæ£€æŸ¥è¿”å›å€¼æ˜¯å¦æ˜¯ <em>NULL</em> ã€‚å¦‚æœæ˜¯ï¼ŒPythonå‡½æ•°ä¼šç»ˆæ­¢å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœCä»£ç è°ƒç”¨äº†ä»Pythonä¼ å…¥çš„å‡½æ•° <a class="reference internal" href="object.html#c.PyObject_CallObject" tppabs="https://docs.python.org/zh-cn/3/c-api/object.html#c.PyObject_CallObject" title="PyObject_CallObject"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyObject_CallObject()</span></code></a> ï¼Œå› è¯¥ç«‹å³è¿”å›é”™è¯¯æ¥å‘ŠçŸ¥Pythonè°ƒç”¨è€…ï¼Œç„¶åè§£é‡Šå™¨ä¼šæ‰“å°æ ˆå›æº¯ï¼Œæˆ–è€…è°ƒç”¨Pythonä»£ç æ¥å¤„ç†è¿™ä¸ªå¼‚å¸¸ã€‚å¦‚æœæ— æ³•å¤„ç†ï¼Œå¼‚å¸¸ä¼šè¢« <a class="reference internal" href="exceptions-1.html#c.PyErr_Clear" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_Clear" title="PyErr_Clear"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_Clear()</span></code></a> æ¸…é™¤ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Pass error back */</span>
<span class="p">...</span><span class="n">use</span> <span class="n">result</span><span class="p">...</span>
<span class="n">Py_DECREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</pre></div>
</div>
<p>ä¾èµ–äºå…·ä½“çš„å›è°ƒå‡½æ•°ï¼Œä½ è¿˜è¦æä¾›ä¸€ä¸ªå‚æ•°åˆ—è¡¨åˆ° <code class="xref c c-func docutils literal notranslate"><span class="pre">PyEval_CallObject()</span></code> ã€‚åœ¨æŸäº›æƒ…å†µä¸‹å‚æ•°åˆ—è¡¨æ˜¯ç”±Pythonç¨‹åºæä¾›çš„ï¼Œé€šè¿‡æ¥å£å†ä¼ åˆ°å›è°ƒå‡½æ•°ã€‚è¿™æ ·å°±å¯ä»¥ä¸æ”¹å˜å½¢å¼ç›´æ¥ä¼ é€’ã€‚å¦å¤–ä¸€äº›æ—¶å€™ä½ è¦æ„é€ ä¸€ä¸ªæ–°çš„tupleæ¥ä¼ é€’å‚æ•°ã€‚æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ <a class="reference internal" href="arg.html#c.Py_BuildValue" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.Py_BuildValue" title="Py_BuildValue"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_BuildValue()</span></code></a> å‡½æ•°æ„é€ tupleã€‚ä¾‹å¦‚ï¼Œä½ è¦ä¼ é€’ä¸€ä¸ªäº‹ä»¶å¯¹è±¡æ—¶å¯ä»¥ç”¨:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span> <span class="o">*</span><span class="n">arglist</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">arglist</span> <span class="o">=</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;(l)&quot;</span><span class="p">,</span> <span class="n">eventcode</span><span class="p">);</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">PyObject_CallObject</span><span class="p">(</span><span class="n">my_callback</span><span class="p">,</span> <span class="n">arglist</span><span class="p">);</span>
<span class="n">Py_DECREF</span><span class="p">(</span><span class="n">arglist</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Pass error back */</span>
<span class="cm">/* Here maybe use the result */</span>
<span class="n">Py_DECREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</pre></div>
</div>
<p>æ³¨æ„ <code class="docutils literal notranslate"><span class="pre">Py_DECREF(arglist)</span></code> æ‰€åœ¨å¤„ä¼šç«‹å³è°ƒç”¨ï¼Œåœ¨é”™è¯¯æ£€æŸ¥ä¹‹å‰ã€‚å½“ç„¶è¿˜è¦æ³¨æ„ä¸€äº›å¸¸è§„çš„é”™è¯¯ï¼Œæ¯”å¦‚ <a class="reference internal" href="arg.html#c.Py_BuildValue" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.Py_BuildValue" title="Py_BuildValue"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_BuildValue()</span></code></a> å¯èƒ½ä¼šé­é‡å†…å­˜ä¸è¶³ç­‰ç­‰ã€‚</p>
<p>ä½ è¿˜éœ€è¦æ³¨æ„ï¼Œç”¨å…³é”®å­—å‚æ•°è°ƒç”¨ <a class="reference internal" href="object.html#c.PyObject_Call" tppabs="https://docs.python.org/zh-cn/3/c-api/object.html#c.PyObject_Call" title="PyObject_Call"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyObject_Call()</span></code></a> ï¼Œéœ€è¦æ”¯æŒæ™®é€šå‚æ•°å’Œå…³é”®å­—å‚æ•°ã€‚æœ‰å¦‚å¦‚ä¸Šä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <a class="reference internal" href="arg.html#c.Py_BuildValue" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.Py_BuildValue" title="Py_BuildValue"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_BuildValue()</span></code></a> æ¥æ„é€ å­—å…¸ã€‚</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span> <span class="o">*</span><span class="n">dict</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">dict</span> <span class="o">=</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;{s:i}&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">PyObject_Call</span><span class="p">(</span><span class="n">my_callback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dict</span><span class="p">);</span>
<span class="n">Py_DECREF</span><span class="p">(</span><span class="n">dict</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Pass error back */</span>
<span class="cm">/* Here maybe use the result */</span>
<span class="n">Py_DECREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="extracting-parameters-in-extension-functions">
<span id="parsetuple"></span><h2>1.7. æå–æ‰©å±•å‡½æ•°çš„å‚æ•°<a class="headerlink" href="#extracting-parameters-in-extension-functions" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p id="index-2">å‡½æ•° <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> çš„å£°æ˜å¦‚ä¸‹ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">PyArg_ParseTuple</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>
</pre></div>
</div>
<p>å‚æ•° <em>arg</em> å¿…é¡»æ˜¯ä¸€ä¸ªå…ƒç»„å¯¹è±¡ï¼ŒåŒ…å«ä» Python ä¼ é€’ç»™ C å‡½æ•°çš„å‚æ•°åˆ—è¡¨ã€‚<em>format</em> å‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªæ ¼å¼å­—ç¬¦ä¸²ï¼Œè¯­æ³•è¯·å‚è€ƒ Python C/API æ‰‹å†Œä¸­çš„ <a class="reference internal" href="arg.html#arg-parsing" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#arg-parsing"><span class="std std-ref">è¯­å¥è§£é‡ŠåŠå˜é‡ç¼–è¯‘</span></a>ã€‚å‰©ä½™å‚æ•°æ˜¯å„ä¸ªå˜é‡çš„åœ°å€ï¼Œç±»å‹è¦ä¸æ ¼å¼å­—ç¬¦ä¸²å¯¹åº”ã€‚</p>
<p>æ³¨æ„ <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> ä¼šæ£€æµ‹ä»–éœ€è¦çš„Pythonå‚æ•°ç±»å‹ï¼Œå´æ— æ³•æ£€æµ‹ä¼ é€’ç»™ä»–çš„Cå˜é‡åœ°å€ï¼Œå¦‚æœè¿™é‡Œå‡ºé”™äº†ï¼Œå¯èƒ½ä¼šåœ¨å†…å­˜ä¸­éšæœºå†™å…¥ä¸œè¥¿ï¼Œå°å¿ƒã€‚</p>
<p>æ³¨æ„ä»»ä½•ç”±è°ƒç”¨è€…æä¾›çš„Pythonå¯¹è±¡å¼•ç”¨æ˜¯ <em>å€Ÿæ¥çš„</em> å¼•ç”¨ï¼›ä¸è¦é€’å‡å®ƒä»¬çš„å¼•ç”¨è®¡æ•°ï¼</p>
<p>ä¸€äº›è°ƒç”¨çš„ä¾‹å­ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN  </span><span class="cm">/* Make &quot;s#&quot; use Py_ssize_t rather than int. */</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
<span class="kt">long</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
<span class="n">Py_ssize_t</span> <span class="n">size</span><span class="p">;</span>

<span class="n">ok</span> <span class="o">=</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span> <span class="cm">/* No arguments */</span>
    <span class="cm">/* Python call: f() */</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span> <span class="o">=</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span> <span class="cm">/* A string */</span>
    <span class="cm">/* Possible Python call: f(&#39;whoops!&#39;) */</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span> <span class="o">=</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;lls&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">k</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span> <span class="cm">/* Two longs and a string */</span>
    <span class="cm">/* Possible Python call: f(1, 2, &#39;three&#39;) */</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span> <span class="o">=</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;(ii)s#&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
    <span class="cm">/* A pair of ints and a string, whose size is also returned */</span>
    <span class="cm">/* Possible Python call: f((1, 2), &#39;three&#39;) */</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;r&quot;</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;s|si&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bufsize</span><span class="p">);</span>
    <span class="cm">/* A string, and optionally another string and an integer */</span>
    <span class="cm">/* Possible Python calls:</span>
<span class="cm">       f(&#39;spam&#39;)</span>
<span class="cm">       f(&#39;spam&#39;, &#39;w&#39;)</span>
<span class="cm">       f(&#39;spam&#39;, &#39;wb&#39;, 100000) */</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;((ii)(ii))(ii)&quot;</span><span class="p">,</span>
             <span class="o">&amp;</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bottom</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
    <span class="cm">/* A rectangle and a point */</span>
    <span class="cm">/* Possible Python call:</span>
<span class="cm">       f(((0, 0), (400, 300)), (10, 10)) */</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="n">Py_complex</span> <span class="n">c</span><span class="p">;</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;D:myfunction&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
    <span class="cm">/* a complex, also providing a function name for errors */</span>
    <span class="cm">/* Possible Python call: myfunction(1+2j) */</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="keyword-parameters-for-extension-functions">
<span id="parsetupleandkeywords"></span><h2>1.8. ç»™æ‰©å±•å‡½æ•°çš„å…³é”®å­—å‚æ•°<a class="headerlink" href="#keyword-parameters-for-extension-functions" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p id="index-3">å‡½æ•° <a class="reference internal" href="arg.html#c.PyArg_ParseTupleAndKeywords" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTupleAndKeywords" title="PyArg_ParseTupleAndKeywords"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTupleAndKeywords()</span></code></a> å£°æ˜å¦‚ä¸‹ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">PyArg_ParseTupleAndKeywords</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwdict</span><span class="p">,</span>
                                <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kwlist</span><span class="p">[],</span> <span class="p">...);</span>
</pre></div>
</div>
<p>å‚æ•° <em>arg</em> å’Œ <em>format</em> å®šä¹‰åŒ <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> ã€‚å‚æ•° <em>kwdict</em> æ˜¯å…³é”®å­—å­—å…¸ï¼Œç”¨äºæ¥å—è¿è¡Œæ—¶ä¼ æ¥çš„å…³é”®å­—å‚æ•°ã€‚å‚æ•° <em>kwlist</em> æ˜¯ä¸€ä¸ª <em>NULL</em> ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œå®šä¹‰äº†å¯ä»¥æ¥å—çš„å‚æ•°åï¼Œå¹¶ä»å·¦åˆ°å³ä¸ <em>format</em> ä¸­å„ä¸ªå˜é‡å¯¹åº”ã€‚å¦‚æœæ‰§è¡ŒæˆåŠŸ <a class="reference internal" href="arg.html#c.PyArg_ParseTupleAndKeywords" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTupleAndKeywords" title="PyArg_ParseTupleAndKeywords"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTupleAndKeywords()</span></code></a> ä¼šè¿”å›trueï¼Œå¦åˆ™è¿”å›falseå¹¶æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<div class="admonition note">
<p class="first admonition-title">æ³¨è§£</p>
<p class="last">åµŒå¥—çš„å…ƒç»„åœ¨ä½¿ç”¨å…³é”®å­—å‚æ•°æ—¶æ— æ³•ç”Ÿæ•ˆï¼Œä¸åœ¨ <em>kwlist</em> ä¸­çš„å…³é”®å­—å‚æ•°ä¼šå¯¼è‡´ <a class="reference internal" href="exceptions.html#TypeError" tppabs="https://docs.python.org/zh-cn/3/library/exceptions.html#TypeError" title="TypeError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">TypeError</span></code></a> å¼‚å¸¸ã€‚</p>
</div>
<p id="index-4">å¦‚ä¸‹æ˜¯ä½¿ç”¨å…³é”®å­—å‚æ•°çš„ä¾‹å­æ¨¡å—ï¼Œä½œè€…æ˜¯ Geoff Philbrick (<a class="reference external" href="mailto:phibrick&#37;&#52;&#48;hks&#46;com">phibrick<span>&#64;</span>hks<span>&#46;</span>com</a>):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN  </span><span class="cm">/* Make &quot;s#&quot; use Py_ssize_t rather than int. */</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">keywdarg_parrot</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">keywds</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">voltage</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="s">&quot;a stiff&quot;</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">action</span> <span class="o">=</span> <span class="s">&quot;voom&quot;</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;Norwegian Blue&quot;</span><span class="p">;</span>

    <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kwlist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;voltage&quot;</span><span class="p">,</span> <span class="s">&quot;state&quot;</span><span class="p">,</span> <span class="s">&quot;action&quot;</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTupleAndKeywords</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">keywds</span><span class="p">,</span> <span class="s">&quot;i|sss&quot;</span><span class="p">,</span> <span class="n">kwlist</span><span class="p">,</span>
                                     <span class="o">&amp;</span><span class="n">voltage</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;-- This parrot wouldn&#39;t %s if you put %i Volts through it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
           <span class="n">action</span><span class="p">,</span> <span class="n">voltage</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;-- Lovely plumage, the %s -- It&#39;s %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

    <span class="n">Py_RETURN_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">keywdarg_methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="cm">/* The cast of the function is necessary since PyCFunction values</span>
<span class="cm">     * only take two PyObject* parameters, and keywdarg_parrot() takes</span>
<span class="cm">     * three.</span>
<span class="cm">     */</span>
    <span class="p">{</span><span class="s">&quot;parrot&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">keywdarg_parrot</span><span class="p">,</span> <span class="n">METH_VARARGS</span> <span class="o">|</span> <span class="n">METH_KEYWORDS</span><span class="p">,</span>
     <span class="s">&quot;Print a lovely skit to standard output.&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>   <span class="cm">/* sentinel */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">keywdargmodule</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span>
    <span class="s">&quot;keywdarg&quot;</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">keywdarg_methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_keywdarg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keywdargmodule</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="building-arbitrary-values">
<span id="buildvalue"></span><h2>1.9. æ„é€ ä»»æ„å€¼<a class="headerlink" href="#building-arbitrary-values" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>è¿™ä¸ªå‡½æ•°ä¸ <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> å¾ˆç›¸ä¼¼ï¼Œå£°æ˜å¦‚ä¸‹ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span> <span class="o">*</span><span class="nf">Py_BuildValue</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>
</pre></div>
</div>
<p>æ¥å—ä¸€ä¸ªæ ¼å¼å­—ç¬¦ä¸²ï¼Œä¸ <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> ç›¸åŒï¼Œä½†æ˜¯å‚æ•°å¿…é¡»æ˜¯åŸå˜é‡çš„åœ°å€æŒ‡é’ˆ(è¾“å…¥ç»™å‡½æ•°ï¼Œè€Œéè¾“å‡º)ã€‚æœ€ç»ˆè¿”å›ä¸€ä¸ªPythonå¯¹è±¡é€‚åˆäºè¿”å›Cå‡½æ•°è°ƒç”¨ç»™Pythonä»£ç ã€‚</p>
<p>ä¸€ä¸ªä¸ <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> çš„ä¸åŒæ˜¯ï¼Œåé¢å¯èƒ½éœ€è¦çš„è¦æ±‚è¿”å›ä¸€ä¸ªå…ƒç»„(Pythonå‚æ•°é‡Œè¯¶åŒ…æ€»æ˜¯åœ¨å†…éƒ¨æè¿°ä¸ºå…ƒç»„)ï¼Œæ¯”å¦‚ç”¨äºä¼ é€’ç»™å…¶ä»–Pythonå‡½æ•°ä»¥å‚æ•°ã€‚ <a class="reference internal" href="arg.html#c.Py_BuildValue" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.Py_BuildValue" title="Py_BuildValue"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_BuildValue()</span></code></a> å¹¶ä¸æ€»æ˜¯ç”Ÿæˆå…ƒç»„ï¼Œåœ¨å¤šäº1ä¸ªå‚æ•°æ—¶ä¼šç”Ÿæˆå…ƒç»„ï¼Œè€Œå¦‚æœæ²¡æœ‰å‚æ•°åˆ™è¿”å› <code class="docutils literal notranslate"><span class="pre">None</span></code> ï¼Œä¸€ä¸ªå‚æ•°åˆ™ç›´æ¥è¿”å›è¯¥å‚æ•°çš„å¯¹è±¡ã€‚å¦‚æœè¦æ±‚å¼ºåˆ¶ç”Ÿæˆä¸€ä¸ªé•¿åº¦ä¸ºç©ºçš„å…ƒç»„ï¼Œæˆ–åŒ…å«ä¸€ä¸ªå…ƒç´ çš„å…ƒç»„ï¼Œéœ€è¦åœ¨æ ¼å¼å­—ç¬¦ä¸²ä¸­åŠ ä¸Šæ‹¬å·ã€‚</p>
<p>ä¾‹å­(å·¦ä¾§æ˜¯è°ƒç”¨ï¼Œå³ä¾§æ˜¯Pythonå€¼ç»“æœ)ï¼š</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Py_BuildValue(&quot;&quot;)                        None
Py_BuildValue(&quot;i&quot;, 123)                  123
Py_BuildValue(&quot;iii&quot;, 123, 456, 789)      (123, 456, 789)
Py_BuildValue(&quot;s&quot;, &quot;hello&quot;)              &#39;hello&#39;
Py_BuildValue(&quot;y&quot;, &quot;hello&quot;)              b&#39;hello&#39;
Py_BuildValue(&quot;ss&quot;, &quot;hello&quot;, &quot;world&quot;)    (&#39;hello&#39;, &#39;world&#39;)
Py_BuildValue(&quot;s#&quot;, &quot;hello&quot;, 4)          &#39;hell&#39;
Py_BuildValue(&quot;y#&quot;, &quot;hello&quot;, 4)          b&#39;hell&#39;
Py_BuildValue(&quot;()&quot;)                      ()
Py_BuildValue(&quot;(i)&quot;, 123)                (123,)
Py_BuildValue(&quot;(ii)&quot;, 123, 456)          (123, 456)
Py_BuildValue(&quot;(i,i)&quot;, 123, 456)         (123, 456)
Py_BuildValue(&quot;[i,i]&quot;, 123, 456)         [123, 456]
Py_BuildValue(&quot;{s:i,s:i}&quot;,
              &quot;abc&quot;, 123, &quot;def&quot;, 456)    {&#39;abc&#39;: 123, &#39;def&#39;: 456}
Py_BuildValue(&quot;((ii)(ii)) (ii)&quot;,
              1, 2, 3, 4, 5, 6)          (((1, 2), (3, 4)), (5, 6))
</pre></div>
</div>
</div>
<div class="section" id="reference-counts">
<span id="refcounts"></span><h2>1.10. å¼•ç”¨è®¡æ•°<a class="headerlink" href="#reference-counts" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>åœ¨C/C++è¯­è¨€ä¸­ï¼Œç¨‹åºå‘˜è´Ÿè´£åŠ¨æ€åˆ†é…å’Œå›æ”¶å †(heap)å½“ä¸­çš„å†…å­˜ã€‚åœ¨Cé‡Œï¼Œé€šè¿‡å‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> å’Œ <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> æ¥å®Œæˆã€‚åœ¨C++é‡Œæ˜¯æ“ä½œ <code class="docutils literal notranslate"><span class="pre">new</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">delete</span></code> æ¥å®ç°ç›¸åŒçš„åŠŸèƒ½ã€‚</p>
<p>Every block of memory allocated with <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> should eventually be
returned to the pool of available memory by exactly one call to <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code>.
It is important to call <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> at the right time.  If a block's address
is forgotten but <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> is not called for it, the memory it occupies
cannot be reused until the program terminates.  This is called a <em class="dfn">memory
leak</em>.  On the other hand, if a program calls <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> for a block and then
continues to use the block, it creates a conflict with re-use of the block
through another <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> call.  This is called <em class="dfn">using freed memory</em>.
It has the same bad consequences as referencing uninitialized data --- core
dumps, wrong results, mysterious crashes.</p>
<p>Common causes of memory leaks are unusual paths through the code.  For instance,
a function may allocate a block of memory, do some calculation, and then free
the block again.  Now a change in the requirements for the function may add a
test to the calculation that detects an error condition and can return
prematurely from the function.  It's easy to forget to free the allocated memory
block when taking this premature exit, especially when it is added later to the
code.  Such leaks, once introduced, often go undetected for a long time: the
error exit is taken only in a small fraction of all calls, and most modern
machines have plenty of virtual memory, so the leak only becomes apparent in a
long-running process that uses the leaking function frequently.  Therefore, it's
important to prevent leaks from happening by having a coding convention or
strategy that minimizes this kind of errors.</p>
<p>Since Python makes heavy use of <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> and <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code>, it needs a
strategy to avoid memory leaks as well as the use of freed memory.  The chosen
method is called <em class="dfn">reference counting</em>.  The principle is simple: every
object contains a counter, which is incremented when a reference to the object
is stored somewhere, and which is decremented when a reference to it is deleted.
When the counter reaches zero, the last reference to the object has been deleted
and the object is freed.</p>
<p>An alternative strategy is called <em class="dfn">automatic garbage collection</em>.
(Sometimes, reference counting is also referred to as a garbage collection
strategy, hence my use of &quot;automatic&quot; to distinguish the two.)  The big
advantage of automatic garbage collection is that the user doesn't need to call
<code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> explicitly.  (Another claimed advantage is an improvement in speed
or memory usage --- this is no hard fact however.)  The disadvantage is that for
C, there is no truly portable automatic garbage collector, while reference
counting can be implemented portably (as long as the functions <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code>
and <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> are available --- which the C Standard guarantees). Maybe some
day a sufficiently portable automatic garbage collector will be available for C.
Until then, we'll have to live with reference counts.</p>
<p>While Python uses the traditional reference counting implementation, it also
offers a cycle detector that works to detect reference cycles.  This allows
applications to not worry about creating direct or indirect circular references;
these are the weakness of garbage collection implemented using only reference
counting.  Reference cycles consist of objects which contain (possibly indirect)
references to themselves, so that each object in the cycle has a reference count
which is non-zero.  Typical reference counting implementations are not able to
reclaim the memory belonging to any objects in a reference cycle, or referenced
from the objects in the cycle, even though there are no further references to
the cycle itself.</p>
<p>The cycle detector is able to detect garbage cycles and can reclaim them.
The <a class="reference internal" href="gc.html#module-gc" tppabs="https://docs.python.org/zh-cn/3/library/gc.html#module-gc" title="gc: Interface to the cycle-detecting garbage collector."><code class="xref py py-mod docutils literal notranslate"><span class="pre">gc</span></code></a> module exposes a way to run the detector (the
<a class="reference internal" href="gc.html#gc.collect" tppabs="https://docs.python.org/zh-cn/3/library/gc.html#gc.collect" title="gc.collect"><code class="xref py py-func docutils literal notranslate"><span class="pre">collect()</span></code></a> function), as well as configuration
interfaces and the ability to disable the detector at runtime.  The cycle
detector is considered an optional component; though it is included by default,
it can be disabled at build time using the <code class="xref std std-option docutils literal notranslate"><span class="pre">--without-cycle-gc</span></code> option
to the <strong class="program">configure</strong> script on Unix platforms (including Mac OS X).  If
the cycle detector is disabled in this way, the <a class="reference internal" href="gc.html#module-gc" tppabs="https://docs.python.org/zh-cn/3/library/gc.html#module-gc" title="gc: Interface to the cycle-detecting garbage collector."><code class="xref py py-mod docutils literal notranslate"><span class="pre">gc</span></code></a> module will not be
available.</p>
<div class="section" id="reference-counting-in-python">
<span id="refcountsinpython"></span><h3>1.10.1. Reference Counting in Python<a class="headerlink" href="#reference-counting-in-python" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h3>
<p>There are two macros, <code class="docutils literal notranslate"><span class="pre">Py_INCREF(x)</span></code> and <code class="docutils literal notranslate"><span class="pre">Py_DECREF(x)</span></code>, which handle the
incrementing and decrementing of the reference count. <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a> also
frees the object when the count reaches zero. For flexibility, it doesn't call
<code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> directly --- rather, it makes a call through a function pointer in
the object's <em class="dfn">type object</em>.  For this purpose (and others), every object
also contains a pointer to its type object.</p>
<p>The big question now remains: when to use <code class="docutils literal notranslate"><span class="pre">Py_INCREF(x)</span></code> and <code class="docutils literal notranslate"><span class="pre">Py_DECREF(x)</span></code>?
Let's first introduce some terms.  Nobody &quot;owns&quot; an object; however, you can
<em class="dfn">own a reference</em> to an object.  An object's reference count is now defined
as the number of owned references to it.  The owner of a reference is
responsible for calling <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a> when the reference is no longer
needed.  Ownership of a reference can be transferred.  There are three ways to
dispose of an owned reference: pass it on, store it, or call <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a>.
Forgetting to dispose of an owned reference creates a memory leak.</p>
<p>It is also possible to <em class="dfn">borrow</em> <a class="footnote-reference" href="#id6" id="id2">[2]</a> a reference to an object.  The
borrower of a reference should not call <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a>.  The borrower must
not hold on to the object longer than the owner from which it was borrowed.
Using a borrowed reference after the owner has disposed of it risks using freed
memory and should be avoided completely <a class="footnote-reference" href="#id7" id="id3">[3]</a>.</p>
<p>The advantage of borrowing over owning a reference is that you don't need to
take care of disposing of the reference on all possible paths through the code
--- in other words, with a borrowed reference you don't run the risk of leaking
when a premature exit is taken.  The disadvantage of borrowing over owning is
that there are some subtle situations where in seemingly correct code a borrowed
reference can be used after the owner from which it was borrowed has in fact
disposed of it.</p>
<p>A borrowed reference can be changed into an owned reference by calling
<a class="reference internal" href="refcounting.html#c.Py_INCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_INCREF" title="Py_INCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_INCREF()</span></code></a>.  This does not affect the status of the owner from which the
reference was borrowed --- it creates a new owned reference, and gives full
owner responsibilities (the new owner must dispose of the reference properly, as
well as the previous owner).</p>
</div>
<div class="section" id="ownership-rules">
<span id="ownershiprules"></span><h3>1.10.2. Ownership Rules<a class="headerlink" href="#ownership-rules" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h3>
<p>Whenever an object reference is passed into or out of a function, it is part of
the function's interface specification whether ownership is transferred with the
reference or not.</p>
<p>Most functions that return a reference to an object pass on ownership with the
reference.  In particular, all functions whose function it is to create a new
object, such as <a class="reference internal" href="long.html#c.PyLong_FromLong" tppabs="https://docs.python.org/zh-cn/3/c-api/long.html#c.PyLong_FromLong" title="PyLong_FromLong"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyLong_FromLong()</span></code></a> and <a class="reference internal" href="arg.html#c.Py_BuildValue" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.Py_BuildValue" title="Py_BuildValue"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_BuildValue()</span></code></a>, pass
ownership to the receiver.  Even if the object is not actually new, you still
receive ownership of a new reference to that object.  For instance,
<a class="reference internal" href="long.html#c.PyLong_FromLong" tppabs="https://docs.python.org/zh-cn/3/c-api/long.html#c.PyLong_FromLong" title="PyLong_FromLong"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyLong_FromLong()</span></code></a> maintains a cache of popular values and can return a
reference to a cached item.</p>
<p>Many functions that extract objects from other objects also transfer ownership
with the reference, for instance <a class="reference internal" href="object.html#c.PyObject_GetAttrString" tppabs="https://docs.python.org/zh-cn/3/c-api/object.html#c.PyObject_GetAttrString" title="PyObject_GetAttrString"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyObject_GetAttrString()</span></code></a>.  The picture
is less clear, here, however, since a few common routines are exceptions:
<a class="reference internal" href="tuple.html#c.PyTuple_GetItem" tppabs="https://docs.python.org/zh-cn/3/c-api/tuple.html#c.PyTuple_GetItem" title="PyTuple_GetItem"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyTuple_GetItem()</span></code></a>, <a class="reference internal" href="list.html#c.PyList_GetItem" tppabs="https://docs.python.org/zh-cn/3/c-api/list.html#c.PyList_GetItem" title="PyList_GetItem"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyList_GetItem()</span></code></a>, <a class="reference internal" href="dict.html#c.PyDict_GetItem" tppabs="https://docs.python.org/zh-cn/3/c-api/dict.html#c.PyDict_GetItem" title="PyDict_GetItem"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyDict_GetItem()</span></code></a>, and
<a class="reference internal" href="dict.html#c.PyDict_GetItemString" tppabs="https://docs.python.org/zh-cn/3/c-api/dict.html#c.PyDict_GetItemString" title="PyDict_GetItemString"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyDict_GetItemString()</span></code></a> all return references that you borrow from the
tuple, list or dictionary.</p>
<p>The function <a class="reference internal" href="import-1.html#c.PyImport_AddModule" tppabs="https://docs.python.org/zh-cn/3/c-api/import.html#c.PyImport_AddModule" title="PyImport_AddModule"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyImport_AddModule()</span></code></a> also returns a borrowed reference, even
though it may actually create the object it returns: this is possible because an
owned reference to the object is stored in <code class="docutils literal notranslate"><span class="pre">sys.modules</span></code>.</p>
<p>When you pass an object reference into another function, in general, the
function borrows the reference from you --- if it needs to store it, it will use
<a class="reference internal" href="refcounting.html#c.Py_INCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_INCREF" title="Py_INCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_INCREF()</span></code></a> to become an independent owner.  There are exactly two
important exceptions to this rule: <a class="reference internal" href="tuple.html#c.PyTuple_SetItem" tppabs="https://docs.python.org/zh-cn/3/c-api/tuple.html#c.PyTuple_SetItem" title="PyTuple_SetItem"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyTuple_SetItem()</span></code></a> and
<a class="reference internal" href="list.html#c.PyList_SetItem" tppabs="https://docs.python.org/zh-cn/3/c-api/list.html#c.PyList_SetItem" title="PyList_SetItem"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyList_SetItem()</span></code></a>.  These functions take over ownership of the item passed
to them --- even if they fail!  (Note that <a class="reference internal" href="dict.html#c.PyDict_SetItem" tppabs="https://docs.python.org/zh-cn/3/c-api/dict.html#c.PyDict_SetItem" title="PyDict_SetItem"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyDict_SetItem()</span></code></a> and friends
don't take over ownership --- they are &quot;normal.&quot;)</p>
<p>When a C function is called from Python, it borrows references to its arguments
from the caller.  The caller owns a reference to the object, so the borrowed
reference's lifetime is guaranteed until the function returns.  Only when such a
borrowed reference must be stored or passed on, it must be turned into an owned
reference by calling <a class="reference internal" href="refcounting.html#c.Py_INCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_INCREF" title="Py_INCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_INCREF()</span></code></a>.</p>
<p>The object reference returned from a C function that is called from Python must
be an owned reference --- ownership is transferred from the function to its
caller.</p>
</div>
<div class="section" id="thin-ice">
<span id="thinice"></span><h3>1.10.3. Thin Ice<a class="headerlink" href="#thin-ice" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h3>
<p>There are a few situations where seemingly harmless use of a borrowed reference
can lead to problems.  These all have to do with implicit invocations of the
interpreter, which can cause the owner of a reference to dispose of it.</p>
<p>The first and most important case to know about is using <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a> on
an unrelated object while borrowing a reference to a list item.  For instance:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">bug</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="n">PyList_GetItem</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">PyList_SetItem</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="mi">0L</span><span class="p">));</span>
    <span class="n">PyObject_Print</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* BUG! */</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This function first borrows a reference to <code class="docutils literal notranslate"><span class="pre">list[0]</span></code>, then replaces
<code class="docutils literal notranslate"><span class="pre">list[1]</span></code> with the value <code class="docutils literal notranslate"><span class="pre">0</span></code>, and finally prints the borrowed reference.
Looks harmless, right?  But it's not!</p>
<p>Let's follow the control flow into <a class="reference internal" href="list.html#c.PyList_SetItem" tppabs="https://docs.python.org/zh-cn/3/c-api/list.html#c.PyList_SetItem" title="PyList_SetItem"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyList_SetItem()</span></code></a>.  The list owns
references to all its items, so when item 1 is replaced, it has to dispose of
the original item 1.  Now let's suppose the original item 1 was an instance of a
user-defined class, and let's further suppose that the class defined a
<a class="reference internal" href="datamodel.html#object.__del__" tppabs="https://docs.python.org/zh-cn/3/reference/datamodel.html#object.__del__" title="object.__del__"><code class="xref py py-meth docutils literal notranslate"><span class="pre">__del__()</span></code></a> method.  If this class instance has a reference count of 1,
disposing of it will call its <a class="reference internal" href="datamodel.html#object.__del__" tppabs="https://docs.python.org/zh-cn/3/reference/datamodel.html#object.__del__" title="object.__del__"><code class="xref py py-meth docutils literal notranslate"><span class="pre">__del__()</span></code></a> method.</p>
<p>Since it is written in Python, the <a class="reference internal" href="datamodel.html#object.__del__" tppabs="https://docs.python.org/zh-cn/3/reference/datamodel.html#object.__del__" title="object.__del__"><code class="xref py py-meth docutils literal notranslate"><span class="pre">__del__()</span></code></a> method can execute arbitrary
Python code.  Could it perhaps do something to invalidate the reference to
<code class="docutils literal notranslate"><span class="pre">item</span></code> in <code class="xref c c-func docutils literal notranslate"><span class="pre">bug()</span></code>?  You bet!  Assuming that the list passed into
<code class="xref c c-func docutils literal notranslate"><span class="pre">bug()</span></code> is accessible to the <a class="reference internal" href="datamodel.html#object.__del__" tppabs="https://docs.python.org/zh-cn/3/reference/datamodel.html#object.__del__" title="object.__del__"><code class="xref py py-meth docutils literal notranslate"><span class="pre">__del__()</span></code></a> method, it could execute a
statement to the effect of <code class="docutils literal notranslate"><span class="pre">del</span> <span class="pre">list[0]</span></code>, and assuming this was the last
reference to that object, it would free the memory associated with it, thereby
invalidating <code class="docutils literal notranslate"><span class="pre">item</span></code>.</p>
<p>The solution, once you know the source of the problem, is easy: temporarily
increment the reference count.  The correct version of the function reads:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">no_bug</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="n">PyList_GetItem</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
    <span class="n">PyList_SetItem</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="mi">0L</span><span class="p">));</span>
    <span class="n">PyObject_Print</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is a true story.  An older version of Python contained variants of this bug
and someone spent a considerable amount of time in a C debugger to figure out
why his <a class="reference internal" href="datamodel.html#object.__del__" tppabs="https://docs.python.org/zh-cn/3/reference/datamodel.html#object.__del__" title="object.__del__"><code class="xref py py-meth docutils literal notranslate"><span class="pre">__del__()</span></code></a> methods would fail...</p>
<p>The second case of problems with a borrowed reference is a variant involving
threads.  Normally, multiple threads in the Python interpreter can't get in each
other's way, because there is a global lock protecting Python's entire object
space.  However, it is possible to temporarily release this lock using the macro
<a class="reference internal" href="init.html#c.Py_BEGIN_ALLOW_THREADS" tppabs="https://docs.python.org/zh-cn/3/c-api/init.html#c.Py_BEGIN_ALLOW_THREADS" title="Py_BEGIN_ALLOW_THREADS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">Py_BEGIN_ALLOW_THREADS</span></code></a>, and to re-acquire it using
<a class="reference internal" href="init.html#c.Py_END_ALLOW_THREADS" tppabs="https://docs.python.org/zh-cn/3/c-api/init.html#c.Py_END_ALLOW_THREADS" title="Py_END_ALLOW_THREADS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">Py_END_ALLOW_THREADS</span></code></a>.  This is common around blocking I/O calls, to
let other threads use the processor while waiting for the I/O to complete.
Obviously, the following function has the same problem as the previous one:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">bug</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="n">PyList_GetItem</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="p">...</span><span class="n">some</span> <span class="n">blocking</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">call</span><span class="p">...</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="n">PyObject_Print</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* BUG! */</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="null-pointers">
<span id="nullpointers"></span><h3>1.10.4. NULL Pointers<a class="headerlink" href="#null-pointers" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h3>
<p>In general, functions that take object references as arguments do not expect you
to pass them <em>NULL</em> pointers, and will dump core (or cause later core dumps) if
you do so.  Functions that return object references generally return <em>NULL</em> only
to indicate that an exception occurred.  The reason for not testing for <em>NULL</em>
arguments is that functions often pass the objects they receive on to other
function --- if each function were to test for <em>NULL</em>, there would be a lot of
redundant tests and the code would run more slowly.</p>
<p>It is better to test for <em>NULL</em> only at the &quot;source:&quot; when a pointer that may be
<em>NULL</em> is received, for example, from <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> or from a function that
may raise an exception.</p>
<p>The macros <a class="reference internal" href="refcounting.html#c.Py_INCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_INCREF" title="Py_INCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_INCREF()</span></code></a> and <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a> do not check for <em>NULL</em>
pointers --- however, their variants <a class="reference internal" href="refcounting.html#c.Py_XINCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_XINCREF" title="Py_XINCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_XINCREF()</span></code></a> and <a class="reference internal" href="refcounting.html#c.Py_XDECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_XDECREF" title="Py_XDECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_XDECREF()</span></code></a>
do.</p>
<p>The macros for checking for a particular object type (<code class="docutils literal notranslate"><span class="pre">Pytype_Check()</span></code>) don't
check for <em>NULL</em> pointers --- again, there is much code that calls several of
these in a row to test an object against various different expected types, and
this would generate redundant tests.  There are no variants with <em>NULL</em>
checking.</p>
<p>The C function calling mechanism guarantees that the argument list passed to C
functions (<code class="docutils literal notranslate"><span class="pre">args</span></code> in the examples) is never <em>NULL</em> --- in fact it guarantees
that it is always a tuple <a class="footnote-reference" href="#id8" id="id4">[4]</a>.</p>
<p>It is a severe error to ever let a <em>NULL</em> pointer &quot;escape&quot; to the Python user.</p>
</div>
</div>
<div class="section" id="writing-extensions-in-c">
<span id="cplusplus"></span><h2>1.11. Writing Extensions in C++<a class="headerlink" href="#writing-extensions-in-c" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>It is possible to write extension modules in C++.  Some restrictions apply.  If
the main program (the Python interpreter) is compiled and linked by the C
compiler, global or static objects with constructors cannot be used.  This is
not a problem if the main program is linked by the C++ compiler.  Functions that
will be called by the Python interpreter (in particular, module initialization
functions) have to be declared using <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">&quot;C&quot;</span></code>. It is unnecessary to
enclose the Python header files in <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">&quot;C&quot;</span> <span class="pre">{...}</span></code> --- they use this form
already if the symbol <code class="docutils literal notranslate"><span class="pre">__cplusplus</span></code> is defined (all recent C++ compilers
define this symbol).</p>
</div>
<div class="section" id="providing-a-c-api-for-an-extension-module">
<span id="using-capsules"></span><h2>1.12. Providing a C API for an Extension Module<a class="headerlink" href="#providing-a-c-api-for-an-extension-module" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>Many extension modules just provide new functions and types to be used from
Python, but sometimes the code in an extension module can be useful for other
extension modules. For example, an extension module could implement a type
&quot;collection&quot; which works like lists without order. Just like the standard Python
list type has a C API which permits extension modules to create and manipulate
lists, this new collection type should have a set of C functions for direct
manipulation from other extension modules.</p>
<p>At first sight this seems easy: just write the functions (without declaring them
<code class="docutils literal notranslate"><span class="pre">static</span></code>, of course), provide an appropriate header file, and document
the C API. And in fact this would work if all extension modules were always
linked statically with the Python interpreter. When modules are used as shared
libraries, however, the symbols defined in one module may not be visible to
another module. The details of visibility depend on the operating system; some
systems use one global namespace for the Python interpreter and all extension
modules (Windows, for example), whereas others require an explicit list of
imported symbols at module link time (AIX is one example), or offer a choice of
different strategies (most Unices). And even if symbols are globally visible,
the module whose functions one wishes to call might not have been loaded yet!</p>
<p>Portability therefore requires not to make any assumptions about symbol
visibility. This means that all symbols in extension modules should be declared
<code class="docutils literal notranslate"><span class="pre">static</span></code>, except for the module's initialization function, in order to
avoid name clashes with other extension modules (as discussed in section
<a class="reference internal" href="#methodtable"><span class="std std-ref">æ¨¡å—æ–¹æ³•è¡¨å’Œåˆå§‹åŒ–å‡½æ•°</span></a>). And it means that symbols that <em>should</em> be accessible from
other extension modules must be exported in a different way.</p>
<p>Python provides a special mechanism to pass C-level information (pointers) from
one extension module to another one: Capsules. A Capsule is a Python data type
which stores a pointer (<code class="xref c c-type docutils literal notranslate"><span class="pre">void</span> <span class="pre">*</span></code>).  Capsules can only be created and
accessed via their C API, but they can be passed around like any other Python
object. In particular,  they can be assigned to a name in an extension module's
namespace. Other extension modules can then import this module, retrieve the
value of this name, and then retrieve the pointer from the Capsule.</p>
<p>There are many ways in which Capsules can be used to export the C API of an
extension module. Each function could get its own Capsule, or all C API pointers
could be stored in an array whose address is published in a Capsule. And the
various tasks of storing and retrieving the pointers can be distributed in
different ways between the module providing the code and the client modules.</p>
<p>Whichever method you choose, it's important to name your Capsules properly.
The function <a class="reference internal" href="capsule.html#c.PyCapsule_New" tppabs="https://docs.python.org/zh-cn/3/c-api/capsule.html#c.PyCapsule_New" title="PyCapsule_New"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyCapsule_New()</span></code></a> takes a name parameter
(<code class="xref c c-type docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*</span></code>); you're permitted to pass in a <em>NULL</em> name, but
we strongly encourage you to specify a name.  Properly named Capsules provide
a degree of runtime type-safety; there is no feasible way to tell one unnamed
Capsule from another.</p>
<p>In particular, Capsules used to expose C APIs should be given a name following
this convention:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">modulename</span><span class="p">.</span><span class="n">attributename</span>
</pre></div>
</div>
<p>The convenience function <a class="reference internal" href="capsule.html#c.PyCapsule_Import" tppabs="https://docs.python.org/zh-cn/3/c-api/capsule.html#c.PyCapsule_Import" title="PyCapsule_Import"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyCapsule_Import()</span></code></a> makes it easy to
load a C API provided via a Capsule, but only if the Capsule's name
matches this convention.  This behavior gives C API users a high degree
of certainty that the Capsule they load contains the correct C API.</p>
<p>The following example demonstrates an approach that puts most of the burden on
the writer of the exporting module, which is appropriate for commonly used
library modules. It stores all C API pointers (just one in the example!) in an
array of <code class="xref c c-type docutils literal notranslate"><span class="pre">void</span></code> pointers which becomes the value of a Capsule. The header
file corresponding to the module provides a macro that takes care of importing
the module and retrieving its C API pointers; client modules only have to call
this macro before accessing the C API.</p>
<p>The exporting module is a modification of the <code class="xref py py-mod docutils literal notranslate"><span class="pre">spam</span></code> module from section
<a class="reference internal" href="#extending-simpleexample"><span class="std std-ref">ä¸€ä¸ªç®€å•çš„ä¾‹å­</span></a>. The function <code class="xref py py-func docutils literal notranslate"><span class="pre">spam.system()</span></code> does not call
the C library function <code class="xref c c-func docutils literal notranslate"><span class="pre">system()</span></code> directly, but a function
<code class="xref c c-func docutils literal notranslate"><span class="pre">PySpam_System()</span></code>, which would of course do something more complicated in
reality (such as adding &quot;spam&quot; to every command). This function
<code class="xref c c-func docutils literal notranslate"><span class="pre">PySpam_System()</span></code> is also exported to other extension modules.</p>
<p>The function <code class="xref c c-func docutils literal notranslate"><span class="pre">PySpam_System()</span></code> is a plain C function, declared
<code class="docutils literal notranslate"><span class="pre">static</span></code> like everything else:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span>
<span class="nf">PySpam_System</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The function <code class="xref c c-func docutils literal notranslate"><span class="pre">spam_system()</span></code> is modified in a trivial way:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">spam_system</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sts</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">sts</span> <span class="o">=</span> <span class="n">PySpam_System</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="n">sts</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the beginning of the module, right after the line</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<p>two more lines must be added:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define SPAM_MODULE</span>
<span class="cp">#include</span> <span class="cpf">&quot;spammodule.h&quot;</span><span class="cp"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">#define</span></code> is used to tell the header file that it is being included in the
exporting module, not a client module. Finally, the module's initialization
function must take care of initializing the C API pointer array:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_spam</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">PySpam_API</span><span class="p">[</span><span class="n">PySpam_API_pointers</span><span class="p">];</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">c_api_object</span><span class="p">;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spammodule</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* Initialize the C API pointer array */</span>
    <span class="n">PySpam_API</span><span class="p">[</span><span class="n">PySpam_System_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">PySpam_System</span><span class="p">;</span>

    <span class="cm">/* Create a Capsule containing the API pointer array&#39;s address */</span>
    <span class="n">c_api_object</span> <span class="o">=</span> <span class="n">PyCapsule_New</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">PySpam_API</span><span class="p">,</span> <span class="s">&quot;spam._C_API&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">c_api_object</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;_C_API&quot;</span><span class="p">,</span> <span class="n">c_api_object</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">PySpam_API</span></code> is declared <code class="docutils literal notranslate"><span class="pre">static</span></code>; otherwise the pointer
array would disappear when <code class="xref py py-func docutils literal notranslate"><span class="pre">PyInit_spam()</span></code> terminates!</p>
<p>The bulk of the work is in the header file <code class="file docutils literal notranslate"><span class="pre">spammodule.h</span></code>, which looks
like this:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef Py_SPAMMODULE_H</span>
<span class="cp">#define Py_SPAMMODULE_H</span>
<span class="cp">#ifdef __cplusplus</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="p">{</span>
<span class="cp">#endif</span>

<span class="cm">/* Header file for spammodule */</span>

<span class="cm">/* C API functions */</span>
<span class="cp">#define PySpam_System_NUM 0</span>
<span class="cp">#define PySpam_System_RETURN int</span>
<span class="cp">#define PySpam_System_PROTO (const char *command)</span>

<span class="cm">/* Total number of C API pointers */</span>
<span class="cp">#define PySpam_API_pointers 1</span>


<span class="cp">#ifdef SPAM_MODULE</span>
<span class="cm">/* This section is used when compiling spammodule.c */</span>

<span class="k">static</span> <span class="n">PySpam_System_RETURN</span> <span class="n">PySpam_System</span> <span class="n">PySpam_System_PROTO</span><span class="p">;</span>

<span class="cp">#else</span>
<span class="cm">/* This section is used in modules that use spammodule&#39;s API */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">**</span><span class="n">PySpam_API</span><span class="p">;</span>

<span class="cp">#define PySpam_System \</span>
<span class="cp"> (*(PySpam_System_RETURN (*)PySpam_System_PROTO) PySpam_API[PySpam_System_NUM])</span>

<span class="cm">/* Return -1 on error, 0 on success.</span>
<span class="cm"> * PyCapsule_Import will set an exception if there&#39;s an error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">import_spam</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PySpam_API</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">PyCapsule_Import</span><span class="p">(</span><span class="s">&quot;spam._C_API&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">PySpam_API</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef __cplusplus</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* !defined(Py_SPAMMODULE_H) */</span><span class="cp"></span>
</pre></div>
</div>
<p>All that a client module must do in order to have access to the function
<code class="xref c c-func docutils literal notranslate"><span class="pre">PySpam_System()</span></code> is to call the function (or rather macro)
<code class="xref c c-func docutils literal notranslate"><span class="pre">import_spam()</span></code> in its initialization function:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_client</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clientmodule</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">import_spam</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="cm">/* additional initialization can happen here */</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The main disadvantage of this approach is that the file <code class="file docutils literal notranslate"><span class="pre">spammodule.h</span></code> is
rather complicated. However, the basic structure is the same for each function
that is exported, so it has to be learned only once.</p>
<p>Finally it should be mentioned that Capsules offer additional functionality,
which is especially useful for memory allocation and deallocation of the pointer
stored in a Capsule. The details are described in the Python/C API Reference
Manual in the section <a class="reference internal" href="capsule.html#capsules" tppabs="https://docs.python.org/zh-cn/3/c-api/capsule.html#capsules"><span class="std std-ref">èƒ¶å›Š</span></a> and in the implementation of Capsules (files
<code class="file docutils literal notranslate"><span class="pre">Include/pycapsule.h</span></code> and <code class="file docutils literal notranslate"><span class="pre">Objects/pycapsule.c</span></code> in the Python source
code distribution).</p>
<p class="rubric">è„šæ³¨</p>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>An interface for this function already exists in the standard module <a class="reference internal" href="os.html#module-os" tppabs="https://docs.python.org/zh-cn/3/library/os.html#module-os" title="os: Miscellaneous operating system interfaces."><code class="xref py py-mod docutils literal notranslate"><span class="pre">os</span></code></a>
--- it was chosen as a simple and straightforward example.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>The metaphor of &quot;borrowing&quot; a reference is not completely correct: the owner
still has a copy of the reference.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td>Checking that the reference count is at least 1 <strong>does not work</strong> --- the
reference count itself could be in freed memory and may thus be reused for
another object!</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td>These guarantees don't hold when you use the &quot;old&quot; style calling convention ---
this is still found in much existing code.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="contents.html" tppabs="https://docs.python.org/zh-cn/3/contents.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">1. ä½¿ç”¨ C æˆ– C++ æ‰©å±• Python</a><ul>
<li><a class="reference internal" href="#a-simple-example">1.1. ä¸€ä¸ªç®€å•çš„ä¾‹å­</a></li>
<li><a class="reference internal" href="#intermezzo-errors-and-exceptions">1.2. å…³äºé”™è¯¯å’Œå¼‚å¸¸</a></li>
<li><a class="reference internal" href="#back-to-the-example">1.3. å›åˆ°ä¾‹å­</a></li>
<li><a class="reference internal" href="#the-module-s-method-table-and-initialization-function">1.4. æ¨¡å—æ–¹æ³•è¡¨å’Œåˆå§‹åŒ–å‡½æ•°</a></li>
<li><a class="reference internal" href="#compilation-and-linkage">1.5. ç¼–è¯‘å’Œé“¾æ¥</a></li>
<li><a class="reference internal" href="#calling-python-functions-from-c">1.6. åœ¨Cä¸­è°ƒç”¨Pythonå‡½æ•°</a></li>
<li><a class="reference internal" href="#extracting-parameters-in-extension-functions">1.7. æå–æ‰©å±•å‡½æ•°çš„å‚æ•°</a></li>
<li><a class="reference internal" href="#keyword-parameters-for-extension-functions">1.8. ç»™æ‰©å±•å‡½æ•°çš„å…³é”®å­—å‚æ•°</a></li>
<li><a class="reference internal" href="#building-arbitrary-values">1.9. æ„é€ ä»»æ„å€¼</a></li>
<li><a class="reference internal" href="#reference-counts">1.10. å¼•ç”¨è®¡æ•°</a><ul>
<li><a class="reference internal" href="#reference-counting-in-python">1.10.1. Reference Counting in Python</a></li>
<li><a class="reference internal" href="#ownership-rules">1.10.2. Ownership Rules</a></li>
<li><a class="reference internal" href="#thin-ice">1.10.3. Thin Ice</a></li>
<li><a class="reference internal" href="#null-pointers">1.10.4. NULL Pointers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#writing-extensions-in-c">1.11. Writing Extensions in C++</a></li>
<li><a class="reference internal" href="#providing-a-c-api-for-an-extension-module">1.12. Providing a C API for an Extension Module</a></li>
</ul>
</li>
</ul>

  <h4>ä¸Šä¸€ä¸ªä¸»é¢˜</h4>
  <p class="topless"><a href="index-8.html" tppabs="https://docs.python.org/zh-cn/3/extending/index.html"
                        title="ä¸Šä¸€ç« ">æ‰©å±•å’ŒåµŒå…¥ Python è§£é‡Šå™¨</a></p>
  <h4>ä¸‹ä¸€ä¸ªä¸»é¢˜</h4>
  <p class="topless"><a href="newtypes_tutorial.html" tppabs="https://docs.python.org/zh-cn/3/extending/newtypes_tutorial.html"
                        title="ä¸‹ä¸€ç« ">2. è‡ªå®šä¹‰æ‰©å±•ç±»å‹ï¼šæ•™ç¨‹</a></p>
  <div role="note" aria-label="source link">
    <h3>æœ¬é¡µ</h3>
    <ul class="this-page-menu">
      <li><a href="bugs.html" tppabs="https://docs.python.org/zh-cn/3/bugs.html">æäº¤ Bug</a></li>
      <li>
        <a href="javascript:if(confirm('https://github.com/python/cpython/blob/3.7/Doc/extending/extending.rst  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/python/cpython/blob/3.7/Doc/extending/extending.rst'" tppabs="https://github.com/python/cpython/blob/3.7/Doc/extending/extending.rst"
            rel="nofollow">æ˜¾ç¤ºæºä»£ç 
        </a>
      </li>
    </ul>
  </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>  
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>å¯¼èˆª</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" tppabs="https://docs.python.org/zh-cn/3/genindex.html" title="æ€»ç›®å½•"
             >ç´¢å¼•</a></li>
        <li class="right" >
          <a href="py-modindex.html" tppabs="https://docs.python.org/zh-cn/3/py-modindex.html" title="Python æ¨¡å—ç´¢å¼•"
             >æ¨¡å—</a> |</li>
        <li class="right" >
          <a href="newtypes_tutorial.html" tppabs="https://docs.python.org/zh-cn/3/extending/newtypes_tutorial.html" title="2. è‡ªå®šä¹‰æ‰©å±•ç±»å‹ï¼šæ•™ç¨‹"
             >ä¸‹ä¸€é¡µ</a> |</li>
        <li class="right" >
          <a href="index-8.html" tppabs="https://docs.python.org/zh-cn/3/extending/index.html" title="æ‰©å±•å’ŒåµŒå…¥ Python è§£é‡Šå™¨"
             >ä¸Šä¸€é¡µ</a> |</li>
        <li><img src="py.png" tppabs="https://docs.python.org/zh-cn/3/_static/py.png" alt=""
                 style="vertical-align: middle; margin-top: -1px"/></li>
        <li><a href="javascript:if(confirm('https://www.python.org/  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://www.python.org/'" tppabs="https://www.python.org/">Python</a> &#187;</li>
        <li>
          <span class="language_switcher_placeholder">zh_CN</span>
          <span class="version_switcher_placeholder">3.7.3</span>
          <a href="index-11.html" tppabs="https://docs.python.org/zh-cn/3/index.html">æ–‡æ¡£</a> &#187;
        </li>

          <li class="nav-item nav-item-1"><a href="index-8.html" tppabs="https://docs.python.org/zh-cn/3/extending/index.html" >æ‰©å±•å’ŒåµŒå…¥ Python è§£é‡Šå™¨</a> &#187;</li>
    <li class="right">
        

    <div class="inline-search" style="display: none" role="search">
        <form class="inline-search" action="https://docs.python.org/zh-cn/3/search.html" method="get">
          <input placeholder="å¿«é€Ÿæœç´¢" type="text" name="q" />
          <input type="submit" value="è½¬å‘" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </form>
    </div>
    <script type="text/javascript">$('.inline-search').show(0);</script>
         |
    </li>

      </ul>
    </div>  
    <div class="footer">
    &copy; <a href="copyright.html" tppabs="https://docs.python.org/zh-cn/3/copyright.html">ç‰ˆæƒæ‰€æœ‰</a> 2001-2019, Python Software Foundation.
    <br />
    Python è½¯ä»¶åŸºé‡‘ä¼šæ˜¯ä¸€ä¸ªéç›ˆåˆ©ç»„ç»‡ã€‚
    <a href="javascript:if(confirm('https://www.python.org/psf/donations/  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://www.python.org/psf/donations/'" tppabs="https://www.python.org/psf/donations/">è¯·æåŠ©ã€‚</a>
    <br />
    æœ€åæ›´æ–°äº 4æœˆ 22, 2019.
    <a href="bugs.html" tppabs="https://docs.python.org/zh-cn/3/bugs.html">å‘ç°äº†é—®é¢˜</a>ï¼Ÿ
    <br />
    ä½¿ç”¨<a href="javascript:if(confirm('http://sphinx.pocoo.org/  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='http://sphinx.pocoo.org/'" tppabs="http://sphinx.pocoo.org/">Sphinx</a>1.8.4 åˆ›å»ºã€‚
    </div>

  </body>
</html>