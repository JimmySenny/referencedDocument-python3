
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <title>1. ä½¿ç”¨ C æˆ– C++ æ‰©å±• Python &#8212; Python 3.8.2 æ–‡æ¡£</title>
    <link rel="stylesheet" href="pydoctheme.css" tppabs="https://docs.python.org/zh-cn/3/_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="pygments.css" tppabs="https://docs.python.org/zh-cn/3/_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="documentation_options.js" tppabs="https://docs.python.org/zh-cn/3/_static/documentation_options.js"></script>
    <script type="text/javascript" src="jquery.js" tppabs="https://docs.python.org/zh-cn/3/_static/jquery.js"></script>
    <script type="text/javascript" src="underscore.js" tppabs="https://docs.python.org/zh-cn/3/_static/underscore.js"></script>
    <script type="text/javascript" src="doctools.js" tppabs="https://docs.python.org/zh-cn/3/_static/doctools.js"></script>
    <script type="text/javascript" src="language_data.js" tppabs="https://docs.python.org/zh-cn/3/_static/language_data.js"></script>
    <script type="text/javascript" src="translations.js" tppabs="https://docs.python.org/zh-cn/3/_static/translations.js"></script>
    
    <script type="text/javascript" src="sidebar.js" tppabs="https://docs.python.org/zh-cn/3/_static/sidebar.js"></script>
    
    <link rel="search" type="application/opensearchdescription+xml"
          title="åœ¨ Python 3.8.2 æ–‡æ¡£ ä¸­æœç´¢"
          href="../_static/opensearch.xml"/>
    <link rel="author" title="å…³äºè¿™äº›æ–‡æ¡£" href="../about.html" />
    <link rel="index" title="ç´¢å¼•" href="../genindex.html" />
    <link rel="search" title="æœç´¢" href="../search.html" />
    <link rel="copyright" title="ç‰ˆæƒæ‰€æœ‰" href="../copyright.html" />
    <link rel="next" title="2. è‡ªå®šä¹‰æ‰©å±•ç±»å‹ï¼šæ•™ç¨‹" href="newtypes_tutorial.html" />
    <link rel="prev" title="æ‰©å±•å’ŒåµŒå…¥ Python è§£é‡Šå™¨" href="index.html" />
    <link rel="canonical" href="https://docs.python.org/3/extending/extending.html" />
    
      
      <script type="text/javascript" src="switchers.js" tppabs="https://docs.python.org/zh-cn/3/_static/switchers.js"></script>
      
    

    
    <style>
      @media only screen {
        table.full-width-table {
            width: 100%;
        }
      }
    </style>

    <link rel="shortcut icon" type="image/png" href="../_static/py.png" />
    
    <script type="text/javascript" src="copybutton.js" tppabs="https://docs.python.org/zh-cn/3/_static/copybutton.js"></script>
    
     


  </head><body>
  
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>å¯¼èˆª</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" tppabs="https://docs.python.org/zh-cn/3/genindex.html" title="æ€»ç›®å½•"
             accesskey="I">ç´¢å¼•</a></li>
        <li class="right" >
          <a href="py-modindex.html" tppabs="https://docs.python.org/zh-cn/3/py-modindex.html" title="Python æ¨¡å—ç´¢å¼•"
             >æ¨¡å—</a> |</li>
        <li class="right" >
          <a href="newtypes_tutorial.html" tppabs="https://docs.python.org/zh-cn/3/extending/newtypes_tutorial.html" title="2. è‡ªå®šä¹‰æ‰©å±•ç±»å‹ï¼šæ•™ç¨‹"
             accesskey="N">ä¸‹ä¸€é¡µ</a> |</li>
        <li class="right" >
          <a href="index-8.html" tppabs="https://docs.python.org/zh-cn/3/extending/index.html" title="æ‰©å±•å’ŒåµŒå…¥ Python è§£é‡Šå™¨"
             accesskey="P">ä¸Šä¸€é¡µ</a> |</li>

    <li><img src="py.png" tppabs="https://docs.python.org/zh-cn/3/_static/py.png" alt=""
             style="vertical-align: middle; margin-top: -1px"/></li>
    <li><a href="javascript:if(confirm('https://www.python.org/  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://www.python.org/'" tppabs="https://www.python.org/">Python</a> &#187;</li>
    

    <li>
      <span class="language_switcher_placeholder">zh_CN</span>
      <span class="version_switcher_placeholder">3.8.2</span>
      <a href="index-11.html" tppabs="https://docs.python.org/zh-cn/3/index.html">æ–‡æ¡£</a> &#187;
    </li>

          <li class="nav-item nav-item-1"><a href="index-8.html" tppabs="https://docs.python.org/zh-cn/3/extending/index.html" accesskey="U">æ‰©å±•å’ŒåµŒå…¥ Python è§£é‡Šå™¨</a> &#187;</li>
    <li class="right">
        

    <div class="inline-search" style="display: none" role="search">
        <form class="inline-search" action="https://docs.python.org/zh-cn/3/search.html" method="get">
          <input placeholder="å¿«é€Ÿæœç´¢" type="text" name="q" />
          <input type="submit" value="è½¬å‘" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </form>
    </div>
    <script type="text/javascript">$('.inline-search').show(0);</script>
         |
    </li>

      </ul>
    </div>    

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="extending-python-with-c-or-c">
<span id="extending-intro"></span><h1><span class="section-number">1. </span>ä½¿ç”¨ C æˆ– C++ æ‰©å±• Python<a class="headerlink" href="#extending-python-with-c-or-c" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h1>
<p>å¦‚æœä½ ä¼šç”¨ Cï¼Œæ·»åŠ æ–°çš„ Python å†…ç½®æ¨¡å—ä¼šå¾ˆç®€å•ã€‚ä»¥ä¸‹ä¸¤ä»¶ä¸èƒ½ç”¨ Python ç›´æ¥åšçš„äº‹ï¼Œå¯ä»¥é€šè¿‡ <em class="dfn">extension modules</em> æ¥å®ç°ï¼šå®ç°æ–°çš„å†…ç½®å¯¹è±¡ç±»å‹ï¼›è°ƒç”¨ C çš„åº“å‡½æ•°å’Œç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p>ä¸ºäº†æ”¯æŒæ‰©å±•ï¼ŒPython APIï¼ˆåº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼‰å®šä¹‰äº†ä¸€ç³»åˆ—å‡½æ•°ã€å®å’Œå˜é‡ï¼Œå¯ä»¥è®¿é—® Python è¿è¡Œæ—¶ç³»ç»Ÿçš„å¤§éƒ¨åˆ†å†…å®¹ã€‚Python çš„ API å¯ä»¥é€šè¿‡åœ¨ä¸€ä¸ª C æºæ–‡ä»¶ä¸­å¼•ç”¨ <code class="docutils literal notranslate"><span class="pre">&quot;Python.h&quot;</span></code> å¤´æ–‡ä»¶æ¥ä½¿ç”¨ã€‚</p>
<p>æ‰©å±•æ¨¡å—çš„ç¼–å†™æ–¹å¼å–å†³ä¸ä½ çš„ç›®çš„ä»¥åŠç³»ç»Ÿè®¾ç½®ï¼›ä¸‹é¢ç« èŠ‚ä¼šè¯¦ç»†ä»‹ç»ã€‚</p>
<div class="admonition note">
<p class="admonition-title">æ³¨è§£</p>
<p>Cæ‰©å±•æ¥å£ç‰¹æŒ‡CPythonï¼Œæ‰©å±•æ¨¡å—æ— æ³•åœ¨å…¶ä»–Pythonå®ç°ä¸Šå·¥ä½œã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåº”è¯¥é¿å…å†™Cæ‰©å±•ï¼Œæ¥ä¿æŒå¯ç§»æ¤æ€§ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ çš„ç”¨ä¾‹è°ƒç”¨äº†Cåº“æˆ–ç³»ç»Ÿè°ƒç”¨ï¼Œä½ åº”è¯¥è€ƒè™‘ä½¿ç”¨ <a class="reference internal" href="ctypes.html#module-ctypes" tppabs="https://docs.python.org/zh-cn/3/library/ctypes.html#module-ctypes" title="ctypes: A foreign function library for Python."><code class="xref py py-mod docutils literal notranslate"><span class="pre">ctypes</span></code></a> æ¨¡å—æˆ– <a class="reference external" href="javascript:if(confirm('https://cffi.readthedocs.io/  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://cffi.readthedocs.io/'" tppabs="https://cffi.readthedocs.io/">cffi</a> åº“ï¼Œè€Œä¸æ˜¯è‡ªå·±å†™Cä»£ç ã€‚è¿™äº›æ¨¡å—å…è®¸ä½ å†™Pythonä»£ç æ¥æ¥å£Cä»£ç ï¼Œè€Œä¸”å¯ç§»æ¤æ€§æ›´å¥½ã€‚ä¸çŸ¥ä¸ºä½•ç¼–è¯‘å¤±è´¥äº†ã€‚</p>
</div>
<div class="section" id="a-simple-example">
<span id="extending-simpleexample"></span><h2><span class="section-number">1.1. </span>ä¸€ä¸ªç®€å•çš„ä¾‹å­<a class="headerlink" href="#a-simple-example" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ‰©å±•æ¨¡å— <code class="docutils literal notranslate"><span class="pre">spam</span></code> (Monty Python ç²‰ä¸æœ€å–œæ¬¢çš„é£Ÿç‰©...) å¹¶ä¸”æƒ³è¦åˆ›å»ºå¯¹åº” C åº“å‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">system()</span></code> <a class="footnote-reference brackets" href="#id5" id="id1">1</a> çš„ Python æ¥å£ã€‚ è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªä»¥ null ç»“å°¾çš„å­—ç¬¦ä¸²å‚æ•°å¹¶è¿”å›ä¸€ä¸ªæ•´æ•°ã€‚ æˆ‘ä»¬å¸Œæœ›å¯ä»¥åœ¨ Python ä¸­ä»¥å¦‚ä¸‹æ–¹å¼è°ƒç”¨æ­¤å‡½æ•°:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">spam</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">status</span> <span class="o">=</span> <span class="n">spam</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ls -l&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª <code class="file docutils literal notranslate"><span class="pre">spammodule.c</span></code> æ–‡ä»¶ã€‚ï¼ˆä¼ ç»Ÿä¸Šï¼Œå¦‚æœä¸€ä¸ªæ¨¡å—å« <code class="docutils literal notranslate"><span class="pre">spam</span></code>ï¼Œåˆ™å¯¹åº”å®ç°å®ƒçš„ C æ–‡ä»¶å« <code class="file docutils literal notranslate"><span class="pre">spammodule.c</span></code>ï¼›å¦‚æœè¿™ä¸ªæ¨¡å—åå­—éå¸¸é•¿ï¼Œæ¯”å¦‚ <code class="docutils literal notranslate"><span class="pre">spammify</span></code>ï¼Œåˆ™è¿™ä¸ªæ¨¡å—çš„æ–‡ä»¶å¯ä»¥ç›´æ¥å« <code class="file docutils literal notranslate"><span class="pre">spammify.c</span></code>ã€‚ï¼‰</p>
<p>æ–‡ä»¶ä¸­å¼€å§‹çš„ä¸¤è¡Œæ˜¯ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<p>è¿™ä¼šå¯¼å…¥ Python APIï¼ˆå¦‚æœä½ å–œæ¬¢ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æè¿°æ¨¡å—ç›®æ ‡å’Œç‰ˆæƒä¿¡æ¯çš„æ³¨é‡Š)ã€‚</p>
<div class="admonition note">
<p class="admonition-title">æ³¨è§£</p>
<p>ç”±äºPythonå¯èƒ½ä¼šå®šä¹‰ä¸€äº›å½±å“æŸäº›ç³»ç»Ÿä¸Šæ ‡å‡†å¤´æ–‡ä»¶çš„é¢„å¤„ç†å™¨å®šä¹‰ï¼Œå› æ­¤åœ¨åŒ…å«ä»»ä½•æ ‡å‡†å¤´æ–‡ä»¶ä¹‹å‰ï¼Œæ‚¨*å¿…é¡»* include è¿™ä¸ªæ–‡ä»¶ï¼š<cite>Python.h</cite>ã€‚</p>
<p>æ¨èæ€»æ˜¯åœ¨ <code class="docutils literal notranslate"><span class="pre">Python.h</span></code> å‰å®šä¹‰ <code class="docutils literal notranslate"><span class="pre">PY_SSIZE_T_CLEAN</span></code> ã€‚æŸ¥çœ‹ <a class="reference internal" href="#parsetuple"><span class="std std-ref">æå–æ‰©å±•å‡½æ•°çš„å‚æ•°</span></a> æ¥äº†è§£è¿™ä¸ªå®çš„æ›´å¤šå†…å®¹ã€‚</p>
</div>
<p>æ‰€æœ‰ç”¨æˆ·å¯è§çš„ç¬¦å·éƒ½å®šä¹‰è‡ª <code class="file docutils literal notranslate"><span class="pre">Python.h</span></code> ä¸­ï¼Œå¹¶æ‹¥æœ‰å‰ç¼€ <code class="docutils literal notranslate"><span class="pre">Py</span></code> æˆ– <code class="docutils literal notranslate"><span class="pre">PY</span></code> ï¼Œé™¤äº†é‚£äº›å·²ç»å®šä¹‰åœ¨æ ‡å‡†å¤´æ–‡ä»¶çš„ã€‚ ä¸ºäº†æ–¹ä¾¿ï¼Œä»¥åŠç”±äºå…¶åœ¨ Python è§£é‡Šå™¨ä¸­å¹¿æ³›åº”ç”¨ï¼Œ<code class="docutils literal notranslate"><span class="pre">&quot;Python.h&quot;</span></code> ä¹ŸåŒ…å«äº†å°‘é‡æ ‡å‡†å¤´æ–‡ä»¶: <code class="docutils literal notranslate"><span class="pre">&lt;stdio.h&gt;</span></code>ï¼Œ<code class="docutils literal notranslate"><span class="pre">&lt;string.h&gt;</span></code>ï¼Œ<code class="docutils literal notranslate"><span class="pre">&lt;errno.h&gt;</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">&lt;stdlib.h&gt;</span></code>ã€‚ å¦‚æœåé¢çš„å¤´æ–‡ä»¶åœ¨ä½ çš„ç³»ç»Ÿä¸Šä¸å­˜åœ¨ï¼Œè¿˜ä¼šç›´æ¥å£°æ˜å‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code>ï¼Œ<code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> å’Œ <code class="xref c c-func docutils literal notranslate"><span class="pre">realloc()</span></code> ã€‚</p>
<p>ä¸‹é¢è¦åšçš„äº‹æ˜¯å°† C å‡½æ•°æ·»åŠ åˆ°æˆ‘ä»¬çš„æ‰©å±•æ¨¡å—ï¼Œå½“ Python è¡¨è¾¾å¼ <code class="docutils literal notranslate"><span class="pre">spam.system(string)</span></code> è¢«æ±‚å€¼æ—¶å‡½æ•°å°†è¢«è°ƒç”¨ï¼ˆæˆ‘ä»¬å¾ˆå¿«å°±ä¼šçœ‹åˆ°å®ƒæœ€ç»ˆæ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼‰:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">spam_system</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sts</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">sts</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="n">sts</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>æœ‰ä¸ªç›´æ¥ç¿»è¯‘å‚æ•°åˆ—è¡¨çš„æ–¹æ³•(ä¾‹å¦‚å•ç‹¬çš„ <code class="docutils literal notranslate"><span class="pre">â€œls-l&quot;</span></code>)åˆ°è¦ä¼ é€’ç»™Cå‡½æ•°çš„å‚æ•°ã€‚Cå‡½æ•°æ€»æ˜¯æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œé€šå¸¸åå­—æ˜¯ <em>self</em> å’Œ <em>args</em> ã€‚</p>
<p>å¯¹æ¨¡å—çº§å‡½æ•°ï¼Œ <em>self</em> å‚æ•°æŒ‡å‘æ¨¡å—å¯¹è±¡ï¼›å¯¹äºå¯¹è±¡å®ä¾‹åˆ™æŒ‡å‘æ–¹æ³•ã€‚</p>
<p><em>args</em> å‚æ•°æ˜¯æŒ‡å‘ä¸€ä¸ª Python çš„ tuple å¯¹è±¡çš„æŒ‡é’ˆï¼Œå…¶ä¸­åŒ…å«å‚æ•°ã€‚ æ¯ä¸ª tuple é¡¹å¯¹åº”ä¸€ä¸ªè°ƒç”¨å‚æ•°ã€‚ è¿™äº›å‚æ•°ä¹Ÿå…¨éƒ½æ˜¯ Python å¯¹è±¡ --- è¦åœ¨æˆ‘ä»¬çš„ C å‡½æ•°ä¸­ä½¿ç”¨å®ƒä»¬å°±éœ€è¦å…ˆå°†å…¶è½¬æ¢ä¸º C å€¼ã€‚ Python API ä¸­çš„å‡½æ•° <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> ä¼šæ£€æŸ¥å‚æ•°ç±»å‹å¹¶å°†å…¶è½¬æ¢ä¸º C å€¼ã€‚ å®ƒä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²ç¡®å®šéœ€è¦çš„å‚æ•°ç±»å‹ä»¥åŠå­˜å‚¨è¢«è½¬æ¢çš„å€¼çš„ C å˜é‡ç±»å‹ã€‚ ç»†èŠ‚å°†ç¨åè¯´æ˜ã€‚</p>
<p><a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> returns true (nonzero) if all arguments have the right
type and its components have been stored in the variables whose addresses are
passed.  It returns false (zero) if an invalid argument list was passed.  In the
latter case it also raises an appropriate exception so the calling function can
return <code class="docutils literal notranslate"><span class="pre">NULL</span></code> immediately (as we saw in the example).</p>
</div>
<div class="section" id="intermezzo-errors-and-exceptions">
<span id="extending-errors"></span><h2><span class="section-number">1.2. </span>å…³äºé”™è¯¯å’Œå¼‚å¸¸<a class="headerlink" href="#intermezzo-errors-and-exceptions" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>An important convention throughout the Python interpreter is the following: when
a function fails, it should set an exception condition and return an error value
(usually a <code class="docutils literal notranslate"><span class="pre">NULL</span></code> pointer).  Exceptions are stored in a static global variable
inside the interpreter; if this variable is <code class="docutils literal notranslate"><span class="pre">NULL</span></code> no exception has occurred.  A
second global variable stores the &quot;associated value&quot; of the exception (the
second argument to <a class="reference internal" href="simple_stmts.html#raise" tppabs="https://docs.python.org/zh-cn/3/reference/simple_stmts.html#raise"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">raise</span></code></a>).  A third variable contains the stack
traceback in case the error originated in Python code.  These three variables
are the C equivalents of the result in Python of <a class="reference internal" href="sys.html#sys.exc_info" tppabs="https://docs.python.org/zh-cn/3/library/sys.html#sys.exc_info" title="sys.exc_info"><code class="xref py py-meth docutils literal notranslate"><span class="pre">sys.exc_info()</span></code></a> (see the
section on module <a class="reference internal" href="sys.html#module-sys" tppabs="https://docs.python.org/zh-cn/3/library/sys.html#module-sys" title="sys: Access system-specific parameters and functions."><code class="xref py py-mod docutils literal notranslate"><span class="pre">sys</span></code></a> in the Python Library Reference).  It is important
to know about them to understand how errors are passed around.</p>
<p>Python APIä¸­å®šä¹‰äº†ä¸€äº›å‡½æ•°æ¥è®¾ç½®è¿™äº›å˜é‡ã€‚</p>
<p>æœ€å¸¸ç”¨çš„å°±æ˜¯ <a class="reference internal" href="exceptions-1.html#c.PyErr_SetString" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_SetString" title="PyErr_SetString"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_SetString()</span></code></a>ã€‚ å…¶å‚æ•°æ˜¯å¼‚å¸¸å¯¹è±¡å’Œ C å­—ç¬¦ä¸²ã€‚ å¼‚å¸¸å¯¹è±¡ä¸€èˆ¬æ˜¯åƒ <code class="xref c c-data docutils literal notranslate"><span class="pre">PyExc_ZeroDivisionError</span></code> è¿™æ ·çš„é¢„å®šä¹‰å¯¹è±¡ã€‚ C å­—ç¬¦ä¸²æŒ‡æ˜å¼‚å¸¸åŸå› ï¼Œå¹¶è¢«è½¬æ¢ä¸ºä¸€ä¸ª Python å­—ç¬¦ä¸²å¯¹è±¡å­˜å‚¨ä¸ºå¼‚å¸¸çš„â€œå…³è”å€¼â€ã€‚</p>
<p>å¦ä¸€ä¸ªæœ‰ç”¨çš„å‡½æ•°æ˜¯ <a class="reference internal" href="exceptions-1.html#c.PyErr_SetFromErrno" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_SetFromErrno" title="PyErr_SetFromErrno"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_SetFromErrno()</span></code></a> ï¼Œä»…æ¥å—ä¸€ä¸ªå¼‚å¸¸å¯¹è±¡ï¼Œå¼‚å¸¸æè¿°åŒ…å«åœ¨å…¨å±€å˜é‡ <code class="xref c c-data docutils literal notranslate"><span class="pre">errno</span></code> ä¸­ã€‚æœ€é€šç”¨çš„å‡½æ•°è¿˜æ˜¯ <a class="reference internal" href="exceptions-1.html#c.PyErr_SetObject" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_SetObject" title="PyErr_SetObject"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_SetObject()</span></code></a> ï¼ŒåŒ…å«ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸ºå¼‚å¸¸å¯¹è±¡å’Œå¼‚å¸¸æè¿°ã€‚ä½ ä¸éœ€è¦ä½¿ç”¨ <a class="reference internal" href="refcounting.html#c.Py_INCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_INCREF" title="Py_INCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_INCREF()</span></code></a> æ¥å¢åŠ ä¼ é€’åˆ°å…¶ä»–å‡½æ•°çš„å‚æ•°å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚</p>
<p>You can test non-destructively whether an exception has been set with
<a class="reference internal" href="exceptions-1.html#c.PyErr_Occurred" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_Occurred" title="PyErr_Occurred"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_Occurred()</span></code></a>.  This returns the current exception object, or <code class="docutils literal notranslate"><span class="pre">NULL</span></code>
if no exception has occurred.  You normally don't need to call
<a class="reference internal" href="exceptions-1.html#c.PyErr_Occurred" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_Occurred" title="PyErr_Occurred"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_Occurred()</span></code></a> to see whether an error occurred in a function call,
since you should be able to tell from the return value.</p>
<p>When a function <em>f</em> that calls another function <em>g</em> detects that the latter
fails, <em>f</em> should itself return an error value (usually <code class="docutils literal notranslate"><span class="pre">NULL</span></code> or <code class="docutils literal notranslate"><span class="pre">-1</span></code>).  It
should <em>not</em> call one of the <code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_*()</span></code> functions --- one has already
been called by <em>g</em>. <em>f</em>'s caller is then supposed to also return an error
indication to <em>its</em> caller, again <em>without</em> calling <code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_*()</span></code>, and so on
--- the most detailed cause of the error was already reported by the function
that first detected it.  Once the error reaches the Python interpreter's main
loop, this aborts the currently executing Python code and tries to find an
exception handler specified by the Python programmer.</p>
<p>ï¼ˆåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå½“æ¨¡å—ç¡®å®èƒ½å¤Ÿé€šè¿‡è°ƒç”¨å…¶å®ƒ <code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_*()</span></code> å‡½æ•°ç»™å‡ºæ›´åŠ è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯ï¼Œå¹¶ä¸”åœ¨è¿™äº›æƒ…å†µæ˜¯å¯ä»¥è¿™æ ·åšçš„ã€‚ ä½†æ˜¯æŒ‰ç…§ä¸€èˆ¬è§„åˆ™ï¼Œè¿™æ˜¯ä¸å¿…è¦çš„ï¼Œå¹¶å¯èƒ½å¯¼è‡´æœ‰å…³é”™è¯¯åŸå› çš„ä¿¡æ¯ä¸¢å¤±ï¼šå¤§å¤šæ•°æ“ä½œä¼šç”±äºç§ç§åŸå› è€Œå¤±è´¥ã€‚ï¼‰</p>
<p>æƒ³è¦å¿½ç•¥ç”±ä¸€ä¸ªå¤±è´¥çš„å‡½æ•°è°ƒç”¨æ‰€è®¾ç½®çš„å¼‚å¸¸ï¼Œå¼‚å¸¸æ¡ä»¶å¿…é¡»é€šè¿‡è°ƒç”¨ <a class="reference internal" href="exceptions-1.html#c.PyErr_Clear" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_Clear" title="PyErr_Clear"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_Clear()</span></code></a> æ˜¾å¼åœ°è¢«æ¸…é™¤ã€‚ C ä»£ç åº”å½“è°ƒç”¨ <a class="reference internal" href="exceptions-1.html#c.PyErr_Clear" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_Clear" title="PyErr_Clear"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_Clear()</span></code></a> çš„å”¯ä¸€æƒ…å†µæ˜¯å¦‚æœå®ƒä¸æƒ³å°†é”™è¯¯ä¼ ç»™è§£é‡Šå™¨è€Œæ˜¯æƒ³å®Œå…¨ç”±è‡ªå·±æ¥å¤„ç†å®ƒï¼ˆå¯èƒ½æ˜¯å°è¯•å…¶ä»–æ–¹æ³•ï¼Œæˆ–æ˜¯å‡è£…æ²¡æœ‰å‡ºé”™ï¼‰ã€‚</p>
<p>æ¯æ¬¡å¤±è´¥çš„ <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> è°ƒç”¨å¿…é¡»è½¬æ¢ä¸ºä¸€ä¸ªå¼‚å¸¸ã€‚ <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> (æˆ– <code class="xref c c-func docutils literal notranslate"><span class="pre">realloc()</span></code> )çš„ç›´æ¥è°ƒç”¨è€…å¿…é¡»è°ƒç”¨ <a class="reference internal" href="exceptions-1.html#c.PyErr_NoMemory" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_NoMemory" title="PyErr_NoMemory"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_NoMemory()</span></code></a> æ¥è¿”å›é”™è¯¯æ¥æç¤ºã€‚æ‰€æœ‰å¯¹è±¡åˆ›å»ºå‡½æ•°(ä¾‹å¦‚ <a class="reference internal" href="long.html#c.PyLong_FromLong" tppabs="https://docs.python.org/zh-cn/3/c-api/long.html#c.PyLong_FromLong" title="PyLong_FromLong"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyLong_FromLong()</span></code></a> )å·²ç»è¿™ä¹ˆåšäº†ï¼Œæ‰€ä»¥è¿™ä¸ªæç¤ºä»…ç”¨äºç›´æ¥è°ƒç”¨ <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> çš„æƒ…å†µã€‚</p>
<p>è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œé™¤äº† <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> ç­‰é‡è¦çš„ä¾‹å¤–ï¼Œè¿”å›æ•´æ•°çŠ¶æ€ç çš„å‡½æ•°é€šå¸¸éƒ½æ˜¯è¿”å›æ­£å€¼æˆ–é›¶æ¥è¡¨ç¤ºæˆåŠŸï¼Œè€Œä»¥ <code class="docutils literal notranslate"><span class="pre">-1</span></code> è¡¨ç¤ºå¤±è´¥ï¼Œå¦‚åŒ Unix ç³»ç»Ÿè°ƒç”¨ä¸€æ ·ã€‚</p>
<p>æœ€åï¼Œå½“ä½ è¿”å›ä¸€ä¸ªé”™è¯¯æŒ‡ç¤ºå™¨æ—¶è¦æ³¨æ„æ¸…ç†åƒåœ¾ï¼ˆé€šè¿‡ä¸ºä½ å·²ç»åˆ›å»ºçš„å¯¹è±¡æ‰§è¡Œ <a class="reference internal" href="refcounting.html#c.Py_XDECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_XDECREF" title="Py_XDECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_XDECREF()</span></code></a> æˆ– <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a> è°ƒç”¨ï¼‰ï¼</p>
<p>é€‰æ‹©å¼•å‘å“ªä¸ªå¼‚å¸¸å®Œå…¨å–å†³äºä½ çš„å–œå¥½ã€‚ æ‰€æœ‰å†…ç½®çš„ Python å¼‚å¸¸éƒ½æœ‰å¯¹åº”çš„é¢„å£°æ˜ C å¯¹è±¡ï¼Œä¾‹å¦‚ <code class="xref c c-data docutils literal notranslate"><span class="pre">PyExc_ZeroDivisionError</span></code>ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒä»¬ã€‚ å½“ç„¶ï¼Œä½ åº”å½“æ˜æ™ºåœ°é€‰æ‹©å¼‚å¸¸ --- ä¸è¦ä½¿ç”¨ <code class="xref c c-data docutils literal notranslate"><span class="pre">PyExc_TypeError</span></code> æ¥è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶æ— æ³•è¢«æ‰“å¼€ (é‚£å¤§æ¦‚åº”è¯¥ç”¨ <code class="xref c c-data docutils literal notranslate"><span class="pre">PyExc_IOError</span></code>)ã€‚ å¦‚æœå‚æ•°åˆ—è¡¨æœ‰é—®é¢˜ï¼Œ<a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> å‡½æ•°é€šå¸¸ä¼šå¼•å‘ <code class="xref c c-data docutils literal notranslate"><span class="pre">PyExc_TypeError</span></code>ã€‚ å¦‚æœä½ æƒ³è¦ä¸€ä¸ªå‚æ•°çš„å€¼å¿…é¡»å¤„äºç‰¹å®šèŒƒå›´ä¹‹å†…æˆ–å¿…é¡»æ»¡è¶³å…¶ä»–æ¡ä»¶ï¼Œåˆ™é€‚å®œä½¿ç”¨ <code class="xref c c-data docutils literal notranslate"><span class="pre">PyExc_ValueError</span></code>ã€‚</p>
<p>ä½ ä¹Ÿå¯ä»¥ä¸ºä½ çš„æ¨¡å—å®šä¹‰ä¸€ä¸ªå”¯ä¸€çš„æ–°å¼‚å¸¸ã€‚éœ€è¦åœ¨æ–‡ä»¶å‰éƒ¨å£°æ˜ä¸€ä¸ªé™æ€å¯¹è±¡å˜é‡ï¼Œå¦‚:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">SpamError</span><span class="p">;</span>
</pre></div>
</div>
<p>å¹¶ä¸”åœ¨ä½ çš„æ¨¡å—çš„åˆå§‹åŒ–å‡½æ•° (<code class="xref c c-func docutils literal notranslate"><span class="pre">PyInit_spam()</span></code>) ä¸­ä½¿ç”¨ä¸€ä¸ªå¼‚å¸¸å¯¹è±¡æ¥åˆå§‹åŒ–:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_spam</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spammodule</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">SpamError</span> <span class="o">=</span> <span class="n">PyErr_NewException</span><span class="p">(</span><span class="s">&quot;spam.error&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">Py_XINCREF</span><span class="p">(</span><span class="n">SpamError</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">SpamError</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">SpamError</span><span class="p">);</span>
        <span class="n">Py_CLEAR</span><span class="p">(</span><span class="n">SpamError</span><span class="p">);</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that the Python name for the exception object is <code class="xref py py-exc docutils literal notranslate"><span class="pre">spam.error</span></code>.  The
<a class="reference internal" href="exceptions-1.html#c.PyErr_NewException" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_NewException" title="PyErr_NewException"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_NewException()</span></code></a> function may create a class with the base class
being <a class="reference internal" href="exceptions.html#Exception" tppabs="https://docs.python.org/zh-cn/3/library/exceptions.html#Exception" title="Exception"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Exception</span></code></a> (unless another class is passed in instead of <code class="docutils literal notranslate"><span class="pre">NULL</span></code>),
described in <a class="reference internal" href="exceptions.html#bltin-exceptions" tppabs="https://docs.python.org/zh-cn/3/library/exceptions.html#bltin-exceptions"><span class="std std-ref">å†…ç½®å¼‚å¸¸</span></a>.</p>
<p>åŒæ ·æ³¨æ„çš„æ˜¯åˆ›å»ºç±»ä¿å­˜äº† <code class="xref c c-data docutils literal notranslate"><span class="pre">SpamError</span></code> çš„ä¸€ä¸ªå¼•ç”¨ï¼Œè¿™æ˜¯æœ‰æ„çš„ã€‚ä¸ºäº†é˜²æ­¢è¢«åƒåœ¾å›æ”¶æ‰ï¼Œå¦åˆ™ <code class="xref c c-data docutils literal notranslate"><span class="pre">SpamError</span></code> éšæ—¶ä¼šæˆä¸ºé‡æŒ‡é’ˆã€‚</p>
<p>ä¸€ä¼šè®¨è®º <code class="docutils literal notranslate"><span class="pre">PyMODINIT_FUNC</span></code> ä½œä¸ºå‡½æ•°è¿”å›ç±»å‹çš„ç”¨æ³•ã€‚</p>
<p><code class="xref py py-exc docutils literal notranslate"><span class="pre">spam.error</span></code> å¼‚å¸¸å¯ä»¥åœ¨æ‰©å±•æ¨¡å—ä¸­æŠ›å‡ºï¼Œé€šè¿‡ <a class="reference internal" href="exceptions-1.html#c.PyErr_SetString" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_SetString" title="PyErr_SetString"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_SetString()</span></code></a> å‡½æ•°è°ƒç”¨ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">spam_system</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sts</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">sts</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">SpamError</span><span class="p">,</span> <span class="s">&quot;System command failed&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="n">sts</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="back-to-the-example">
<span id="backtoexample"></span><h2><span class="section-number">1.3. </span>å›åˆ°ä¾‹å­<a class="headerlink" href="#back-to-the-example" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>å›åˆ°å‰é¢çš„ä¾‹å­ï¼Œä½ åº”è¯¥æ˜ç™½ä¸‹é¢çš„ä»£ç :</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</pre></div>
</div>
<p>It returns <code class="docutils literal notranslate"><span class="pre">NULL</span></code> (the error indicator for functions returning object pointers)
if an error is detected in the argument list, relying on the exception set by
<a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a>.  Otherwise the string value of the argument has been
copied to the local variable <code class="xref c c-data docutils literal notranslate"><span class="pre">command</span></code>.  This is a pointer assignment and
you are not supposed to modify the string to which it points (so in Standard C,
the variable <code class="xref c c-data docutils literal notranslate"><span class="pre">command</span></code> should properly be declared as <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span>
<span class="pre">*command</span></code>).</p>
<p>ä¸‹ä¸€ä¸ªè¯­å¥ä½¿ç”¨UNIXç³»ç»Ÿå‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">system()</span></code> ï¼Œä¼ é€’ç»™ä»–çš„å‚æ•°æ˜¯åˆšæ‰ä» <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> å–å‡ºçš„:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sts</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
</pre></div>
</div>
<p>æˆ‘ä»¬çš„ <code class="xref py py-func docutils literal notranslate"><span class="pre">spam.system()</span></code> å‡½æ•°å¿…é¡»è¿”å› <code class="xref c c-data docutils literal notranslate"><span class="pre">sts</span></code> çš„å€¼ä½œä¸ºPythonå¯¹è±¡ã€‚è¿™é€šè¿‡ä½¿ç”¨å‡½æ•° <a class="reference internal" href="long.html#c.PyLong_FromLong" tppabs="https://docs.python.org/zh-cn/3/c-api/long.html#c.PyLong_FromLong" title="PyLong_FromLong"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyLong_FromLong()</span></code></a> æ¥å®ç°ã€‚</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="nf">PyLong_FromLong</span><span class="p">(</span><span class="n">sts</span><span class="p">);</span>
</pre></div>
</div>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¼šè¿”å›ä¸€ä¸ªæ•´æ•°å¯¹è±¡ï¼Œ(è¿™ä¸ªå¯¹è±¡ä¼šåœ¨Pythonå †é‡Œé¢ç®¡ç†)ã€‚</p>
<p>å¦‚æœä½ çš„Cå‡½æ•°æ²¡æœ‰æœ‰ç”¨çš„è¿”å›å€¼(è¿”å› <code class="xref c c-type docutils literal notranslate"><span class="pre">void</span></code> çš„å‡½æ•°)ï¼Œåˆ™å¿…é¡»è¿”å› <code class="docutils literal notranslate"><span class="pre">None</span></code> ã€‚(ä½ å¯ä»¥ç”¨  <code class="xref c c-macro docutils literal notranslate"><span class="pre">Py_RETUN_NONE</span></code> å®æ¥å®Œæˆ):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
<span class="k">return</span> <span class="n">Py_None</span><span class="p">;</span>
</pre></div>
</div>
<p><a class="reference internal" href="none.html#c.Py_None" tppabs="https://docs.python.org/zh-cn/3/c-api/none.html#c.Py_None" title="Py_None"><code class="xref c c-data docutils literal notranslate"><span class="pre">Py_None</span></code></a> is the C name for the special Python object <code class="docutils literal notranslate"><span class="pre">None</span></code>.  It is a
genuine Python object rather than a <code class="docutils literal notranslate"><span class="pre">NULL</span></code> pointer, which means &quot;error&quot; in most
contexts, as we have seen.</p>
</div>
<div class="section" id="the-module-s-method-table-and-initialization-function">
<span id="methodtable"></span><h2><span class="section-number">1.4. </span>æ¨¡å—æ–¹æ³•è¡¨å’Œåˆå§‹åŒ–å‡½æ•°<a class="headerlink" href="#the-module-s-method-table-and-initialization-function" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>ä¸ºäº†å±•ç¤º <code class="xref c c-func docutils literal notranslate"><span class="pre">spam_system()</span></code> å¦‚ä½•è¢«Pythonç¨‹åºè°ƒç”¨ã€‚æŠŠå‡½æ•°å£°æ˜ä¸ºå¯ä»¥è¢«Pythonè°ƒç”¨ï¼Œéœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªæ–¹æ³•è¡¨ &quot;method table&quot; ã€‚</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">SpamMethods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="p">{</span><span class="s">&quot;system&quot;</span><span class="p">,</span>  <span class="n">spam_system</span><span class="p">,</span> <span class="n">METH_VARARGS</span><span class="p">,</span>
     <span class="s">&quot;Execute a shell command.&quot;</span><span class="p">},</span>
    <span class="p">...</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>        <span class="cm">/* Sentinel */</span>
<span class="p">};</span>
</pre></div>
</div>
<p>æ³¨æ„ç¬¬ä¸‰ä¸ªå‚æ•° ( <code class="docutils literal notranslate"><span class="pre">METH_VARARGS</span></code> ) ï¼Œè¿™ä¸ªæ ‡å¿—æŒ‡å®šä¼šä½¿ç”¨Cçš„è°ƒç”¨æƒ¯ä¾‹ã€‚å¯é€‰å€¼æœ‰  <code class="docutils literal notranslate"><span class="pre">METH_VARARGS</span></code> ã€ <code class="docutils literal notranslate"><span class="pre">METH_VARARGS</span> <span class="pre">|</span> <span class="pre">METH_KEYWORDS</span></code> ã€‚å€¼ <code class="docutils literal notranslate"><span class="pre">0</span></code> ä»£è¡¨ä½¿ç”¨ <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> çš„é™ˆæ—§å˜é‡ã€‚</p>
<p>å¦‚æœå•ç‹¬ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">METH_VARARGS</span></code> ï¼Œå‡½æ•°ä¼šç­‰å¾…Pythonä¼ æ¥tupleæ ¼å¼çš„å‚æ•°ï¼Œå¹¶æœ€ç»ˆä½¿ç”¨  <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> è¿›è¡Œè§£æã€‚</p>
<p><code class="xref py py-const docutils literal notranslate"><span class="pre">METH_KEYWORDS</span></code> å€¼è¡¨ç¤ºæ¥å—å…³é”®å­—å‚æ•°ã€‚è¿™ç§æƒ…å†µä¸‹Cå‡½æ•°éœ€è¦æ¥å—ç¬¬ä¸‰ä¸ª <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">*</span></code>  å¯¹è±¡ï¼Œè¡¨ç¤ºå­—å…¸å‚æ•°ï¼Œä½¿ç”¨ <a class="reference internal" href="arg.html#c.PyArg_ParseTupleAndKeywords" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTupleAndKeywords" title="PyArg_ParseTupleAndKeywords"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTupleAndKeywords()</span></code></a> æ¥è§£æå‡ºå‚æ•°ã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•è¡¨å¿…é¡»è¢«æ¨¡å—å®šä¹‰ç»“æ„æ‰€å¼•ç”¨ã€‚</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">spammodule</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span>
    <span class="s">&quot;spam&quot;</span><span class="p">,</span>   <span class="cm">/* name of module */</span>
    <span class="n">spam_doc</span><span class="p">,</span> <span class="cm">/* module documentation, may be NULL */</span>
    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>       <span class="cm">/* size of per-interpreter state of the module,</span>
<span class="cm">                 or -1 if the module keeps state in global variables. */</span>
    <span class="n">SpamMethods</span>
<span class="p">};</span>
</pre></div>
</div>
<p>è¿™ä¸ªç»“æ„ä½“å¿…é¡»ä¼ é€’ç»™è§£é‡Šå™¨çš„æ¨¡å—åˆå§‹åŒ–å‡½æ•°ã€‚åˆå§‹åŒ–å‡½æ•°å¿…é¡»å‘½åä¸º <code class="xref c c-func docutils literal notranslate"><span class="pre">PyInit_name()</span></code> ï¼Œå…¶ä¸­ <em>name</em> æ˜¯æ¨¡å—çš„åå­—ï¼Œå¹¶åº”è¯¥å®šä¹‰ä¸ºé <code class="docutils literal notranslate"><span class="pre">static</span></code> ï¼Œä¸”åœ¨æ¨¡å—æ–‡ä»¶é‡Œï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_spam</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spammodule</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>æ³¨æ„ PyMODINIT_FUNC å£°æ˜äº†å‡½æ•°ä½œä¸º <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">*</span></code> è¿”å›ç±»å‹ï¼Œå£°æ˜ä»»ä½•å¹³å°çš„é“¾æ¥ç”Ÿå‘½ï¼Œä»¥åŠç»™C++ç”Ÿå‘½å‡½æ•°çš„ <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">&quot;C&quot;</span></code> ã€‚</p>
<p>When the Python program imports module <code class="xref py py-mod docutils literal notranslate"><span class="pre">spam</span></code> for the first time,
<code class="xref c c-func docutils literal notranslate"><span class="pre">PyInit_spam()</span></code> is called. (See below for comments about embedding Python.)
It calls <a class="reference internal" href="module.html#c.PyModule_Create" tppabs="https://docs.python.org/zh-cn/3/c-api/module.html#c.PyModule_Create" title="PyModule_Create"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyModule_Create()</span></code></a>, which returns a module object, and
inserts built-in function objects into the newly created module based upon the
table (an array of <a class="reference internal" href="structures.html#c.PyMethodDef" tppabs="https://docs.python.org/zh-cn/3/c-api/structures.html#c.PyMethodDef" title="PyMethodDef"><code class="xref c c-type docutils literal notranslate"><span class="pre">PyMethodDef</span></code></a> structures) found in the module definition.
<a class="reference internal" href="module.html#c.PyModule_Create" tppabs="https://docs.python.org/zh-cn/3/c-api/module.html#c.PyModule_Create" title="PyModule_Create"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyModule_Create()</span></code></a> returns a pointer to the module object
that it creates.  It may abort with a fatal error for
certain errors, or return <code class="docutils literal notranslate"><span class="pre">NULL</span></code> if the module could not be initialized
satisfactorily. The init function must return the module object to its caller,
so that it then gets inserted into <code class="docutils literal notranslate"><span class="pre">sys.modules</span></code>.</p>
<p>å½“åµŒå…¥Pythonæ—¶ï¼Œ <code class="xref c c-func docutils literal notranslate"><span class="pre">PyInit_spam()</span></code> å‡½æ•°ä¸ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ï¼Œé™¤éæ”¾åœ¨ <code class="xref c c-data docutils literal notranslate"><span class="pre">PyImport_Inittab</span></code> è¡¨é‡Œã€‚è¦æ·»åŠ æ¨¡å—åˆ°åˆå§‹åŒ–è¡¨ï¼Œä½¿ç”¨ <a class="reference internal" href="import.html#c.PyImport_AppendInittab" tppabs="https://docs.python.org/zh-cn/3/c-api/import.html#c.PyImport_AppendInittab" title="PyImport_AppendInittab"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyImport_AppendInittab()</span></code></a> ï¼Œå¯é€‰çš„è·Ÿç€ä¸€ä¸ªæ¨¡å—çš„å¯¼å…¥ã€‚</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">program</span> <span class="o">=</span> <span class="n">Py_DecodeLocale</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">program</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Fatal error: cannot decode argv[0]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Add a built-in module, before Py_Initialize */</span>
    <span class="n">PyImport_AppendInittab</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="p">,</span> <span class="n">PyInit_spam</span><span class="p">);</span>

    <span class="cm">/* Pass argv[0] to the Python interpreter */</span>
    <span class="n">Py_SetProgramName</span><span class="p">(</span><span class="n">program</span><span class="p">);</span>

    <span class="cm">/* Initialize the Python interpreter.  Required. */</span>
    <span class="n">Py_Initialize</span><span class="p">();</span>

    <span class="cm">/* Optionally import the module; alternatively,</span>
<span class="cm">       import can be deferred until the embedded script</span>
<span class="cm">       imports it. */</span>
    <span class="n">PyImport_ImportModule</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="p">);</span>

    <span class="p">...</span>

    <span class="n">PyMem_RawFree</span><span class="p">(</span><span class="n">program</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">æ³¨è§£</p>
<p>è¦ä» <code class="docutils literal notranslate"><span class="pre">sys.modules</span></code> åˆ é™¤å®ä½“æˆ–å¯¼å…¥å·²ç¼–è¯‘æ¨¡å—åˆ°ä¸€ä¸ªè¿›ç¨‹é‡Œçš„å¤šä¸ªè§£é‡Šå™¨(æˆ–ä½¿ç”¨ <code class="xref c c-func docutils literal notranslate"><span class="pre">fork()</span></code> è€Œæ²¡ç”¨ <code class="xref c c-func docutils literal notranslate"><span class="pre">exec()</span></code> )ä¼šåœ¨ä¸€äº›æ‰©å±•æ¨¡å—ä¸Šäº§ç”Ÿé”™è¯¯ã€‚æ‰©å±•æ¨¡å—ä½œè€…å¯ä»¥åœ¨åˆå§‹åŒ–å†…éƒ¨æ•°æ®ç»“æ„æ—¶ç»™å‡ºè­¦å‘Šã€‚</p>
</div>
<p>æ›´å¤šå…³äºæ¨¡å—çš„ç°å®çš„ä¾‹å­åŒ…å«åœ¨Pythonæºç åŒ…çš„ <code class="file docutils literal notranslate"><span class="pre">Modules/xxmodule.c</span></code> ä¸­ã€‚è¿™äº›æ–‡ä»¶å¯ä»¥ç”¨ä½œä½ çš„ä»£ç æ¨¡æ¿ï¼Œæˆ–è€…å­¦ä¹ ã€‚è„šæœ¬ modulator.py åŒ…å«åœ¨æºç å‘è¡Œç‰ˆæˆ–Windowså®‰è£…ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªç®€å•çš„GUIï¼Œç”¨æ¥å£°æ˜éœ€è¦å®ç°çš„å‡½æ•°å’Œå¯¹è±¡ï¼Œå¹¶ä¸”å¯ä»¥ç”Ÿæˆä¾›å¡«å…¥çš„æ¨¡æ¿ã€‚è„šæœ¬åœ¨ Tools/modulator/ ç›®å½•ã€‚æŸ¥çœ‹READMEä»¥äº†è§£ç”¨æ³•ã€‚</p>
<div class="admonition note">
<p class="admonition-title">æ³¨è§£</p>
<p>ä¸åƒæˆ‘ä»¬çš„ <code class="docutils literal notranslate"><span class="pre">spam</span></code> ä¾‹å­ï¼Œ <code class="docutils literal notranslate"><span class="pre">xxmodule</span></code> ä½¿ç”¨äº† <em>å¤šé˜¶æ®µåˆå§‹åŒ–</em> (Python3.5å¼€å§‹å¼•å…¥)ï¼Œ <code class="docutils literal notranslate"><span class="pre">PyInit_spam</span></code> ä¼šè¿”å›ä¸€ä¸ª PyModuleDef ç»“æ„ä½“ï¼Œç„¶ååˆ›å»ºçš„æ¨¡å—æ”¾åˆ°å¯¼å…¥æœºåˆ¶ã€‚ç»†èŠ‚å‚è€ƒ <span class="target" id="index-6"></span><a class="pep reference external" href="javascript:if(confirm('https://www.python.org/dev/peps/pep-0489  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://www.python.org/dev/peps/pep-0489'" tppabs="https://www.python.org/dev/peps/pep-0489"><strong>PEP 489</strong></a> çš„å¤šé˜¶æ®µåˆå§‹åŒ–ã€‚</p>
</div>
</div>
<div class="section" id="compilation-and-linkage">
<span id="compilation"></span><h2><span class="section-number">1.5. </span>ç¼–è¯‘å’Œé“¾æ¥<a class="headerlink" href="#compilation-and-linkage" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>åœ¨ä½ èƒ½ä½¿ç”¨ä½ çš„æ–°å†™çš„æ‰©å±•ä¹‹å‰ï¼Œä½ è¿˜éœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼šä½¿ç”¨ Python ç³»ç»Ÿæ¥ç¼–è¯‘å’Œé“¾æ¥ã€‚å¦‚æœä½ ä½¿ç”¨åŠ¨æ€åŠ è½½ï¼Œè¿™å–å†³äºä½ ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿçš„åŠ¨æ€åŠ è½½æœºåˆ¶ï¼›æ›´å¤šä¿¡æ¯è¯·å‚è€ƒç¼–è¯‘æ‰©å±•æ¨¡å—çš„ç« èŠ‚ï¼ˆ <a class="reference internal" href="building.html#building" tppabs="https://docs.python.org/zh-cn/3/extending/building.html#building"><span class="std std-ref">æ„å»ºC/C++æ‰©å±•</span></a> ç« èŠ‚ï¼‰ï¼Œä»¥åŠåœ¨ Windows ä¸Šç¼–è¯‘éœ€è¦çš„é¢å¤–ä¿¡æ¯ï¼ˆ <a class="reference internal" href="windows-3.html#building-on-windows" tppabs="https://docs.python.org/zh-cn/3/extending/windows.html#building-on-windows"><span class="std std-ref">åœ¨Windowså¹³å°ç¼–è¯‘Cå’ŒC++æ‰©å±•</span></a> ç« èŠ‚ï¼‰ã€‚</p>
<p>å¦‚æœä½ ä¸ä½¿ç”¨åŠ¨æ€åŠ è½½ï¼Œæˆ–è€…æƒ³è¦è®©æ¨¡å—æ°¸ä¹…æ€§çš„ä½œä¸ºPythonè§£é‡Šå™¨çš„ä¸€éƒ¨åˆ†ï¼Œå°±å¿…é¡»ä¿®æ”¹é…ç½®è®¾ç½®ï¼Œå¹¶é‡æ–°æ„å»ºè§£é‡Šå™¨ã€‚å¹¸è¿çš„æ˜¯åœ¨Unixä¸Šå¾ˆç®€å•ï¼Œåªéœ€è¦æŠŠä½ çš„æ–‡ä»¶ ( <code class="file docutils literal notranslate"><span class="pre">spammodule.c</span></code> ä¸ºä¾‹) æ”¾åœ¨è§£å‹ç¼©æºç å‘è¡ŒåŒ…çš„ <code class="file docutils literal notranslate"><span class="pre">Modules/</span></code> ç›®å½•ä¸‹ï¼Œæ·»åŠ ä¸€è¡Œåˆ° <code class="file docutils literal notranslate"><span class="pre">Modules/Setup.local</span></code> æ¥æè¿°ä½ çš„æ–‡ä»¶ï¼š</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>spam spammodule.o
</pre></div>
</div>
<p>ç„¶ååœ¨é¡¶å±‚ç›®å½•è¿è¡Œ <strong class="program">make</strong> æ¥é‡æ–°æ„å»ºè§£é‡Šå™¨ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨ <code class="file docutils literal notranslate"><span class="pre">Modules/</span></code> å­ç›®å½•ä½¿ç”¨ <strong class="program">make</strong>ï¼Œä½†æ˜¯ä½ å¿…é¡»å…ˆé‡å»º <code class="file docutils literal notranslate"><span class="pre">Makefile</span></code> æ–‡ä»¶ï¼Œç„¶åè¿è¡Œ '<strong class="program">make</strong> Makefile' å‘½ä»¤ã€‚ï¼ˆä½ æ¯æ¬¡ä¿®æ”¹ <code class="file docutils literal notranslate"><span class="pre">Setup</span></code> æ–‡ä»¶éƒ½éœ€è¦è¿™æ ·æ“ä½œã€‚ï¼‰</p>
<p>å¦‚æœä½ çš„æ¨¡å—éœ€è¦é¢å¤–çš„é“¾æ¥ï¼Œè¿™äº›å†…å®¹å¯ä»¥åˆ—å‡ºåœ¨é…ç½®æ–‡ä»¶é‡Œï¼Œä¸¾ä¸ªå®ä¾‹ï¼š</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>spam spammodule.o -lX11
</pre></div>
</div>
</div>
<div class="section" id="calling-python-functions-from-c">
<span id="callingpython"></span><h2><span class="section-number">1.6. </span>åœ¨Cä¸­è°ƒç”¨Pythonå‡½æ•°<a class="headerlink" href="#calling-python-functions-from-c" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>è¿„ä»Šä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¸€ç›´æŠŠæ³¨æ„åŠ›é›†ä¸­äºè®©Pythonè°ƒç”¨Cå‡½æ•°ï¼Œå…¶å®åè¿‡æ¥ä¹Ÿå¾ˆæœ‰ç”¨ï¼Œå°±æ˜¯ç”¨Cè°ƒç”¨Pythonå‡½æ•°ã€‚è¿™åœ¨å›è°ƒå‡½æ•°ä¸­å°¤å…¶æœ‰ç”¨ã€‚å¦‚æœä¸€ä¸ªCæ¥å£ä½¿ç”¨å›è°ƒï¼Œé‚£ä¹ˆå°±è¦å®ç°è¿™ä¸ªå›è°ƒæœºåˆ¶ã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼ŒPythonè§£é‡Šå™¨æ˜¯æ¯”è¾ƒæ–¹ä¾¿å›è°ƒçš„ï¼Œå¹¶ç»™æ ‡å‡†Pythonå‡½æ•°æä¾›äº†æ ‡å‡†æ¥å£ã€‚(è¿™é‡Œå°±ä¸å†è¯¦è¿°è§£æPythonä»£ç ä½œä¸ºè¾“å…¥çš„æ–¹å¼ï¼Œå¦‚æœæœ‰å…´è¶£å¯ä»¥å‚è€ƒ <code class="file docutils literal notranslate"><span class="pre">Python/pythonmain.c</span></code> ä¸­çš„ <a class="reference internal" href="cmdline.html#cmdoption-c" tppabs="https://docs.python.org/zh-cn/3/using/cmdline.html#cmdoption-c"><code class="xref std std-option docutils literal notranslate"><span class="pre">-c</span></code></a> å‘½ä»¤ä»£ç ã€‚)</p>
<p>è°ƒç”¨Pythonå‡½æ•°ï¼Œé¦–å…ˆPythonç¨‹åºè¦ä¼ é€’Pythonå‡½æ•°å¯¹è±¡ã€‚åº”è¯¥æä¾›ä¸ªå‡½æ•°(æˆ–å…¶ä»–æ¥å£)æ¥å®ç°ã€‚å½“è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œç”¨å…¨å±€å˜é‡ä¿å­˜Pythonå‡½æ•°å¯¹è±¡çš„æŒ‡é’ˆï¼Œè¿˜è¦è°ƒç”¨ (<a class="reference internal" href="refcounting.html#c.Py_INCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_INCREF" title="Py_INCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_INCREF()</span></code></a>) æ¥å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå½“ç„¶ä¸ç”¨å…¨å±€å˜é‡ä¹Ÿæ²¡ä»€ä¹ˆå…³ç³»ã€‚ä¾‹å¦‚å¦‚ä¸‹:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">my_callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">my_set_callback</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">dummy</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;O:set_callback&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyCallable_Check</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_TypeError</span><span class="p">,</span> <span class="s">&quot;parameter must be callable&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Py_XINCREF</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>         <span class="cm">/* Add a reference to new callback */</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">my_callback</span><span class="p">);</span>  <span class="cm">/* Dispose of previous callback */</span>
        <span class="n">my_callback</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>       <span class="cm">/* Remember new callback */</span>
        <span class="cm">/* Boilerplate to return &quot;None&quot; */</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Py_None</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>è¿™ä¸ªå‡½æ•°å¿…é¡»ä½¿ç”¨ <a class="reference internal" href="structures.html#METH_VARARGS" tppabs="https://docs.python.org/zh-cn/3/c-api/structures.html#METH_VARARGS" title="METH_VARARGS"><code class="xref py py-const docutils literal notranslate"><span class="pre">METH_VARARGS</span></code></a> æ ‡å¿—æ³¨å†Œåˆ°è§£é‡Šå™¨ï¼Œè¿™åœ¨ <a class="reference internal" href="#methodtable"><span class="std std-ref">æ¨¡å—æ–¹æ³•è¡¨å’Œåˆå§‹åŒ–å‡½æ•°</span></a> ç« èŠ‚ä¼šæè¿°ã€‚ <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> å‡½æ•°åŠå…¶å‚æ•°çš„æ–‡æ¡£åœ¨ <a class="reference internal" href="#parsetuple"><span class="std std-ref">æå–æ‰©å±•å‡½æ•°çš„å‚æ•°</span></a> ã€‚</p>
<p>The macros <a class="reference internal" href="refcounting.html#c.Py_XINCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_XINCREF" title="Py_XINCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_XINCREF()</span></code></a> and <a class="reference internal" href="refcounting.html#c.Py_XDECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_XDECREF" title="Py_XDECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_XDECREF()</span></code></a> increment/decrement the
reference count of an object and are safe in the presence of <code class="docutils literal notranslate"><span class="pre">NULL</span></code> pointers
(but note that <em>temp</em> will not be  <code class="docutils literal notranslate"><span class="pre">NULL</span></code> in this context).  More info on them
in section <a class="reference internal" href="#refcounts"><span class="std std-ref">å¼•ç”¨è®¡æ•°</span></a>.</p>
<p id="index-1">Later, when it is time to call the function, you call the C function
<a class="reference internal" href="object.html#c.PyObject_CallObject" tppabs="https://docs.python.org/zh-cn/3/c-api/object.html#c.PyObject_CallObject" title="PyObject_CallObject"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyObject_CallObject()</span></code></a>.  This function has two arguments, both pointers to
arbitrary Python objects: the Python function, and the argument list.  The
argument list must always be a tuple object, whose length is the number of
arguments.  To call the Python function with no arguments, pass in <code class="docutils literal notranslate"><span class="pre">NULL</span></code>, or
an empty tuple; to call it with one argument, pass a singleton tuple.
<a class="reference internal" href="arg.html#c.Py_BuildValue" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.Py_BuildValue" title="Py_BuildValue"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_BuildValue()</span></code></a> returns a tuple when its format string consists of zero
or more format codes between parentheses.  For example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">arg</span><span class="p">;</span>
<span class="n">PyObject</span> <span class="o">*</span><span class="n">arglist</span><span class="p">;</span>
<span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">arg</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span>
<span class="p">...</span>
<span class="cm">/* Time to call the callback */</span>
<span class="n">arglist</span> <span class="o">=</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;(i)&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">PyObject_CallObject</span><span class="p">(</span><span class="n">my_callback</span><span class="p">,</span> <span class="n">arglist</span><span class="p">);</span>
<span class="n">Py_DECREF</span><span class="p">(</span><span class="n">arglist</span><span class="p">);</span>
</pre></div>
</div>
<p><a class="reference internal" href="object.html#c.PyObject_CallObject" tppabs="https://docs.python.org/zh-cn/3/c-api/object.html#c.PyObject_CallObject" title="PyObject_CallObject"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyObject_CallObject()</span></code></a> è¿”å›Pythonå¯¹è±¡æŒ‡é’ˆï¼Œè¿™ä¹Ÿæ˜¯Pythonå‡½æ•°çš„è¿”å›å€¼ã€‚ <a class="reference internal" href="object.html#c.PyObject_CallObject" tppabs="https://docs.python.org/zh-cn/3/c-api/object.html#c.PyObject_CallObject" title="PyObject_CallObject"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyObject_CallObject()</span></code></a> æ˜¯ä¸€ä¸ªå¯¹å…¶å‚æ•° &quot;å¼•ç”¨è®¡æ•°æ— å…³&quot; çš„å‡½æ•°ã€‚ä¾‹å­ä¸­æ–°çš„å…ƒç»„åˆ›å»ºç”¨äºå‚æ•°åˆ—è¡¨ï¼Œå¹¶ä¸”åœ¨  <a class="reference internal" href="object.html#c.PyObject_CallObject" tppabs="https://docs.python.org/zh-cn/3/c-api/object.html#c.PyObject_CallObject" title="PyObject_CallObject"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyObject_CallObject()</span></code></a> ä¹‹åç«‹å³ä½¿ç”¨äº† <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a> ã€‚</p>
<p><code class="xref c c-func docutils literal notranslate"><span class="pre">PyEval_CallObject()</span></code> çš„è¿”å›å€¼æ€»æ˜¯â€œæ–°â€çš„ï¼šè¦ä¹ˆæ˜¯ä¸€ä¸ªæ–°å»ºçš„å¯¹è±¡ï¼›è¦ä¹ˆæ˜¯å·²æœ‰å¯¹è±¡ï¼Œä½†å¢åŠ äº†å¼•ç”¨è®¡æ•°ã€‚æ‰€ä»¥é™¤éä½ æƒ³æŠŠç»“æœä¿å­˜åœ¨å…¨å±€å˜é‡ä¸­ï¼Œä½ éœ€è¦å¯¹è¿™ä¸ªå€¼ä½¿ç”¨ <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a>ï¼Œå³ä½¿ä½ å¯¹é‡Œé¢çš„å†…å®¹ï¼ˆç‰¹åˆ«ï¼ï¼‰ä¸æ„Ÿå…´è¶£ã€‚</p>
<p>Before you do this, however, it is important to check that the return value
isn't <code class="docutils literal notranslate"><span class="pre">NULL</span></code>.  If it is, the Python function terminated by raising an exception.
If the C code that called <a class="reference internal" href="object.html#c.PyObject_CallObject" tppabs="https://docs.python.org/zh-cn/3/c-api/object.html#c.PyObject_CallObject" title="PyObject_CallObject"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyObject_CallObject()</span></code></a> is called from Python, it
should now return an error indication to its Python caller, so the interpreter
can print a stack trace, or the calling Python code can handle the exception.
If this is not possible or desirable, the exception should be cleared by calling
<a class="reference internal" href="exceptions-1.html#c.PyErr_Clear" tppabs="https://docs.python.org/zh-cn/3/c-api/exceptions.html#c.PyErr_Clear" title="PyErr_Clear"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyErr_Clear()</span></code></a>.  For example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Pass error back */</span>
<span class="p">...</span><span class="n">use</span> <span class="n">result</span><span class="p">...</span>
<span class="n">Py_DECREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</pre></div>
</div>
<p>ä¾èµ–äºå…·ä½“çš„å›è°ƒå‡½æ•°ï¼Œä½ è¿˜è¦æä¾›ä¸€ä¸ªå‚æ•°åˆ—è¡¨åˆ° <code class="xref c c-func docutils literal notranslate"><span class="pre">PyEval_CallObject()</span></code> ã€‚åœ¨æŸäº›æƒ…å†µä¸‹å‚æ•°åˆ—è¡¨æ˜¯ç”±Pythonç¨‹åºæä¾›çš„ï¼Œé€šè¿‡æ¥å£å†ä¼ åˆ°å›è°ƒå‡½æ•°ã€‚è¿™æ ·å°±å¯ä»¥ä¸æ”¹å˜å½¢å¼ç›´æ¥ä¼ é€’ã€‚å¦å¤–ä¸€äº›æ—¶å€™ä½ è¦æ„é€ ä¸€ä¸ªæ–°çš„tupleæ¥ä¼ é€’å‚æ•°ã€‚æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ <a class="reference internal" href="arg.html#c.Py_BuildValue" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.Py_BuildValue" title="Py_BuildValue"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_BuildValue()</span></code></a> å‡½æ•°æ„é€ tupleã€‚ä¾‹å¦‚ï¼Œä½ è¦ä¼ é€’ä¸€ä¸ªäº‹ä»¶å¯¹è±¡æ—¶å¯ä»¥ç”¨:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span> <span class="o">*</span><span class="n">arglist</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">arglist</span> <span class="o">=</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;(l)&quot;</span><span class="p">,</span> <span class="n">eventcode</span><span class="p">);</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">PyObject_CallObject</span><span class="p">(</span><span class="n">my_callback</span><span class="p">,</span> <span class="n">arglist</span><span class="p">);</span>
<span class="n">Py_DECREF</span><span class="p">(</span><span class="n">arglist</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Pass error back */</span>
<span class="cm">/* Here maybe use the result */</span>
<span class="n">Py_DECREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</pre></div>
</div>
<p>æ³¨æ„ <code class="docutils literal notranslate"><span class="pre">Py_DECREF(arglist)</span></code> æ‰€åœ¨å¤„ä¼šç«‹å³è°ƒç”¨ï¼Œåœ¨é”™è¯¯æ£€æŸ¥ä¹‹å‰ã€‚å½“ç„¶è¿˜è¦æ³¨æ„ä¸€äº›å¸¸è§„çš„é”™è¯¯ï¼Œæ¯”å¦‚ <a class="reference internal" href="arg.html#c.Py_BuildValue" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.Py_BuildValue" title="Py_BuildValue"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_BuildValue()</span></code></a> å¯èƒ½ä¼šé­é‡å†…å­˜ä¸è¶³ç­‰ç­‰ã€‚</p>
<p>ä½ è¿˜éœ€è¦æ³¨æ„ï¼Œç”¨å…³é”®å­—å‚æ•°è°ƒç”¨ <a class="reference internal" href="object.html#c.PyObject_Call" tppabs="https://docs.python.org/zh-cn/3/c-api/object.html#c.PyObject_Call" title="PyObject_Call"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyObject_Call()</span></code></a> ï¼Œéœ€è¦æ”¯æŒæ™®é€šå‚æ•°å’Œå…³é”®å­—å‚æ•°ã€‚æœ‰å¦‚å¦‚ä¸Šä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <a class="reference internal" href="arg.html#c.Py_BuildValue" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.Py_BuildValue" title="Py_BuildValue"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_BuildValue()</span></code></a> æ¥æ„é€ å­—å…¸ã€‚</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span> <span class="o">*</span><span class="n">dict</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">dict</span> <span class="o">=</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;{s:i}&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">PyObject_Call</span><span class="p">(</span><span class="n">my_callback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dict</span><span class="p">);</span>
<span class="n">Py_DECREF</span><span class="p">(</span><span class="n">dict</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Pass error back */</span>
<span class="cm">/* Here maybe use the result */</span>
<span class="n">Py_DECREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="extracting-parameters-in-extension-functions">
<span id="parsetuple"></span><h2><span class="section-number">1.7. </span>æå–æ‰©å±•å‡½æ•°çš„å‚æ•°<a class="headerlink" href="#extracting-parameters-in-extension-functions" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p id="index-2">å‡½æ•° <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> çš„å£°æ˜å¦‚ä¸‹ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">PyArg_ParseTuple</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>
</pre></div>
</div>
<p>å‚æ•° <em>arg</em> å¿…é¡»æ˜¯ä¸€ä¸ªå…ƒç»„å¯¹è±¡ï¼ŒåŒ…å«ä» Python ä¼ é€’ç»™ C å‡½æ•°çš„å‚æ•°åˆ—è¡¨ã€‚<em>format</em> å‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªæ ¼å¼å­—ç¬¦ä¸²ï¼Œè¯­æ³•è¯·å‚è€ƒ Python C/API æ‰‹å†Œä¸­çš„ <a class="reference internal" href="arg.html#arg-parsing" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#arg-parsing"><span class="std std-ref">è¯­å¥è§£é‡ŠåŠå˜é‡ç¼–è¯‘</span></a>ã€‚å‰©ä½™å‚æ•°æ˜¯å„ä¸ªå˜é‡çš„åœ°å€ï¼Œç±»å‹è¦ä¸æ ¼å¼å­—ç¬¦ä¸²å¯¹åº”ã€‚</p>
<p>æ³¨æ„ <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> ä¼šæ£€æµ‹ä»–éœ€è¦çš„Pythonå‚æ•°ç±»å‹ï¼Œå´æ— æ³•æ£€æµ‹ä¼ é€’ç»™ä»–çš„Cå˜é‡åœ°å€ï¼Œå¦‚æœè¿™é‡Œå‡ºé”™äº†ï¼Œå¯èƒ½ä¼šåœ¨å†…å­˜ä¸­éšæœºå†™å…¥ä¸œè¥¿ï¼Œå°å¿ƒã€‚</p>
<p>æ³¨æ„ä»»ä½•ç”±è°ƒç”¨è€…æä¾›çš„Pythonå¯¹è±¡å¼•ç”¨æ˜¯ <em>å€Ÿæ¥çš„</em> å¼•ç”¨ï¼›ä¸è¦é€’å‡å®ƒä»¬çš„å¼•ç”¨è®¡æ•°ï¼</p>
<p>ä¸€äº›è°ƒç”¨çš„ä¾‹å­ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN  </span><span class="cm">/* Make &quot;s#&quot; use Py_ssize_t rather than int. */</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
<span class="kt">long</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
<span class="n">Py_ssize_t</span> <span class="n">size</span><span class="p">;</span>

<span class="n">ok</span> <span class="o">=</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span> <span class="cm">/* No arguments */</span>
    <span class="cm">/* Python call: f() */</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span> <span class="o">=</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span> <span class="cm">/* A string */</span>
    <span class="cm">/* Possible Python call: f(&#39;whoops!&#39;) */</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span> <span class="o">=</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;lls&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">k</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span> <span class="cm">/* Two longs and a string */</span>
    <span class="cm">/* Possible Python call: f(1, 2, &#39;three&#39;) */</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span> <span class="o">=</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;(ii)s#&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
    <span class="cm">/* A pair of ints and a string, whose size is also returned */</span>
    <span class="cm">/* Possible Python call: f((1, 2), &#39;three&#39;) */</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;r&quot;</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;s|si&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bufsize</span><span class="p">);</span>
    <span class="cm">/* A string, and optionally another string and an integer */</span>
    <span class="cm">/* Possible Python calls:</span>
<span class="cm">       f(&#39;spam&#39;)</span>
<span class="cm">       f(&#39;spam&#39;, &#39;w&#39;)</span>
<span class="cm">       f(&#39;spam&#39;, &#39;wb&#39;, 100000) */</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;((ii)(ii))(ii)&quot;</span><span class="p">,</span>
             <span class="o">&amp;</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bottom</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
    <span class="cm">/* A rectangle and a point */</span>
    <span class="cm">/* Possible Python call:</span>
<span class="cm">       f(((0, 0), (400, 300)), (10, 10)) */</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="n">Py_complex</span> <span class="n">c</span><span class="p">;</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;D:myfunction&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
    <span class="cm">/* a complex, also providing a function name for errors */</span>
    <span class="cm">/* Possible Python call: myfunction(1+2j) */</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="keyword-parameters-for-extension-functions">
<span id="parsetupleandkeywords"></span><h2><span class="section-number">1.8. </span>ç»™æ‰©å±•å‡½æ•°çš„å…³é”®å­—å‚æ•°<a class="headerlink" href="#keyword-parameters-for-extension-functions" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p id="index-3">å‡½æ•° <a class="reference internal" href="arg.html#c.PyArg_ParseTupleAndKeywords" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTupleAndKeywords" title="PyArg_ParseTupleAndKeywords"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTupleAndKeywords()</span></code></a> å£°æ˜å¦‚ä¸‹ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">PyArg_ParseTupleAndKeywords</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwdict</span><span class="p">,</span>
                                <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kwlist</span><span class="p">[],</span> <span class="p">...);</span>
</pre></div>
</div>
<p>The <em>arg</em> and <em>format</em> parameters are identical to those of the
<a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> function.  The <em>kwdict</em> parameter is the dictionary of
keywords received as the third parameter from the Python runtime.  The <em>kwlist</em>
parameter is a <code class="docutils literal notranslate"><span class="pre">NULL</span></code>-terminated list of strings which identify the parameters;
the names are matched with the type information from <em>format</em> from left to
right.  On success, <a class="reference internal" href="arg.html#c.PyArg_ParseTupleAndKeywords" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTupleAndKeywords" title="PyArg_ParseTupleAndKeywords"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTupleAndKeywords()</span></code></a> returns true, otherwise
it returns false and raises an appropriate exception.</p>
<div class="admonition note">
<p class="admonition-title">æ³¨è§£</p>
<p>åµŒå¥—çš„å…ƒç»„åœ¨ä½¿ç”¨å…³é”®å­—å‚æ•°æ—¶æ— æ³•ç”Ÿæ•ˆï¼Œä¸åœ¨ <em>kwlist</em> ä¸­çš„å…³é”®å­—å‚æ•°ä¼šå¯¼è‡´ <a class="reference internal" href="exceptions.html#TypeError" tppabs="https://docs.python.org/zh-cn/3/library/exceptions.html#TypeError" title="TypeError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">TypeError</span></code></a> å¼‚å¸¸ã€‚</p>
</div>
<p id="index-4">å¦‚ä¸‹æ˜¯ä½¿ç”¨å…³é”®å­—å‚æ•°çš„ä¾‹å­æ¨¡å—ï¼Œä½œè€…æ˜¯ Geoff Philbrick (<a class="reference external" href="mailto:phibrick&#37;&#52;&#48;hks&#46;com">phibrick<span>&#64;</span>hks<span>&#46;</span>com</a>):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN  </span><span class="cm">/* Make &quot;s#&quot; use Py_ssize_t rather than int. */</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">keywdarg_parrot</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">keywds</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">voltage</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="s">&quot;a stiff&quot;</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">action</span> <span class="o">=</span> <span class="s">&quot;voom&quot;</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;Norwegian Blue&quot;</span><span class="p">;</span>

    <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kwlist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;voltage&quot;</span><span class="p">,</span> <span class="s">&quot;state&quot;</span><span class="p">,</span> <span class="s">&quot;action&quot;</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTupleAndKeywords</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">keywds</span><span class="p">,</span> <span class="s">&quot;i|sss&quot;</span><span class="p">,</span> <span class="n">kwlist</span><span class="p">,</span>
                                     <span class="o">&amp;</span><span class="n">voltage</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;-- This parrot wouldn&#39;t %s if you put %i Volts through it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
           <span class="n">action</span><span class="p">,</span> <span class="n">voltage</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;-- Lovely plumage, the %s -- It&#39;s %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

    <span class="n">Py_RETURN_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">keywdarg_methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="cm">/* The cast of the function is necessary since PyCFunction values</span>
<span class="cm">     * only take two PyObject* parameters, and keywdarg_parrot() takes</span>
<span class="cm">     * three.</span>
<span class="cm">     */</span>
    <span class="p">{</span><span class="s">&quot;parrot&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)(</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="n">keywdarg_parrot</span><span class="p">,</span> <span class="n">METH_VARARGS</span> <span class="o">|</span> <span class="n">METH_KEYWORDS</span><span class="p">,</span>
     <span class="s">&quot;Print a lovely skit to standard output.&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>   <span class="cm">/* sentinel */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">keywdargmodule</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span>
    <span class="s">&quot;keywdarg&quot;</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">keywdarg_methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_keywdarg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keywdargmodule</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="building-arbitrary-values">
<span id="buildvalue"></span><h2><span class="section-number">1.9. </span>æ„é€ ä»»æ„å€¼<a class="headerlink" href="#building-arbitrary-values" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>è¿™ä¸ªå‡½æ•°ä¸ <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> å¾ˆç›¸ä¼¼ï¼Œå£°æ˜å¦‚ä¸‹ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span> <span class="o">*</span><span class="nf">Py_BuildValue</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>
</pre></div>
</div>
<p>æ¥å—ä¸€ä¸ªæ ¼å¼å­—ç¬¦ä¸²ï¼Œä¸ <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> ç›¸åŒï¼Œä½†æ˜¯å‚æ•°å¿…é¡»æ˜¯åŸå˜é‡çš„åœ°å€æŒ‡é’ˆ(è¾“å…¥ç»™å‡½æ•°ï¼Œè€Œéè¾“å‡º)ã€‚æœ€ç»ˆè¿”å›ä¸€ä¸ªPythonå¯¹è±¡é€‚åˆäºè¿”å›Cå‡½æ•°è°ƒç”¨ç»™Pythonä»£ç ã€‚</p>
<p>ä¸€ä¸ªä¸ <a class="reference internal" href="arg.html#c.PyArg_ParseTuple" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.PyArg_ParseTuple" title="PyArg_ParseTuple"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyArg_ParseTuple()</span></code></a> çš„ä¸åŒæ˜¯ï¼Œåé¢å¯èƒ½éœ€è¦çš„è¦æ±‚è¿”å›ä¸€ä¸ªå…ƒç»„(Pythonå‚æ•°é‡Œè¯¶åŒ…æ€»æ˜¯åœ¨å†…éƒ¨æè¿°ä¸ºå…ƒç»„)ï¼Œæ¯”å¦‚ç”¨äºä¼ é€’ç»™å…¶ä»–Pythonå‡½æ•°ä»¥å‚æ•°ã€‚ <a class="reference internal" href="arg.html#c.Py_BuildValue" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.Py_BuildValue" title="Py_BuildValue"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_BuildValue()</span></code></a> å¹¶ä¸æ€»æ˜¯ç”Ÿæˆå…ƒç»„ï¼Œåœ¨å¤šäº1ä¸ªå‚æ•°æ—¶ä¼šç”Ÿæˆå…ƒç»„ï¼Œè€Œå¦‚æœæ²¡æœ‰å‚æ•°åˆ™è¿”å› <code class="docutils literal notranslate"><span class="pre">None</span></code> ï¼Œä¸€ä¸ªå‚æ•°åˆ™ç›´æ¥è¿”å›è¯¥å‚æ•°çš„å¯¹è±¡ã€‚å¦‚æœè¦æ±‚å¼ºåˆ¶ç”Ÿæˆä¸€ä¸ªé•¿åº¦ä¸ºç©ºçš„å…ƒç»„ï¼Œæˆ–åŒ…å«ä¸€ä¸ªå…ƒç´ çš„å…ƒç»„ï¼Œéœ€è¦åœ¨æ ¼å¼å­—ç¬¦ä¸²ä¸­åŠ ä¸Šæ‹¬å·ã€‚</p>
<p>ä¾‹å­(å·¦ä¾§æ˜¯è°ƒç”¨ï¼Œå³ä¾§æ˜¯Pythonå€¼ç»“æœ)ï¼š</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Py_BuildValue(&quot;&quot;)                        None
Py_BuildValue(&quot;i&quot;, 123)                  123
Py_BuildValue(&quot;iii&quot;, 123, 456, 789)      (123, 456, 789)
Py_BuildValue(&quot;s&quot;, &quot;hello&quot;)              &#39;hello&#39;
Py_BuildValue(&quot;y&quot;, &quot;hello&quot;)              b&#39;hello&#39;
Py_BuildValue(&quot;ss&quot;, &quot;hello&quot;, &quot;world&quot;)    (&#39;hello&#39;, &#39;world&#39;)
Py_BuildValue(&quot;s#&quot;, &quot;hello&quot;, 4)          &#39;hell&#39;
Py_BuildValue(&quot;y#&quot;, &quot;hello&quot;, 4)          b&#39;hell&#39;
Py_BuildValue(&quot;()&quot;)                      ()
Py_BuildValue(&quot;(i)&quot;, 123)                (123,)
Py_BuildValue(&quot;(ii)&quot;, 123, 456)          (123, 456)
Py_BuildValue(&quot;(i,i)&quot;, 123, 456)         (123, 456)
Py_BuildValue(&quot;[i,i]&quot;, 123, 456)         [123, 456]
Py_BuildValue(&quot;{s:i,s:i}&quot;,
              &quot;abc&quot;, 123, &quot;def&quot;, 456)    {&#39;abc&#39;: 123, &#39;def&#39;: 456}
Py_BuildValue(&quot;((ii)(ii)) (ii)&quot;,
              1, 2, 3, 4, 5, 6)          (((1, 2), (3, 4)), (5, 6))
</pre></div>
</div>
</div>
<div class="section" id="reference-counts">
<span id="refcounts"></span><h2><span class="section-number">1.10. </span>å¼•ç”¨è®¡æ•°<a class="headerlink" href="#reference-counts" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>åœ¨C/C++è¯­è¨€ä¸­ï¼Œç¨‹åºå‘˜è´Ÿè´£åŠ¨æ€åˆ†é…å’Œå›æ”¶å †(heap)å½“ä¸­çš„å†…å­˜ã€‚åœ¨Cé‡Œï¼Œé€šè¿‡å‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> å’Œ <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> æ¥å®Œæˆã€‚åœ¨C++é‡Œæ˜¯æ“ä½œ <code class="docutils literal notranslate"><span class="pre">new</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">delete</span></code> æ¥å®ç°ç›¸åŒçš„åŠŸèƒ½ã€‚</p>
<p>æ¯ä¸ªç”± <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> åˆ†é…çš„å†…å­˜å—ï¼Œæœ€ç»ˆéƒ½è¦ç”± <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> é€€å›åˆ°å¯ç”¨å†…å­˜æ± é‡Œé¢å»ã€‚è€Œè°ƒç”¨ <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> çš„æ—¶æœºéå¸¸é‡è¦ï¼Œå¦‚æœä¸€ä¸ªå†…å­˜å—å¿˜äº† <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> åˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œè¿™å—å†…å­˜åœ¨ç¨‹åºç»“æŸå‰å°†æ— æ³•é‡æ–°ä½¿ç”¨ã€‚è¿™å«åš <em class="dfn">å†…å­˜æ³„æ¼</em> ã€‚è€Œå¦‚æœå¯¹åŒä¸€å†…å­˜å— <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> äº†ä»¥åï¼Œå¦å¤–ä¸€ä¸ªæŒ‡é’ˆå†æ¬¡è®¿é—®ï¼Œåˆ™å†æ¬¡ä½¿ç”¨ <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> å¤ç”¨è¿™å—å†…å­˜ä¼šå¯¼è‡´å†²çªã€‚è¿™å«åš <em class="dfn">é‡æŒ‡é’ˆ</em> ã€‚ç­‰åŒäºä½¿ç”¨æœªåˆå§‹åŒ–çš„æ•°æ®ï¼Œcore dumpï¼Œé”™è¯¯ç»“æœï¼Œç¥ç§˜çš„å´©æºƒç­‰ã€‚</p>
<p>å†…å­˜æ³„éœ²å¾€å¾€å‘ç”Ÿåœ¨ä¸€äº›å¹¶ä¸å¸¸è§çš„ä»£ç æµç¨‹ä¸Šé¢ã€‚æ¯”å¦‚ä¸€ä¸ªå‡½æ•°ç”³è¯·äº†å†…å­˜ä»¥åï¼Œåšäº†äº›è®¡ç®—ï¼Œç„¶åé‡Šæ”¾å†…å­˜å—ã€‚ç°åœ¨ä¸€äº›å¯¹å‡½æ•°çš„ä¿®æ”¹å¯èƒ½å¢åŠ å¯¹è®¡ç®—çš„æµ‹è¯•å¹¶æ£€æµ‹é”™è¯¯æ¡ä»¶ï¼Œç„¶åè¿‡æ—©çš„ä»å‡½æ•°è¿”å›äº†ã€‚è¿™å¾ˆå®¹æ˜“å¿˜è®°åœ¨é€€å‡ºå‰é‡Šæ”¾å†…å­˜ï¼Œç‰¹åˆ«æ˜¯åæœŸä¿®æ”¹çš„ä»£ç ã€‚è¿™ç§å†…å­˜æ³„æ¼ï¼Œä¸€æ—¦å¼•å…¥ï¼Œé€šå¸¸å¾ˆé•¿æ—¶é—´éƒ½éš¾ä»¥æ£€æµ‹åˆ°ï¼Œé”™è¯¯é€€å‡ºè¢«è°ƒç”¨çš„é¢‘åº¦è¾ƒä½ï¼Œè€Œç°ä»£ç”µè„‘åˆæœ‰éå¸¸å·¨å¤§çš„è™šæ‹Ÿå†…å­˜ï¼Œæ‰€ä»¥æ³„æ¼ä»…åœ¨é•¿æœŸè¿è¡Œæˆ–é¢‘ç¹è°ƒç”¨æ³„æ¼å‡½æ•°æ—¶æ‰ä¼šå˜å¾—æ˜æ˜¾ã€‚å› æ­¤ï¼Œæœ‰å¿…è¦é¿å…å†…å­˜æ³„æ¼ï¼Œé€šè¿‡ä»£ç è§„èŒƒä¼šç­–ç•¥æ¥æœ€å°åŒ–æ­¤ç±»é”™è¯¯ã€‚</p>
<p>Pythoné€šè¿‡ <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> å’Œ <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> åŒ…å«å¤§é‡çš„å†…å­˜åˆ†é…å’Œé‡Šæ”¾ï¼ŒåŒæ ·éœ€è¦é¿å…å†…å­˜æ³„æ¼å’Œé‡æŒ‡é’ˆã€‚ä»–é€‰æ‹©çš„æ–¹æ³•å°±æ˜¯ <em class="dfn">å¼•ç”¨è®¡æ•°</em> ã€‚å…¶åŸç†æ¯”è¾ƒç®€å•ï¼šæ¯ä¸ªå¯¹è±¡éƒ½åŒ…å«ä¸€ä¸ªè®¡æ•°å™¨ï¼Œè®¡æ•°å™¨çš„å¢å‡ä¸å¯¹è±¡å¼•ç”¨çš„å¢å‡ç›´æ¥ç›¸å…³ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œè¡¨ç¤ºå¯¹è±¡å·²ç»æ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰äº†ï¼Œå¯¹è±¡å°±å¯ä»¥åˆ é™¤äº†ã€‚</p>
<p>å¦ä¸€ä¸ªå«æ³•æ˜¯ <em class="dfn">è‡ªåŠ¨åƒåœ¾å›æ”¶</em> ã€‚(æœ‰æ—¶å¼•ç”¨è®¡æ•°ä¹Ÿè¢«çœ‹ä½œæ˜¯åƒåœ¾å›æ”¶ç­–ç•¥ï¼Œäºæ˜¯è¿™é‡Œçš„&quot;è‡ªåŠ¨&quot;ç”¨ä»¥åŒºåˆ†ä¸¤è€…)ã€‚è‡ªåŠ¨åƒåœ¾å›æ”¶çš„ä¼˜ç‚¹æ˜¯ç”¨æˆ·ä¸éœ€è¦æ˜ç¡®çš„è°ƒç”¨ <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> ã€‚(å¦ä¸€ä¸ªä¼˜ç‚¹æ˜¯æ”¹å–„é€Ÿåº¦æˆ–å†…å­˜ä½¿ç”¨ï¼Œç„¶è€Œè¿™å¹¶ä¸éš¾)ã€‚ç¼ºç‚¹æ˜¯å¯¹Cï¼Œæ²¡æœ‰å¯ç§»æ¤çš„è‡ªåŠ¨åƒåœ¾å›æ”¶å™¨ï¼Œè€Œå¼•ç”¨è®¡æ•°åˆ™å¯ä»¥å¯ç§»æ¤çš„å®ç°(åªè¦ <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> å’Œ <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> å‡½æ•°æ˜¯å¯ç”¨çš„ï¼Œè¿™ä¹Ÿæ˜¯Cæ ‡å‡†æ‹…ä¿çš„)ã€‚ä¹Ÿè®¸ä»¥åæœ‰ä¸€å¤©ä¼šå‡ºç°å¯ç§»æ¤çš„è‡ªåŠ¨åƒåœ¾å›æ”¶å™¨ï¼Œä½†åœ¨æ­¤å‰æˆ‘ä»¬å¿…é¡»ä¸å¼•ç”¨è®¡æ•°ä¸€èµ·å·¥ä½œã€‚</p>
<p>Pythonä½¿ç”¨ä¼ ç»Ÿçš„å¼•ç”¨è®¡æ•°å®ç°ï¼Œä¹Ÿæä¾›äº†å¾ªç¯ç›‘æµ‹å™¨ï¼Œç”¨ä»¥æ£€æµ‹å¼•ç”¨å¾ªç¯ã€‚è¿™ä½¿å¾—åº”ç”¨æ— éœ€æ‹…å¿ƒç›´æ¥æˆ–é—´æ¥çš„åˆ›å»ºäº†å¾ªç¯å¼•ç”¨ï¼Œè¿™æ˜¯å¼•ç”¨è®¡æ•°åƒåœ¾æ”¶é›†çš„ä¸€ä¸ªå¼±ç‚¹ã€‚å¼•ç”¨å¾ªç¯æ˜¯å¯¹è±¡(å¯èƒ½ç›´æ¥)çš„å¼•ç”¨äº†æœ¬èº«ï¼Œæ‰€ä»¥å¾ªç¯ä¸­çš„æ¯ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°éƒ½ä¸æ˜¯0ã€‚å…¸å‹çš„å¼•ç”¨è®¡æ•°å®ç°æ— æ³•å›æ”¶å¤„äºå¼•ç”¨å¾ªç¯ä¸­çš„å¯¹è±¡ï¼Œæˆ–è€…è¢«å¾ªç¯æ‰€å¼•ç”¨çš„å¯¹è±¡ï¼Œå“ªæ€•æ²¡æœ‰å¾ªç¯ä»¥å¤–çš„å¼•ç”¨äº†ã€‚</p>
<p>å¾ªç¯æ¢æµ‹å™¨å¯ä»¥æ£€æµ‹åƒåœ¾å¾ªç¯å¹¶å›æ”¶ã€‚ <a class="reference internal" href="gc.html#module-gc" tppabs="https://docs.python.org/zh-cn/3/library/gc.html#module-gc" title="gc: Interface to the cycle-detecting garbage collector."><code class="xref py py-mod docutils literal notranslate"><span class="pre">gc</span></code></a> æ¨¡å—æä¾›äº†æ–¹æ³•è¿è¡Œæ¢æµ‹å™¨ ( <a class="reference internal" href="gc.html#gc.collect" tppabs="https://docs.python.org/zh-cn/3/library/gc.html#gc.collect" title="gc.collect"><code class="xref py py-func docutils literal notranslate"><span class="pre">collect()</span></code></a> å‡½æ•°) ï¼Œè€Œä¸”å¯ä»¥åœ¨è¿è¡Œæ—¶é…ç½®ç¦ç”¨æ¢æµ‹å™¨ã€‚å¾ªç¯æ¢æµ‹å™¨è¢«å½“ä½œå¯é€‰ç»„ä»¶ï¼Œé»˜è®¤æ˜¯åŒ…å«çš„ï¼Œä¹Ÿå¯ä»¥åœ¨æ„å»ºæ—¶ç¦ç”¨ï¼Œåœ¨Unixå¹³å°(åŒ…æ‹¬Mac OS X)ä½¿ç”¨ <code class="xref std std-option docutils literal notranslate"><span class="pre">--without-cycle-gc</span></code> é€‰é¡¹åˆ° <strong class="program">configure</strong> è„šæœ¬ã€‚å¦‚æœå¾ªç¯æ¢æµ‹å™¨è¢«ç¦ç”¨ï¼Œ <a class="reference internal" href="gc.html#module-gc" tppabs="https://docs.python.org/zh-cn/3/library/gc.html#module-gc" title="gc: Interface to the cycle-detecting garbage collector."><code class="xref py py-mod docutils literal notranslate"><span class="pre">gc</span></code></a> æ¨¡å—å°±ä¸å¯ç”¨äº†ã€‚</p>
<div class="section" id="reference-counting-in-python">
<span id="refcountsinpython"></span><h3><span class="section-number">1.10.1. </span>Pythonä¸­çš„å¼•ç”¨è®¡æ•°<a class="headerlink" href="#reference-counting-in-python" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h3>
<p>æœ‰ä¸¤ä¸ªå® <code class="docutils literal notranslate"><span class="pre">Py_INCREF(x)</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">Py_DECREF(x)</span></code> ï¼Œä¼šå¤„ç†å¼•ç”¨è®¡æ•°çš„å¢å‡ã€‚ <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a> ä¹Ÿä¼šåœ¨å¼•ç”¨è®¡æ•°åˆ°è¾¾0æ—¶é‡Šæ”¾å¯¹è±¡ã€‚ä¸ºäº†çµæ´»ï¼Œå¹¶ä¸ä¼šç›´æ¥è°ƒç”¨ <code class="xref c c-func docutils literal notranslate"><span class="pre">free()</span></code> ï¼Œè€Œæ˜¯é€šè¿‡å¯¹è±¡çš„ <em class="dfn">ç±»å‹å¯¹è±¡</em> çš„å‡½æ•°æŒ‡é’ˆæ¥è°ƒç”¨ã€‚ä¸ºäº†è¿™ä¸ªç›®çš„(æˆ–å…¶ä»–çš„)ï¼Œæ¯ä¸ªå¯¹è±¡åŒæ—¶åŒ…å«ä¸€ä¸ªæŒ‡å‘è‡ªèº«ç±»å‹å¯¹è±¡çš„æŒ‡é’ˆã€‚</p>
<p>æœ€å¤§çš„é—®é¢˜ä¾æ—§ï¼šä½•æ—¶ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">Py_INCREF(x)</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">Py_DECREF(x)</span></code> ï¼Ÿæˆ‘ä»¬é¦–å…ˆå¼•å…¥ä¸€äº›æ¦‚å¿µã€‚æ²¡æœ‰äºº&quot;æ‹¥æœ‰&quot;ä¸€ä¸ªå¯¹è±¡ï¼Œä½ å¯ä»¥ <em class="dfn">æ‹¥æœ‰ä¸€ä¸ªå¼•ç”¨</em> åˆ°ä¸€ä¸ªå¯¹è±¡ã€‚ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å®šä¹‰ä¸ºæ‹¥æœ‰å¼•ç”¨çš„æ•°é‡ã€‚å¼•ç”¨çš„æ‹¥æœ‰è€…æœ‰è´£ä»»è°ƒç”¨ <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a> ï¼Œåœ¨å¼•ç”¨ä¸å†éœ€è¦æ—¶ã€‚å¼•ç”¨çš„æ‹¥æœ‰å…³ç³»å¯ä»¥è¢«ä¼ é€’ã€‚æœ‰ä¸‰ç§åŠæ³•æ¥å¤„ç½®æ‹¥æœ‰çš„å¼•ç”¨ï¼šä¼ é€’ã€å­˜å‚¨ã€è°ƒç”¨ <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a> ã€‚å¿˜è®°å¤„ç½®ä¸€ä¸ªæ‹¥æœ‰çš„å¼•ç”¨ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p>
<p>è¿˜å¯ä»¥ <em class="dfn">å€Ÿç”¨</em> <a class="footnote-reference brackets" href="#id6" id="id2">2</a> ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ã€‚å€Ÿç”¨çš„å¼•ç”¨ä¸åº”è¯¥è°ƒç”¨ <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a> ã€‚å€Ÿç”¨è€…å¿…é¡»ç¡®ä¿ä¸èƒ½æŒæœ‰å¯¹è±¡è¶…è¿‡æ‹¥æœ‰è€…å€Ÿå‡ºçš„æ—¶é—´ã€‚åœ¨æ‹¥æœ‰è€…å¤„ç½®å¯¹è±¡åä½¿ç”¨å€Ÿç”¨çš„å¼•ç”¨æ˜¯æœ‰é£é™©çš„ï¼Œåº”è¯¥å®Œå…¨é¿å… <a class="footnote-reference brackets" href="#id7" id="id3">3</a> ã€‚</p>
<p>å€Ÿç”¨ç›¸å¯¹äºå¼•ç”¨çš„ä¼˜ç‚¹æ˜¯ä½ æ— éœ€æ‹…å¿ƒæ•´æ¡è·¯å¾„ä¸Šä»£ç çš„å¼•ç”¨ï¼Œæˆ–è€…è¯´ï¼Œé€šè¿‡å€Ÿç”¨ä½ æ— éœ€æ‹…å¿ƒå†…å­˜æ³„æ¼çš„é£é™©ã€‚å€Ÿç”¨çš„ç¼ºç‚¹æ˜¯ä¸€äº›çœ‹èµ·æ¥æ­£ç¡®ä»£ç ä¸Šçš„å€Ÿç”¨å¯èƒ½ä¼šåœ¨æ‹¥æœ‰è€…å¤„ç½®åä½¿ç”¨å¯¹è±¡ã€‚</p>
<p>å€Ÿç”¨å¯ä»¥å˜ä¸ºæ‹¥æœ‰å¼•ç”¨ï¼Œé€šè¿‡è°ƒç”¨ <a class="reference internal" href="refcounting.html#c.Py_INCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_INCREF" title="Py_INCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_INCREF()</span></code></a> ã€‚è¿™ä¸ä¼šå½±å“å·²ç»å€Ÿå‡ºçš„æ‹¥æœ‰è€…çš„çŠ¶æ€ã€‚è¿™å›åˆ›å»ºä¸€ä¸ªæ–°çš„æ‹¥æœ‰å¼•ç”¨ï¼Œå¹¶ç»™äºˆå®Œå…¨çš„æ‹¥æœ‰è€…è´£ä»»(æ–°çš„æ‹¥æœ‰è€…å¿…é¡»æ°å½“çš„å¤„ç½®å¼•ç”¨ï¼Œå°±åƒä¹‹å‰çš„æ‹¥æœ‰è€…é‚£æ ·)ã€‚</p>
</div>
<div class="section" id="ownership-rules">
<span id="ownershiprules"></span><h3><span class="section-number">1.10.2. </span>æ‹¥æœ‰è§„åˆ™<a class="headerlink" href="#ownership-rules" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h3>
<p>å½“ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ä¼ é€’è¿›å‡ºä¸€ä¸ªå‡½æ•°æ—¶ï¼Œå‡½æ•°çš„æ¥å£åº”è¯¥æŒ‡å®šæ‹¥æœ‰å…³ç³»çš„ä¼ é€’æ˜¯å¦åŒ…å«å¼•ç”¨ã€‚</p>
<p>å¤§å¤šæ•°å‡½æ•°è¿”å›ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶ä¼ é€’å¼•ç”¨æ‹¥æœ‰å…³ç³»ã€‚é€šå¸¸ï¼Œæ‰€æœ‰åˆ›å»ºå¯¹è±¡çš„å‡½æ•°ï¼Œä¾‹å¦‚ <a class="reference internal" href="long.html#c.PyLong_FromLong" tppabs="https://docs.python.org/zh-cn/3/c-api/long.html#c.PyLong_FromLong" title="PyLong_FromLong"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyLong_FromLong()</span></code></a> å’Œ <a class="reference internal" href="arg.html#c.Py_BuildValue" tppabs="https://docs.python.org/zh-cn/3/c-api/arg.html#c.Py_BuildValue" title="Py_BuildValue"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_BuildValue()</span></code></a> ï¼Œä¼šä¼ é€’æ‹¥æœ‰å…³ç³»ç»™æ¥æ”¶è€…ã€‚å³ä¾¿æ˜¯å¯¹è±¡ä¸æ˜¯çœŸæ­£æ–°çš„ï¼Œä½ ä»ç„¶å¯ä»¥è·å¾—å¯¹è±¡çš„æ–°å¼•ç”¨ã€‚ä¸€ä¸ªå®ä¾‹æ˜¯ <a class="reference internal" href="long.html#c.PyLong_FromLong" tppabs="https://docs.python.org/zh-cn/3/c-api/long.html#c.PyLong_FromLong" title="PyLong_FromLong"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyLong_FromLong()</span></code></a> ç»´æŠ¤äº†ä¸€ä¸ªæµè¡Œå€¼çš„ç¼“å­˜ï¼Œå¹¶å¯ä»¥è¿”å›å·²ç¼“å­˜é¡¹ç›®çš„æ–°å¼•ç”¨ã€‚</p>
<p>å¾ˆå¤šå¦ä¸€ä¸ªå¯¹è±¡æå–å¯¹è±¡çš„å‡½æ•°ï¼Œä¹Ÿä¼šä¼ é€’å¼•ç”¨å…³ç³»ï¼Œä¾‹å¦‚ <a class="reference internal" href="object.html#c.PyObject_GetAttrString" tppabs="https://docs.python.org/zh-cn/3/c-api/object.html#c.PyObject_GetAttrString" title="PyObject_GetAttrString"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyObject_GetAttrString()</span></code></a> ã€‚è¿™é‡Œçš„æƒ…å†µä¸å¤Ÿæ¸…æ™°ï¼Œä¸€äº›ä¸å¤ªå¸¸ç”¨çš„ä¾‹ç¨‹æ˜¯ä¾‹å¤–çš„ <a class="reference internal" href="tuple.html#c.PyTuple_GetItem" tppabs="https://docs.python.org/zh-cn/3/c-api/tuple.html#c.PyTuple_GetItem" title="PyTuple_GetItem"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyTuple_GetItem()</span></code></a> ï¼Œ <a class="reference internal" href="list.html#c.PyList_GetItem" tppabs="https://docs.python.org/zh-cn/3/c-api/list.html#c.PyList_GetItem" title="PyList_GetItem"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyList_GetItem()</span></code></a> ï¼Œ <a class="reference internal" href="dict.html#c.PyDict_GetItem" tppabs="https://docs.python.org/zh-cn/3/c-api/dict.html#c.PyDict_GetItem" title="PyDict_GetItem"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyDict_GetItem()</span></code></a> ï¼Œ <a class="reference internal" href="dict.html#c.PyDict_GetItemString" tppabs="https://docs.python.org/zh-cn/3/c-api/dict.html#c.PyDict_GetItemString" title="PyDict_GetItemString"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyDict_GetItemString()</span></code></a> éƒ½æ˜¯è¿”å›ä»å…ƒç»„ã€åˆ—è¡¨ã€å­—å…¸é‡Œå€Ÿç”¨çš„å¼•ç”¨ã€‚</p>
<p>å‡½æ•° <a class="reference internal" href="import.html#c.PyImport_AddModule" tppabs="https://docs.python.org/zh-cn/3/c-api/import.html#c.PyImport_AddModule" title="PyImport_AddModule"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyImport_AddModule()</span></code></a> ä¹Ÿä¼šè¿”å›å€Ÿç”¨çš„å¼•ç”¨ï¼Œå“ªæ€•å¯èƒ½ä¼šè¿”å›åˆ›å»ºçš„å¯¹è±¡ï¼šè¿™ä¸ªå¯èƒ½å› ä¸ºä¸€ä¸ªæ‹¥æœ‰çš„å¼•ç”¨å¯¹è±¡æ˜¯å­˜å‚¨åœ¨ <code class="docutils literal notranslate"><span class="pre">sys.modules</span></code> é‡Œã€‚</p>
<p>å½“ä½ ä¼ é€’ä¸€ä¸ªå¯¹è±¡å¼•ç”¨åˆ°å¦ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œé€šå¸¸å‡½æ•°æ˜¯å€Ÿç”¨å‡ºå»çš„ã€‚å¦‚æœéœ€è¦å­˜å‚¨ï¼Œå°±ä½¿ç”¨ <a class="reference internal" href="refcounting.html#c.Py_INCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_INCREF" title="Py_INCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_INCREF()</span></code></a> æ¥å˜æˆç‹¬ç«‹çš„æ‹¥æœ‰è€…ã€‚è¿™ä¸ªè§„åˆ™æœ‰ä¸¤ä¸ªé‡è¦çš„ä¾‹å¤–ï¼š <a class="reference internal" href="tuple.html#c.PyTuple_SetItem" tppabs="https://docs.python.org/zh-cn/3/c-api/tuple.html#c.PyTuple_SetItem" title="PyTuple_SetItem"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyTuple_SetItem()</span></code></a> å’Œ <a class="reference internal" href="list.html#c.PyList_SetItem" tppabs="https://docs.python.org/zh-cn/3/c-api/list.html#c.PyList_SetItem" title="PyList_SetItem"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyList_SetItem()</span></code></a> ã€‚è¿™äº›å‡½æ•°æ¥å—ä¼ é€’æ¥çš„å¼•ç”¨å…³ç³»ï¼Œå“ªæ€•ä¼šå¤±è´¥ï¼(æ³¨æ„ <a class="reference internal" href="dict.html#c.PyDict_SetItem" tppabs="https://docs.python.org/zh-cn/3/c-api/dict.html#c.PyDict_SetItem" title="PyDict_SetItem"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyDict_SetItem()</span></code></a> åŠå…¶åŒç±»ä¸ä¼šæ¥å—å¼•ç”¨å…³ç³»ï¼Œä»–ä»¬æ˜¯&quot;æ­£å¸¸çš„&quot;)ã€‚</p>
<p>å½“ä¸€ä¸ªCå‡½æ•°è¢«Pythonè°ƒç”¨æ—¶ï¼Œä¼šä»è°ƒç”¨æ–¹ä¼ æ¥çš„å‚æ•°å€Ÿç”¨å¼•ç”¨ã€‚è°ƒç”¨è€…æ‹¥æœ‰å¯¹è±¡çš„å¼•ç”¨ï¼Œæ‰€ä»¥å€Ÿç”¨çš„å¼•ç”¨ç”Ÿå‘½å‘¨æœŸå¯ä»¥ä¿è¯åˆ°å‡½æ•°è¿”å›ã€‚åªè¦å½“å€Ÿç”¨çš„å¼•ç”¨éœ€è¦å­˜å‚¨æˆ–ä¼ é€’æ—¶ï¼Œå°±å¿…é¡»è½¬æ¢ä¸ºæ‹¥æœ‰çš„å¼•ç”¨ï¼Œé€šè¿‡è°ƒç”¨ <a class="reference internal" href="refcounting.html#c.Py_INCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_INCREF" title="Py_INCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_INCREF()</span></code></a> ã€‚</p>
<p>Pythonè°ƒç”¨ä»Cå‡½æ•°è¿”å›çš„å¯¹è±¡å¼•ç”¨æ—¶å¿…é¡»æ˜¯æ‹¥æœ‰çš„å¼•ç”¨---æ‹¥æœ‰å…³ç³»è¢«ä»å‡½æ•°ä¼ é€’ç»™è°ƒç”¨è€…ã€‚</p>
</div>
<div class="section" id="thin-ice">
<span id="thinice"></span><h3><span class="section-number">1.10.3. </span>å±é™©çš„è–„å†°<a class="headerlink" href="#thin-ice" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h3>
<p>æœ‰å°‘æ•°æƒ…å†µä¸‹ï¼Œå€Ÿç”¨çš„å¼•ç”¨çœ‹èµ·æ¥æ— å®³ï¼Œä½†å´å¯èƒ½å¯¼è‡´é—®é¢˜ã€‚è¿™é€šå¸¸æ˜¯å› ä¸ºè§£é‡Šå™¨çš„éšå¼è°ƒç”¨ï¼Œå¹¶å¯èƒ½å¯¼è‡´å¼•ç”¨æ‹¥æœ‰è€…å¤„ç½®è¿™ä¸ªå¼•ç”¨ã€‚</p>
<p>é¦–å…ˆéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æƒ…å†µæ˜¯ä½¿ç”¨ <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a> åˆ°ä¸€ä¸ªæ— å…³å¯¹è±¡ï¼Œè€Œè¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨æ˜¯å€Ÿç”¨è‡ªä¸€ä¸ªåˆ—è¡¨çš„å…ƒç´ ã€‚ä¸¾ä¸ªå®ä¾‹ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">bug</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="n">PyList_GetItem</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">PyList_SetItem</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="mi">0L</span><span class="p">));</span>
    <span class="n">PyObject_Print</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* BUG! */</span>
<span class="p">}</span>
</pre></div>
</div>
<p>è¿™ä¸ªå‡½æ•°é¦–å…ˆå€Ÿç”¨ä¸€ä¸ªå¼•ç”¨ <code class="docutils literal notranslate"><span class="pre">list[0]</span></code> ï¼Œç„¶åæ›¿æ¢ <code class="docutils literal notranslate"><span class="pre">list[1]</span></code> ä¸ºå€¼ <code class="docutils literal notranslate"><span class="pre">0</span></code> ï¼Œæœ€åæ‰“å°å€Ÿç”¨çš„å¼•ç”¨ã€‚çœ‹èµ·æ¥æ— å®³æ˜¯å§ï¼Œä½†å´ä¸æ˜¯ã€‚</p>
<p>æˆ‘ä»¬è·Ÿç€æ§åˆ¶æµè¿›å…¥ <a class="reference internal" href="list.html#c.PyList_SetItem" tppabs="https://docs.python.org/zh-cn/3/c-api/list.html#c.PyList_SetItem" title="PyList_SetItem"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyList_SetItem()</span></code></a> ã€‚åˆ—è¡¨æ‹¥æœ‰è€…å¼•ç”¨äº†å…¶æ‰€æœ‰æˆå‘˜ï¼Œæ‰€ä»¥å½“æˆå‘˜1è¢«æ›¿æ¢æ—¶ï¼Œå°±å¿…é¡»å¤„ç½®åŸæ¥çš„æˆå‘˜1ã€‚ç°åœ¨å‡è®¾åŸæ¥çš„æˆå‘˜1æ˜¯ç”¨æˆ·å®šä¹‰ç±»çš„å®ä¾‹ï¼Œä¸”å‡è®¾è¿™ä¸ªç±»å®šä¹‰äº† <a class="reference internal" href="datamodel.html#object.__del__" tppabs="https://docs.python.org/zh-cn/3/reference/datamodel.html#object.__del__" title="object.__del__"><code class="xref py py-meth docutils literal notranslate"><span class="pre">__del__()</span></code></a> æ–¹æ³•ã€‚å¦‚æœè¿™ä¸ªç±»å®ä¾‹çš„å¼•ç”¨è®¡æ•°æ˜¯1ï¼Œé‚£ä¹ˆå¤„ç½®åŠ¨ä½œå°±ä¼šè°ƒç”¨ <a class="reference internal" href="datamodel.html#object.__del__" tppabs="https://docs.python.org/zh-cn/3/reference/datamodel.html#object.__del__" title="object.__del__"><code class="xref py py-meth docutils literal notranslate"><span class="pre">__del__()</span></code></a> æ–¹æ³•ã€‚</p>
<p>æ—¢ç„¶æ˜¯Pythonå†™çš„ï¼Œ <a class="reference internal" href="datamodel.html#object.__del__" tppabs="https://docs.python.org/zh-cn/3/reference/datamodel.html#object.__del__" title="object.__del__"><code class="xref py py-meth docutils literal notranslate"><span class="pre">__del__()</span></code></a> æ–¹æ³•å¯ä»¥æ‰§è¡Œä»»æ„Pythonä»£ç ã€‚æ˜¯å¦å¯èƒ½åœ¨ <code class="xref c c-func docutils literal notranslate"><span class="pre">bug()</span></code> çš„ <code class="docutils literal notranslate"><span class="pre">item</span></code> åºŸæ­¢å¼•ç”¨å‘¢ï¼Œæ˜¯çš„ã€‚å‡è®¾åˆ—è¡¨ä¼ é€’åˆ° <code class="xref c c-func docutils literal notranslate"><span class="pre">bug()</span></code> ä¼šè¢« <a class="reference internal" href="datamodel.html#object.__del__" tppabs="https://docs.python.org/zh-cn/3/reference/datamodel.html#object.__del__" title="object.__del__"><code class="xref py py-meth docutils literal notranslate"><span class="pre">__del__()</span></code></a> æ–¹æ³•æ‰€è®¿é—®ï¼Œå°±å¯ä»¥æ‰§è¡Œä¸€ä¸ªè¯­å¥æ¥å®ç° <code class="docutils literal notranslate"><span class="pre">del</span> <span class="pre">list[0]</span></code> ï¼Œç„¶åå‡è®¾è¿™æ˜¯æœ€åä¸€ä¸ªå¯¹å¯¹è±¡çš„å¼•ç”¨ï¼Œå°±éœ€è¦é‡Šæ”¾å†…å­˜ï¼Œä»è€Œä½¿å¾— <code class="docutils literal notranslate"><span class="pre">item</span></code> æ— æ•ˆåŒ–ã€‚</p>
<p>è§£å†³æ–¹æ³•æ˜¯ï¼Œå½“ä½ çŸ¥é“äº†é—®é¢˜çš„æ ¹æºï¼Œå°±å®¹æ˜“äº†ï¼šä¸´æ—¶å¢åŠ å¼•ç”¨è®¡æ•°ã€‚æ­£ç¡®ç‰ˆæœ¬çš„å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">no_bug</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="n">PyList_GetItem</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
    <span class="n">PyList_SetItem</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="mi">0L</span><span class="p">));</span>
    <span class="n">PyObject_Print</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>è¿™æ˜¯ä¸ªçœŸå®çš„æ•…äº‹ã€‚ä¸€ä¸ªæ—§ç‰ˆæœ¬çš„PythonåŒ…å«äº†è¿™ä¸ªbugçš„å˜ç§ï¼Œè€Œä¸€äº›äººèŠ±è´¹äº†å¤§é‡æ—¶é—´åœ¨Cè°ƒè¯•å™¨ä¸Šå»å¯»æ‰¾ä¸ºä»€ä¹ˆ <a class="reference internal" href="datamodel.html#object.__del__" tppabs="https://docs.python.org/zh-cn/3/reference/datamodel.html#object.__del__" title="object.__del__"><code class="xref py py-meth docutils literal notranslate"><span class="pre">__del__()</span></code></a> æ–¹æ³•ä¼šå¤±è´¥ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜çš„ç¬¬äºŒç§æƒ…å†µæ˜¯å€Ÿç”¨çš„å¼•ç”¨æ¶‰åŠçº¿ç¨‹çš„å˜ç§ã€‚é€šå¸¸ï¼ŒPythonè§£é‡Šå™¨é‡Œå¤šä¸ªçº¿ç¨‹æ— æ³•è¿›å…¥å¯¹æ–¹çš„è·¯å¾„ï¼Œå› ä¸ºæœ‰ä¸ªå…¨å±€é”ä¿æŠ¤ç€Pythonæ•´ä¸ªå¯¹è±¡ç©ºé—´ã€‚ä½†å¯ä»¥ä½¿ç”¨å® <a class="reference internal" href="init.html#c.Py_BEGIN_ALLOW_THREADS" tppabs="https://docs.python.org/zh-cn/3/c-api/init.html#c.Py_BEGIN_ALLOW_THREADS" title="Py_BEGIN_ALLOW_THREADS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">Py_BEGIN_ALLOW_THREADS</span></code></a> æ¥ä¸´æ—¶é‡Šæ”¾è¿™ä¸ªé”ï¼Œé‡æ–°è·å–é”ç”¨ <a class="reference internal" href="init.html#c.Py_END_ALLOW_THREADS" tppabs="https://docs.python.org/zh-cn/3/c-api/init.html#c.Py_END_ALLOW_THREADS" title="Py_END_ALLOW_THREADS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">Py_END_ALLOW_THREADS</span></code></a> ã€‚è¿™é€šå¸¸å›´ç»•åœ¨é˜»å¡I/Oè°ƒç”¨å¤–ï¼Œä½¿å¾—å…¶ä»–çº¿ç¨‹å¯ä»¥åœ¨ç­‰å¾…I/OæœŸé—´ä½¿ç”¨å¤„ç†å™¨ã€‚æ˜¾ç„¶ï¼Œå¦‚ä¸‹å‡½æ•°ä¼šè·Ÿä¹‹å‰é‚£ä¸ªæœ‰ä¸€æ ·çš„é—®é¢˜ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">bug</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="n">PyList_GetItem</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="p">...</span><span class="n">some</span> <span class="n">blocking</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">call</span><span class="p">...</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="n">PyObject_Print</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* BUG! */</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="null-pointers">
<span id="nullpointers"></span><h3><span class="section-number">1.10.4. </span>NULLæŒ‡é’ˆ<a class="headerlink" href="#null-pointers" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h3>
<p>In general, functions that take object references as arguments do not expect you
to pass them <code class="docutils literal notranslate"><span class="pre">NULL</span></code> pointers, and will dump core (or cause later core dumps) if
you do so.  Functions that return object references generally return <code class="docutils literal notranslate"><span class="pre">NULL</span></code> only
to indicate that an exception occurred.  The reason for not testing for <code class="docutils literal notranslate"><span class="pre">NULL</span></code>
arguments is that functions often pass the objects they receive on to other
function --- if each function were to test for <code class="docutils literal notranslate"><span class="pre">NULL</span></code>, there would be a lot of
redundant tests and the code would run more slowly.</p>
<p>It is better to test for <code class="docutils literal notranslate"><span class="pre">NULL</span></code> only at the &quot;source:&quot; when a pointer that may be
<code class="docutils literal notranslate"><span class="pre">NULL</span></code> is received, for example, from <code class="xref c c-func docutils literal notranslate"><span class="pre">malloc()</span></code> or from a function that
may raise an exception.</p>
<p>The macros <a class="reference internal" href="refcounting.html#c.Py_INCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_INCREF" title="Py_INCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_INCREF()</span></code></a> and <a class="reference internal" href="refcounting.html#c.Py_DECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_DECREF" title="Py_DECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_DECREF()</span></code></a> do not check for <code class="docutils literal notranslate"><span class="pre">NULL</span></code>
pointers --- however, their variants <a class="reference internal" href="refcounting.html#c.Py_XINCREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_XINCREF" title="Py_XINCREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_XINCREF()</span></code></a> and <a class="reference internal" href="refcounting.html#c.Py_XDECREF" tppabs="https://docs.python.org/zh-cn/3/c-api/refcounting.html#c.Py_XDECREF" title="Py_XDECREF"><code class="xref c c-func docutils literal notranslate"><span class="pre">Py_XDECREF()</span></code></a>
do.</p>
<p>The macros for checking for a particular object type (<code class="docutils literal notranslate"><span class="pre">Pytype_Check()</span></code>) don't
check for <code class="docutils literal notranslate"><span class="pre">NULL</span></code> pointers --- again, there is much code that calls several of
these in a row to test an object against various different expected types, and
this would generate redundant tests.  There are no variants with <code class="docutils literal notranslate"><span class="pre">NULL</span></code>
checking.</p>
<p>The C function calling mechanism guarantees that the argument list passed to C
functions (<code class="docutils literal notranslate"><span class="pre">args</span></code> in the examples) is never <code class="docutils literal notranslate"><span class="pre">NULL</span></code> --- in fact it guarantees
that it is always a tuple <a class="footnote-reference brackets" href="#id8" id="id4">4</a>.</p>
<p>It is a severe error to ever let a <code class="docutils literal notranslate"><span class="pre">NULL</span></code> pointer &quot;escape&quot; to the Python user.</p>
</div>
</div>
<div class="section" id="writing-extensions-in-c">
<span id="cplusplus"></span><h2><span class="section-number">1.11. </span>åœ¨C++ä¸­ç¼–å†™æ‰©å±•<a class="headerlink" href="#writing-extensions-in-c" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>è¿˜å¯ä»¥åœ¨C++ä¸­ç¼–å†™æ‰©å±•æ¨¡å—ï¼Œåªæ˜¯æœ‰äº›é™åˆ¶ã€‚å¦‚æœä¸»ç¨‹åº(Pythonè§£é‡Šå™¨)æ˜¯ä½¿ç”¨Cç¼–è¯‘å™¨æ¥ç¼–è¯‘å’Œé“¾æ¥çš„ï¼Œå…¨å±€æˆ–é™æ€å¯¹è±¡çš„æ„é€ å™¨å°±ä¸èƒ½ä½¿ç”¨ã€‚è€Œå¦‚æœæ˜¯C++ç¼–è¯‘å™¨æ¥é“¾æ¥çš„å°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚å‡½æ•°ä¼šè¢«Pythonè§£é‡Šå™¨è°ƒç”¨(é€šå¸¸å°±æ˜¯æ¨¡å—åˆå§‹åŒ–å‡½æ•°)å¿…é¡»å£°æ˜ä¸º <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">&quot;C&quot;</span></code> ã€‚è€Œæ˜¯å¦åœ¨ <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">&quot;C&quot;</span> <span class="pre">{...}</span></code> é‡ŒåŒ…å«Pythonå¤´æ–‡ä»¶åˆ™ä¸æ˜¯é‚£ä¹ˆé‡è¦ï¼Œå› ä¸ºå¦‚æœå®šä¹‰äº†ç¬¦å· <code class="docutils literal notranslate"><span class="pre">__cplusplus</span></code> åˆ™å·²ç»æ˜¯è¿™ä¹ˆå£°æ˜çš„äº†(æ‰€æœ‰ç°ä»£C++ç¼–è¯‘å™¨éƒ½ä¼šå®šä¹‰è¿™ä¸ªç¬¦å·)ã€‚</p>
</div>
<div class="section" id="providing-a-c-api-for-an-extension-module">
<span id="using-capsules"></span><h2><span class="section-number">1.12. </span>ç»™æ‰©å±•æ¨¡å—æä¾›C API<a class="headerlink" href="#providing-a-c-api-for-an-extension-module" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">Â¶</a></h2>
<p>å¾ˆå¤šæ‰©å±•æ¨¡å—æä¾›äº†æ–°çš„å‡½æ•°å’Œç±»å‹ä¾›Pythonä½¿ç”¨ï¼Œä½†æœ‰æ—¶æ‰©å±•æ¨¡å—é‡Œçš„ä»£ç ä¹Ÿå¯ä»¥è¢«å…¶ä»–æ‰©å±•æ¨¡å—ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ‰©å±•æ¨¡å—å¯ä»¥å®ç°ä¸€ä¸ªç±»å‹ &quot;collection&quot; çœ‹èµ·æ¥æ˜¯æ²¡æœ‰é¡ºåºçš„ã€‚å°±åƒæ˜¯Pythonåˆ—è¡¨ç±»å‹ï¼Œæ‹¥æœ‰C APIå…è®¸æ‰©å±•æ¨¡å—æ¥åˆ›å»ºå’Œç»´æŠ¤åˆ—è¡¨ï¼Œè¿™ä¸ªæ–°çš„é›†åˆç±»å‹å¯ä»¥æœ‰ä¸€å †Cå‡½æ•°ç”¨äºç»™å…¶ä»–æ‰©å±•æ¨¡å—ç›´æ¥ä½¿ç”¨ã€‚</p>
<p>å¼€å§‹çœ‹èµ·æ¥å¾ˆç®€å•ï¼šåªéœ€è¦ç¼–å†™å‡½æ•°(æ— éœ€å£°æ˜ä¸º <code class="docutils literal notranslate"><span class="pre">static</span></code> )ï¼Œæä¾›æ°å½“çš„å¤´æ–‡ä»¶ï¼Œä»¥åŠC APIçš„æ–‡æ¡£ã€‚å®é™…ä¸Šåœ¨æ‰€æœ‰æ‰©å±•æ¨¡å—éƒ½æ˜¯é™æ€é“¾æ¥åˆ°Pythonè§£é‡Šå™¨æ—¶ä¹Ÿæ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œçš„ã€‚å½“æ¨¡å—ä»¥å…±äº«åº“é“¾æ¥æ—¶ï¼Œä¸€ä¸ªæ¨¡å—ä¸­çš„ç¬¦å·å®šä¹‰å¯¹å¦ä¸€ä¸ªæ¨¡å—ä¸å¯è§ã€‚å¯è§çš„ç»†èŠ‚ä¾èµ–äºæ“ä½œç³»ç»Ÿï¼Œä¸€äº›ç³»ç»Ÿçš„Pythonè§£é‡Šå™¨ä½¿ç”¨å…¨å±€å‘½åç©ºé—´(ä¾‹å¦‚Windows)ï¼Œæœ‰äº›åˆ™åœ¨é“¾æ¥æ—¶éœ€è¦ä¸€ä¸ªä¸¥æ ¼çš„å·²å¯¼å…¥ç¬¦å·åˆ—è¡¨(ä¸€ä¸ªä¾‹å­æ˜¯AIX)ï¼Œæˆ–è€…æä¾›å¯é€‰çš„ä¸åŒç­–ç•¥(å¦‚Unixç³»åˆ—)ã€‚å³ä¾¿æ˜¯ç¬¦å·æ˜¯å…¨å±€å¯è§çš„ï¼Œä½ è¦è°ƒç”¨çš„æ¨¡å—ä¹Ÿå¯èƒ½å°šæœªåŠ è½½ã€‚</p>
<p>å¯ç§»æ¤æ€§éœ€è¦ä¸èƒ½å¯¹ç¬¦å·å¯è§æ€§åšä»»ä½•å‡è®¾ã€‚è¿™æ„å‘³ç€æ‰©å±•æ¨¡å—é‡Œçš„æ‰€æœ‰ç¬¦å·éƒ½åº”è¯¥å£°æ˜ä¸º <code class="docutils literal notranslate"><span class="pre">static</span></code> ï¼Œé™¤äº†æ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°ï¼Œæ¥é¿å…ä¸å…¶ä»–æ‰©å±•æ¨¡å—çš„å‘½åå†²çª(åœ¨æ®µè½ <a class="reference internal" href="#methodtable"><span class="std std-ref">æ¨¡å—æ–¹æ³•è¡¨å’Œåˆå§‹åŒ–å‡½æ•°</span></a> ä¸­è®¨è®º) ã€‚è¿™æ„å‘³ç€ç¬¦å·åº”è¯¥ <em>å¿…é¡»</em> é€šè¿‡å…¶ä»–å¯¼å‡ºæ–¹å¼æ¥ä¾›å…¶ä»–æ‰©å±•æ¨¡å—è®¿é—®ã€‚</p>
<p>Pythonæä¾›äº†ä¸€ä¸ªç‰¹åˆ«çš„æœºåˆ¶æ¥ä¼ é€’Cçº§åˆ«ä¿¡æ¯(æŒ‡é’ˆ)ï¼Œä»ä¸€ä¸ªæ‰©å±•æ¨¡å—åˆ°å¦ä¸€ä¸ªï¼šCapsulesã€‚ä¸€ä¸ªCapsuleæ˜¯ä¸€ä¸ªPythonæ•°æ®ç±»å‹ï¼Œä¼šä¿å­˜æŒ‡é’ˆ( <code class="xref c c-type docutils literal notranslate"><span class="pre">void</span> <span class="pre">*</span></code> )ã€‚Capsuleåªèƒ½é€šè¿‡å…¶C APIæ¥åˆ›å»ºå’Œè®¿é—®ï¼Œä½†å¯ä»¥åƒå…¶ä»–Pythonå¯¹è±¡ä¸€æ ·çš„ä¼ é€’ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ªæ‰©å±•æ¨¡å—å‘½åç©ºé—´çš„åå­—ã€‚å…¶ä»–æ‰©å±•æ¨¡å—å¯ä»¥å¯¼å…¥è¿™ä¸ªæ¨¡å—ï¼Œè·å–è¿™ä¸ªåå­—çš„å€¼ï¼Œç„¶åä»Capsuleè·å–æŒ‡é’ˆã€‚</p>
<p>Capsuleå¯ä»¥ç”¨å¤šç§æ–¹å¼å¯¼å‡ºC APIç»™æ‰©å±•æ¨¡å—ã€‚æ¯ä¸ªå‡½æ•°å¯ä»¥ç”¨è‡ªå·±çš„Capsuleï¼Œæˆ–è€…æ‰€æœ‰C APIæŒ‡é’ˆå¯ä»¥å­˜å‚¨åœ¨ä¸€ä¸ªæ•°ç»„é‡Œï¼Œæ•°ç»„åœ°å€å†å‘å¸ƒç»™Capsuleã€‚å­˜å‚¨å’Œè·å–æŒ‡é’ˆä¹Ÿå¯ä»¥ç”¨å¤šç§æ–¹å¼ï¼Œä¾›å®¢æˆ·ç«¯æ¨¡å—ä½¿ç”¨ã€‚</p>
<p>Whichever method you choose, it's important to name your Capsules properly.
The function <a class="reference internal" href="capsule.html#c.PyCapsule_New" tppabs="https://docs.python.org/zh-cn/3/c-api/capsule.html#c.PyCapsule_New" title="PyCapsule_New"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyCapsule_New()</span></code></a> takes a name parameter
(<code class="xref c c-type docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*</span></code>); you're permitted to pass in a <code class="docutils literal notranslate"><span class="pre">NULL</span></code> name, but
we strongly encourage you to specify a name.  Properly named Capsules provide
a degree of runtime type-safety; there is no feasible way to tell one unnamed
Capsule from another.</p>
<p>é€šå¸¸æ¥è¯´ï¼ŒCapsuleç”¨äºæš´éœ²C APIï¼Œå…¶åå­—åº”è¯¥éµå¾ªå¦‚ä¸‹è§„èŒƒï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">modulename</span><span class="p">.</span><span class="n">attributename</span>
</pre></div>
</div>
<p>ä¾¿åˆ©å‡½æ•° <a class="reference internal" href="capsule.html#c.PyCapsule_Import" tppabs="https://docs.python.org/zh-cn/3/c-api/capsule.html#c.PyCapsule_Import" title="PyCapsule_Import"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyCapsule_Import()</span></code></a> å¯ä»¥æ–¹ä¾¿çš„è½½å…¥é€šè¿‡Capsuleæä¾›çš„C APIï¼Œä»…åœ¨Capsuleçš„åå­—åŒ¹é…æ—¶ã€‚è¿™ä¸ªè¡Œä¸ºä¸ºC APIç”¨æˆ·æä¾›äº†é«˜åº¦çš„ç¡®å®šæ€§æ¥è½½å…¥æ­£ç¡®çš„C APIã€‚</p>
<p>å¦‚ä¸‹ä¾‹å­å±•ç¤ºäº†å°†å¤§éƒ¨åˆ†è´Ÿæ‹…äº¤ç”±å¯¼å‡ºæ¨¡å—ä½œè€…çš„æ–¹æ³•ï¼Œé€‚ç”¨äºå¸¸ç”¨çš„åº“æ¨¡å—ã€‚å…¶ä¼šå­˜å‚¨æ‰€æœ‰C APIæŒ‡é’ˆ(ä¾‹å­é‡Œåªæœ‰ä¸€ä¸ª)åœ¨ <code class="xref c c-type docutils literal notranslate"><span class="pre">void</span></code> æŒ‡é’ˆçš„æ•°ç»„é‡Œï¼Œå¹¶ä½¿å…¶å€¼å˜ä¸ºCapsuleã€‚å¯¹åº”çš„æ¨¡å—å¤´æ–‡ä»¶æä¾›äº†å®æ¥ç®¡ç†å¯¼å…¥æ¨¡å—å’Œè·å–C APIæŒ‡é’ˆï¼›å®¢æˆ·ç«¯æ¨¡å—åªéœ€è¦åœ¨è®¿é—®C APIå‰è°ƒç”¨è¿™ä¸ªå®å³å¯ã€‚</p>
<p>å¯¼å‡ºçš„æ¨¡å—ä¿®æ”¹è‡ª <code class="xref py py-mod docutils literal notranslate"><span class="pre">spam</span></code> æ¨¡å—ï¼Œæ¥è‡ª <a class="reference internal" href="#extending-simpleexample"><span class="std std-ref">ä¸€ä¸ªç®€å•çš„ä¾‹å­</span></a> æ®µè½ã€‚å‡½æ•° <code class="xref py py-func docutils literal notranslate"><span class="pre">spam.system()</span></code> ä¸ä¼šç›´æ¥è°ƒç”¨Cåº“å‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">system()</span></code> ï¼Œä½†ä¸€ä¸ªå‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">PySpam_System()</span></code> ä¼šè´Ÿè´£è°ƒç”¨ï¼Œå½“ç„¶ç°å®ä¸­ä¼šæ›´å¤æ‚äº›(ä¾‹å¦‚æ·»åŠ  &quot;spam&quot; åˆ°æ¯ä¸ªå‘½ä»¤)ã€‚å‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">PySpam_System()</span></code> ä¹Ÿä¼šå¯¼å‡ºç»™å…¶ä»–æ‰©å±•æ¨¡å—ã€‚</p>
<p>å‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">PySpam_System()</span></code> æ˜¯ä¸ªçº¯Cå‡½æ•°ï¼Œå£°æ˜ <code class="docutils literal notranslate"><span class="pre">static</span></code> å°±åƒå…¶ä»–åœ°æ–¹é‚£æ ·:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span>
<span class="nf">PySpam_System</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>å‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">spam_system()</span></code> æŒ‰ç…§å¦‚ä¸‹æ–¹å¼ä¿®æ”¹:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">spam_system</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sts</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">sts</span> <span class="o">=</span> <span class="n">PySpam_System</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="n">sts</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>åœ¨æ¨¡å—å¼€å¤´ï¼Œåœ¨æ­¤è¡Œå:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<p>æ·»åŠ å¦å¤–ä¸¤è¡Œ:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define SPAM_MODULE</span>
<span class="cp">#include</span> <span class="cpf">&quot;spammodule.h&quot;</span><span class="cp"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">#define</span></code> ç”¨äºå‘ŠçŸ¥å¤´æ–‡ä»¶éœ€è¦åŒ…å«ç»™å¯¼å‡ºçš„æ¨¡å—ï¼Œè€Œä¸æ˜¯å®¢æˆ·ç«¯æ¨¡å—ã€‚æœ€ç»ˆï¼Œæ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°å¿…é¡»è´Ÿè´£åˆå§‹åŒ–C APIæŒ‡é’ˆæ•°ç»„:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_spam</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">PySpam_API</span><span class="p">[</span><span class="n">PySpam_API_pointers</span><span class="p">];</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">c_api_object</span><span class="p">;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spammodule</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* Initialize the C API pointer array */</span>
    <span class="n">PySpam_API</span><span class="p">[</span><span class="n">PySpam_System_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">PySpam_System</span><span class="p">;</span>

    <span class="cm">/* Create a Capsule containing the API pointer array&#39;s address */</span>
    <span class="n">c_api_object</span> <span class="o">=</span> <span class="n">PyCapsule_New</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">PySpam_API</span><span class="p">,</span> <span class="s">&quot;spam._C_API&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;_C_API&quot;</span><span class="p">,</span> <span class="n">c_api_object</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">c_api_object</span><span class="p">);</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>æ³¨æ„ <code class="docutils literal notranslate"><span class="pre">PySpam_API</span></code> å£°æ˜ä¸º <code class="docutils literal notranslate"><span class="pre">static</span></code> ï¼›æ­¤å¤–æŒ‡é’ˆæ•°ç»„ä¼šåœ¨ <code class="xref py py-func docutils literal notranslate"><span class="pre">PyInit_spam()</span></code> ç»“æŸåæ¶ˆå¤±!</p>
<p>å¤´æ–‡ä»¶ <code class="file docutils literal notranslate"><span class="pre">spammodule.h</span></code> é‡Œçš„ä¸€å †å·¥ä½œï¼Œçœ‹èµ·æ¥å¦‚ä¸‹æ‰€ç¤º:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef Py_SPAMMODULE_H</span>
<span class="cp">#define Py_SPAMMODULE_H</span>
<span class="cp">#ifdef __cplusplus</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="p">{</span>
<span class="cp">#endif</span>

<span class="cm">/* Header file for spammodule */</span>

<span class="cm">/* C API functions */</span>
<span class="cp">#define PySpam_System_NUM 0</span>
<span class="cp">#define PySpam_System_RETURN int</span>
<span class="cp">#define PySpam_System_PROTO (const char *command)</span>

<span class="cm">/* Total number of C API pointers */</span>
<span class="cp">#define PySpam_API_pointers 1</span>


<span class="cp">#ifdef SPAM_MODULE</span>
<span class="cm">/* This section is used when compiling spammodule.c */</span>

<span class="k">static</span> <span class="n">PySpam_System_RETURN</span> <span class="n">PySpam_System</span> <span class="n">PySpam_System_PROTO</span><span class="p">;</span>

<span class="cp">#else</span>
<span class="cm">/* This section is used in modules that use spammodule&#39;s API */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">**</span><span class="n">PySpam_API</span><span class="p">;</span>

<span class="cp">#define PySpam_System \</span>
<span class="cp"> (*(PySpam_System_RETURN (*)PySpam_System_PROTO) PySpam_API[PySpam_System_NUM])</span>

<span class="cm">/* Return -1 on error, 0 on success.</span>
<span class="cm"> * PyCapsule_Import will set an exception if there&#39;s an error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">import_spam</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PySpam_API</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">PyCapsule_Import</span><span class="p">(</span><span class="s">&quot;spam._C_API&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">PySpam_API</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef __cplusplus</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* !defined(Py_SPAMMODULE_H) */</span><span class="cp"></span>
</pre></div>
</div>
<p>å®¢æˆ·ç«¯æ¨¡å—å¿…é¡»åœ¨å…¶åˆå§‹åŒ–å‡½æ•°é‡ŒæŒ‰é¡ºåºè°ƒç”¨å‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">import_spam()</span></code> (æˆ–å…¶ä»–å®)æ‰èƒ½è®¿é—®å‡½æ•° <code class="xref c c-func docutils literal notranslate"><span class="pre">PySpam_System()</span></code> ã€‚</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_client</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clientmodule</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">import_spam</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="cm">/* additional initialization can happen here */</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>è¿™ç§æ–¹æ³•çš„ä¸»è¦ç¼ºç‚¹æ˜¯ï¼Œæ–‡ä»¶ <code class="file docutils literal notranslate"><span class="pre">spammodule.h</span></code> è¿‡äºå¤æ‚ã€‚å½“ç„¶ï¼Œå¯¹æ¯ä¸ªè¦å¯¼å‡ºçš„å‡½æ•°ï¼ŒåŸºæœ¬ç»“æ„æ˜¯ç›¸ä¼¼çš„ï¼Œæ‰€ä»¥åªéœ€è¦å­¦ä¹ ä¸€æ¬¡ã€‚</p>
<p>æœ€åéœ€è¦æé†’çš„æ˜¯Capsuleæä¾›äº†é¢å¤–çš„åŠŸèƒ½ï¼Œç”¨äºå­˜å‚¨åœ¨Capsuleé‡Œçš„æŒ‡é’ˆçš„å†…å­˜åˆ†é…å’Œé‡Šæ”¾ã€‚ç»†èŠ‚å‚è€ƒ Python/C APIå‚è€ƒæ‰‹å†Œçš„ç« èŠ‚ <a class="reference internal" href="capsule.html#capsules" tppabs="https://docs.python.org/zh-cn/3/c-api/capsule.html#capsules"><span class="std std-ref">èƒ¶å›Š</span></a> å’ŒCapsuleçš„å®ç°(åœ¨Pythonæºç å‘è¡ŒåŒ…çš„ <code class="file docutils literal notranslate"><span class="pre">Include/pycapsule.h</span></code> å’Œ <code class="file docutils literal notranslate"><span class="pre">Objects/pycapsule.c</span></code> )ã€‚</p>
<p class="rubric">è„šæ³¨</p>
<dl class="footnote brackets">
<dt class="label" id="id5"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>è¿™ä¸ªå‡½æ•°çš„æ¥å£å·²ç»åœ¨æ ‡å‡†æ¨¡å— <a class="reference internal" href="os.html#module-os" tppabs="https://docs.python.org/zh-cn/3/library/os.html#module-os" title="os: Miscellaneous operating system interfaces."><code class="xref py py-mod docutils literal notranslate"><span class="pre">os</span></code></a> é‡Œäº†ï¼Œè¿™é‡Œä½œä¸ºä¸€ä¸ªç®€å•è€Œç›´æ¥çš„ä¾‹å­ã€‚</p>
</dd>
<dt class="label" id="id6"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>æœ¯è¯­&quot;å€Ÿç”¨&quot;ä¸€ä¸ªå¼•ç”¨æ˜¯ä¸å®Œå…¨æ­£ç¡®çš„ï¼šæ‹¥æœ‰è€…ä»ç„¶æœ‰å¼•ç”¨çš„æ‹·è´ã€‚</p>
</dd>
<dt class="label" id="id7"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p>æ£€æŸ¥å¼•ç”¨è®¡æ•°è‡³å°‘ä¸º1 <strong>æ²¡æœ‰ç”¨</strong> ï¼Œå¼•ç”¨è®¡æ•°æœ¬èº«å¯ä»¥åœ¨å·²ç»é‡Šæ”¾çš„å†…å­˜é‡Œï¼Œå¹¶æœ‰å¯èƒ½è¢«å…¶ä»–å¯¹è±¡æ‰€ç”¨ã€‚</p>
</dd>
<dt class="label" id="id8"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p>å½“ä½ ä½¿ç”¨ &quot;æ—§å¼&quot; é£æ ¼è°ƒç”¨çº¦å®šæ—¶ï¼Œè¿™äº›ä¿è¯ä¸æˆç«‹ï¼Œå°½ç®¡è¿™ä¾æ—§å­˜åœ¨äºå¾ˆå¤šæ—§ä»£ç ä¸­ã€‚</p>
</dd>
</dl>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="contents.html" tppabs="https://docs.python.org/zh-cn/3/contents.html">ç›®å½•</a></h3>
  <ul>
<li><a class="reference internal" href="#">1. ä½¿ç”¨ C æˆ– C++ æ‰©å±• Python</a><ul>
<li><a class="reference internal" href="#a-simple-example">1.1. ä¸€ä¸ªç®€å•çš„ä¾‹å­</a></li>
<li><a class="reference internal" href="#intermezzo-errors-and-exceptions">1.2. å…³äºé”™è¯¯å’Œå¼‚å¸¸</a></li>
<li><a class="reference internal" href="#back-to-the-example">1.3. å›åˆ°ä¾‹å­</a></li>
<li><a class="reference internal" href="#the-module-s-method-table-and-initialization-function">1.4. æ¨¡å—æ–¹æ³•è¡¨å’Œåˆå§‹åŒ–å‡½æ•°</a></li>
<li><a class="reference internal" href="#compilation-and-linkage">1.5. ç¼–è¯‘å’Œé“¾æ¥</a></li>
<li><a class="reference internal" href="#calling-python-functions-from-c">1.6. åœ¨Cä¸­è°ƒç”¨Pythonå‡½æ•°</a></li>
<li><a class="reference internal" href="#extracting-parameters-in-extension-functions">1.7. æå–æ‰©å±•å‡½æ•°çš„å‚æ•°</a></li>
<li><a class="reference internal" href="#keyword-parameters-for-extension-functions">1.8. ç»™æ‰©å±•å‡½æ•°çš„å…³é”®å­—å‚æ•°</a></li>
<li><a class="reference internal" href="#building-arbitrary-values">1.9. æ„é€ ä»»æ„å€¼</a></li>
<li><a class="reference internal" href="#reference-counts">1.10. å¼•ç”¨è®¡æ•°</a><ul>
<li><a class="reference internal" href="#reference-counting-in-python">1.10.1. Pythonä¸­çš„å¼•ç”¨è®¡æ•°</a></li>
<li><a class="reference internal" href="#ownership-rules">1.10.2. æ‹¥æœ‰è§„åˆ™</a></li>
<li><a class="reference internal" href="#thin-ice">1.10.3. å±é™©çš„è–„å†°</a></li>
<li><a class="reference internal" href="#null-pointers">1.10.4. NULLæŒ‡é’ˆ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#writing-extensions-in-c">1.11. åœ¨C++ä¸­ç¼–å†™æ‰©å±•</a></li>
<li><a class="reference internal" href="#providing-a-c-api-for-an-extension-module">1.12. ç»™æ‰©å±•æ¨¡å—æä¾›C API</a></li>
</ul>
</li>
</ul>

  <h4>ä¸Šä¸€ä¸ªä¸»é¢˜</h4>
  <p class="topless"><a href="index-8.html" tppabs="https://docs.python.org/zh-cn/3/extending/index.html"
                        title="ä¸Šä¸€ç« ">æ‰©å±•å’ŒåµŒå…¥ Python è§£é‡Šå™¨</a></p>
  <h4>ä¸‹ä¸€ä¸ªä¸»é¢˜</h4>
  <p class="topless"><a href="newtypes_tutorial.html" tppabs="https://docs.python.org/zh-cn/3/extending/newtypes_tutorial.html"
                        title="ä¸‹ä¸€ç« "><span class="section-number">2. </span>è‡ªå®šä¹‰æ‰©å±•ç±»å‹ï¼šæ•™ç¨‹</a></p>
  <div role="note" aria-label="source link">
    <h3>æœ¬é¡µ</h3>
    <ul class="this-page-menu">
      <li><a href="bugs.html" tppabs="https://docs.python.org/zh-cn/3/bugs.html">æäº¤ Bug</a></li>
      <li>
        <a href="javascript:if(confirm('https://github.com/python/cpython/blob/3.8/Doc/extending/extending.rst  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/python/cpython/blob/3.8/Doc/extending/extending.rst'" tppabs="https://github.com/python/cpython/blob/3.8/Doc/extending/extending.rst"
            rel="nofollow">æ˜¾ç¤ºæºä»£ç 
        </a>
      </li>
    </ul>
  </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>  
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>å¯¼èˆª</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" tppabs="https://docs.python.org/zh-cn/3/genindex.html" title="æ€»ç›®å½•"
             >ç´¢å¼•</a></li>
        <li class="right" >
          <a href="py-modindex.html" tppabs="https://docs.python.org/zh-cn/3/py-modindex.html" title="Python æ¨¡å—ç´¢å¼•"
             >æ¨¡å—</a> |</li>
        <li class="right" >
          <a href="newtypes_tutorial.html" tppabs="https://docs.python.org/zh-cn/3/extending/newtypes_tutorial.html" title="2. è‡ªå®šä¹‰æ‰©å±•ç±»å‹ï¼šæ•™ç¨‹"
             >ä¸‹ä¸€é¡µ</a> |</li>
        <li class="right" >
          <a href="index-8.html" tppabs="https://docs.python.org/zh-cn/3/extending/index.html" title="æ‰©å±•å’ŒåµŒå…¥ Python è§£é‡Šå™¨"
             >ä¸Šä¸€é¡µ</a> |</li>

    <li><img src="py.png" tppabs="https://docs.python.org/zh-cn/3/_static/py.png" alt=""
             style="vertical-align: middle; margin-top: -1px"/></li>
    <li><a href="javascript:if(confirm('https://www.python.org/  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://www.python.org/'" tppabs="https://www.python.org/">Python</a> &#187;</li>
    

    <li>
      <span class="language_switcher_placeholder">zh_CN</span>
      <span class="version_switcher_placeholder">3.8.2</span>
      <a href="index-11.html" tppabs="https://docs.python.org/zh-cn/3/index.html">æ–‡æ¡£</a> &#187;
    </li>

          <li class="nav-item nav-item-1"><a href="index-8.html" tppabs="https://docs.python.org/zh-cn/3/extending/index.html" >æ‰©å±•å’ŒåµŒå…¥ Python è§£é‡Šå™¨</a> &#187;</li>
    <li class="right">
        

    <div class="inline-search" style="display: none" role="search">
        <form class="inline-search" action="https://docs.python.org/zh-cn/3/search.html" method="get">
          <input placeholder="å¿«é€Ÿæœç´¢" type="text" name="q" />
          <input type="submit" value="è½¬å‘" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </form>
    </div>
    <script type="text/javascript">$('.inline-search').show(0);</script>
         |
    </li>

      </ul>
    </div>  
    <div class="footer">
    &copy; <a href="copyright.html" tppabs="https://docs.python.org/zh-cn/3/copyright.html">ç‰ˆæƒæ‰€æœ‰</a> 2001-2020, Python Software Foundation.
    <br />

    The Python Software Foundation is a non-profit corporation.
<a href="javascript:if(confirm('https://www.python.org/psf/donations/  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://www.python.org/psf/donations/'" tppabs="https://www.python.org/psf/donations/">Please donate.</a>
<br />
    <br />

    æœ€åæ›´æ–°äº 3æœˆ 26, 2020.
    <a href="javascript:if(confirm('https://docs.python.org/3/bugs.html  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://docs.python.org/3/bugs.html'" tppabs="https://docs.python.org/3/bugs.html">Found a bug</a>?
    <br />

    Created using <a href="javascript:if(confirm('https://www.sphinx-doc.org/  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://www.sphinx-doc.org/'" tppabs="https://www.sphinx-doc.org/">Sphinx</a> 2.3.1.
    </div>

  </body>
</html>